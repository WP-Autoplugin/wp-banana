(()=>{"use strict";var e={n:n=>{var t=n&&n.__esModule?()=>n.default:()=>n;return e.d(t,{a:t}),t},d:(n,t)=>{for(var a in t)e.o(t,a)&&!e.o(n,a)&&Object.defineProperty(n,a,{enumerable:!0,get:t[a]})},o:(e,n)=>Object.prototype.hasOwnProperty.call(e,n)};const n=window.wp.element,t=window.wp.i18n,a=window.wp.apiFetch;var r=e.n(a);const s=window.wp.components,i=window.ReactJSXRuntime,o=({prompt:e,onPromptChange:n,onPromptKeyDown:a,isSubmitting:r,canSubmit:o,onSubmit:l,onReferenceClick:d,showOptions:c,onToggleOptions:p,summary:u,variationMenuRef:m,onVariationToggle:f,isVariationMenuOpen:g,variationMenu:v,enableReferenceDragDrop:b=!1,dropOverlayVisible:w=!1,promptLabel:h,promptPlaceholder:x,submitLabel:y,submitTooltip:_,referenceTray:R})=>{const j=Boolean(m&&f&&"boolean"==typeof g),C=null!=h?h:(0,t.__)("Describe the image","wp-banana"),S=null!=x?x:(0,t.__)("A cat surfing a wave at sunset…","wp-banana"),k=null!=y?y:(0,t.__)("Generate Image","wp-banana"),A=null!=_?_:(0,t.__)("Generate one image and save to Media Library","wp-banana");return(0,i.jsxs)(i.Fragment,{children:[b&&(0,i.jsx)("div",{className:"uploader-window wp-banana-generate-page__drop-overlay",style:{display:w?"block":"none",opacity:w?1:0},"aria-hidden":"true",children:(0,i.jsx)("div",{className:"uploader-window-content",children:(0,i.jsx)("div",{className:"uploader-editor-title",children:(0,t.__)("Drop files to attach","wp-banana")})})}),(0,i.jsxs)("div",{className:"wp-banana-generate-panel__prompt",style:{position:"relative",marginBottom:"8px"},children:[(0,i.jsx)(s.TextareaControl,{label:C,value:e,onChange:n,onKeyDown:a,rows:5,placeholder:S,disabled:r}),(0,i.jsx)("button",{type:"button",className:"button button-secondary button-small wp-banana-generate-panel__reference-picker",onClick:d,disabled:r,"aria-label":(0,t.__)("Add reference images","wp-banana"),style:{position:"absolute",top:"24px",right:"0",lineHeight:"20px",padding:"0 4px",border:"none",borderRadius:0,background:"transparent"},children:(0,i.jsx)("span",{className:"dashicons dashicons-paperclip","aria-hidden":"true"})})]}),R,(0,i.jsxs)("div",{className:"wp-banana-generate-panel__actions",style:{marginTop:"16px",display:"flex",flexWrap:"wrap",alignItems:"center",gap:"12px",justifyContent:"space-between"},children:[(0,i.jsxs)("div",{ref:j&&null!=m?m:null,style:{display:"flex",alignItems:"center",gap:"12px",position:"relative",zIndex:1e3},children:[(0,i.jsxs)("div",{className:"button-group",children:[(0,i.jsx)("button",{type:"button",className:"button button-primary wp-banana-generate-panel__submit",onClick:l,disabled:!o||r,title:A,children:k}),j&&(0,i.jsx)("button",{type:"button",className:"button button-primary",onClick:f,disabled:r||!o,"aria-haspopup":"menu","aria-expanded":g,"aria-label":(0,t.__)("Generate multiple variations","wp-banana"),style:{padding:"0 4px"},title:(0,t.__)("Generate multiple variations and preview before saving","wp-banana"),children:(0,i.jsx)("span",{className:"dashicons dashicons-arrow-down-alt2","aria-hidden":"true",style:{lineHeight:"30px"}})})]}),r&&(0,i.jsx)("span",{className:"spinner is-active","aria-hidden":"true"}),j&&v]}),(0,i.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"8px",flexWrap:"wrap",textAlign:"right"},children:[u.fallback?(0,i.jsx)("span",{children:u.fallback}):(0,i.jsxs)("span",{children:[u.aspect&&(0,i.jsxs)("span",{children:[u.aspect," — "]}),(0,i.jsx)("code",{children:u.model}),u.provider&&(0,i.jsxs)("span",{children:[" (",u.provider,")"]}),u.references&&(0,i.jsxs)("span",{children:[" - ",u.references]})]}),(0,i.jsx)("button",{type:"button",className:"button-link",onClick:p,children:c?(0,t.__)("Hide options","wp-banana"):(0,t.__)("Change","wp-banana")})]})]})]})},l=({show:e,connectedProviders:n,provider:a,onProviderChange:r,model:o,onModelChange:l,modelOptions:d,modelsLoading:c,aspectRatioEnabled:p,aspectRatio:u,onAspectRatioChange:m,aspectOptions:f,resolutionEnabled:g,resolution:v,onResolutionChange:b,resolutionOptions:w,isSubmitting:h,children:x})=>e?(0,i.jsxs)("div",{className:"wp-banana-generate-panel__options",style:{marginTop:"16px"},children:[x,n.length>1&&(0,i.jsx)(s.SelectControl,{label:(0,t.__)("Provider","wp-banana"),value:a,onChange:r,options:n.map(e=>({label:e.label,value:e.slug})),disabled:h}),(0,i.jsx)(s.SelectControl,{label:(0,t.__)("Model","wp-banana"),value:o,onChange:l,disabled:c||0===d.length||h,options:d.length>0?d.map(e=>({label:e,value:e})):[{label:(0,t.__)("No models available","wp-banana"),value:""}]}),p&&(0,i.jsx)(s.SelectControl,{label:(0,t.__)("Aspect ratio","wp-banana"),value:u,onChange:m,disabled:h,options:f.map(e=>({label:e,value:e}))}),g&&(0,i.jsx)(s.SelectControl,{label:(0,t.__)("Resolution","wp-banana"),value:v,onChange:b,disabled:h,options:w.map(e=>({label:e,value:e}))}),c&&(0,i.jsxs)("div",{className:"wp-banana-generate-panel__spinner",style:{display:"flex",alignItems:"center",gap:"8px"},children:[(0,i.jsx)(s.Spinner,{})," ",(0,t.__)("Loading models…","wp-banana")]})]}):(0,i.jsxs)(i.Fragment,{children:[x,c&&(0,i.jsxs)("div",{className:"wp-banana-generate-panel__spinner",style:{display:"flex",alignItems:"center",gap:"8px"},children:[(0,i.jsx)(s.Spinner,{})," ",(0,t.__)("Loading models…","wp-banana")]})]}),d=({referenceImages:e,onRemove:n,fileInputRef:a,onReferenceSelection:r})=>(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)("input",{ref:a,type:"file",accept:"image/png,image/jpeg,image/webp",multiple:!0,onChange:r,style:{display:"none"}}),e.length>0&&(0,i.jsx)("div",{className:"wp-banana-generate-panel__reference-list",style:{display:"flex",gap:"8px",marginBottom:"16px",flexWrap:"wrap"},children:e.map(e=>(0,i.jsxs)("div",{style:{position:"relative",width:"72px",height:"72px",overflow:"hidden",borderRadius:"4px",border:"1px solid #dcdcde"},children:[(0,i.jsx)("img",{src:e.url,alt:"",style:{width:"100%",height:"100%",objectFit:"cover"}}),(0,i.jsx)("button",{type:"button",className:"button-link wp-banana-generate-panel__reference-remove",onClick:()=>n(e.id),"aria-label":(0,t.__)("Remove reference image","wp-banana"),style:{position:"absolute",top:"2px",right:"2px",display:"inline-flex",alignItems:"center",justifyContent:"center",width:"22px",height:"22px",background:"rgba(0,0,0,0.55)",color:"#fff",borderRadius:"3px",textDecoration:"none"},children:(0,i.jsx)("span",{className:"dashicons dashicons-no"})})]},e.id))})]}),c=({isOpen:e,options:n,onSelect:a})=>e?(0,i.jsxs)("div",{className:"wp-banana-generate-panel__variation-menu",role:"menu",style:{position:"absolute",top:"100%",right:0,marginTop:"4px",background:"#fff",border:"1px solid #dcdcde",borderRadius:"4px",boxShadow:"0 4px 12px rgba(0,0,0,0.15)",zIndex:10,minWidth:"180px",padding:"4px 0"},children:[n.map(e=>(0,i.jsxs)("button",{type:"button",role:"menuitem",className:"button button-link",style:{display:"flex",width:"100%",justifyContent:"space-between",alignItems:"center",padding:"6px 12px",boxSizing:"border-box",textDecoration:"none"},onClick:()=>a(e),children:[(0,i.jsx)("span",{children:(0,t.sprintf)((0,t._n)("%d image","%d images",e,"wp-banana"),e)}),1===e&&(0,i.jsx)("span",{className:"dashicons dashicons-format-image","aria-hidden":"true"}),e>1&&(0,i.jsx)("span",{className:"dashicons dashicons-images-alt2","aria-hidden":"true"})]},e)),(0,i.jsx)("span",{style:{display:"block",padding:"4px 12px 2px",fontSize:"11px",fontWeight:"400",color:"#555d66",borderTop:"1px solid #e1e1e1"},children:(0,t.__)("Generate and Preview Images","wp-banana")})]}):null,p=[1,2,3,4],u=(()=>{var e,n;const t=window;return null!==(e=null!==(n=t.wpBananaMedia?.multiImageModelAllowlist)&&void 0!==n?n:t.wpBananaGeneratePage?.multiImageModelAllowlist)&&void 0!==e?e:{}})(),m=((e,n)=>{const t=window;return null!==(e=null!==(n=t.wpBananaMedia?.resolutionModelAllowlist)&&void 0!==n?n:t.wpBananaGeneratePage?.resolutionModelAllowlist)&&void 0!==e?e:{}})(),f={"image/jpeg":"jpg","image/jpg":"jpg","image/png":"png","image/webp":"webp"},g=(e,n,t)=>{var a;const r=`reference-${n}`,s=e&&e.trim().length>0?e.trim():r,i=null!==(a=f[t.toLowerCase()])&&void 0!==a?a:"";if(""===i)return s;if(s.toLowerCase().endsWith(`.${i}`))return s;const o=s.lastIndexOf(".");return o>0?`${s.slice(0,o)}.${i}`:`${s}.${i}`},v=e=>{if(!e)return"png";const n=f[e.toLowerCase()];return null!=n?n:"png"},b=e=>{switch(e){case"queued":case"loading":return(0,t.__)("Generating…","wp-banana");case"complete":return(0,t.__)("Ready","wp-banana");case"saving":return(0,t.__)("Saving…","wp-banana");case"saved":return(0,t.__)("Saved","wp-banana");case"error":return(0,t.__)("Failed","wp-banana");default:return""}},w=({previewItems:e,selectedPreview:n,selectedPreviewSrc:a,onSelect:r,previewAction:o,onUndo:l,onClear:d,canSaveSelected:c,canDiscardSelected:p,onSave:u,onDiscard:m})=>{var f;return 0===e.length?null:(0,i.jsxs)("div",{className:"wp-banana-generate-panel__variations",style:{marginTop:"24px",borderTop:"1px solid #dcdcde",paddingTop:"16px"},children:[(0,i.jsxs)("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:"12px",gap:"12px"},children:[(0,i.jsx)("h3",{style:{margin:0},children:(0,t.__)("Generated Variations","wp-banana")}),(0,i.jsx)("button",{type:"button",className:"button",onClick:d,children:(0,t.__)("Clear previews","wp-banana")})]}),o&&"success"!==o.type&&(0,i.jsx)(s.Notice,{status:"warning"===o.type?"warning":"error",isDismissible:!1,style:{marginBottom:"16px"},children:(0,i.jsxs)("div",{className:"wp-banana-generate-variations-notice",style:{display:"flex",alignItems:"center",gap:"8px",flexWrap:"wrap"},children:[(0,i.jsx)("span",{children:o.message}),o.undo?(0,i.jsx)("button",{type:"button",className:"button-link",onClick:l,children:(0,t.__)("Undo","wp-banana")}):null]})}),(0,i.jsxs)("div",{className:"wp-banana-generate-variations-layout",style:{display:"flex",gap:"16px",flexWrap:"wrap"},children:[(0,i.jsx)("div",{className:"wp-banana-generate-variations-list",style:{width:"200px",maxHeight:"440px",overflowY:"auto",display:"flex",flexDirection:"column",gap:"8px"},children:e.map(e=>{const a=e.id===n?.id,o=e.data&&e.mime?`data:${e.mime};base64,${e.data}`:"";return(0,i.jsxs)("button",{type:"button",onClick:()=>r(e.id),className:"button button-link",style:{display:"flex",flexDirection:"column",alignItems:"stretch",gap:"6px",padding:"6px",border:a?"2px solid #007cba":"1px solid #dcdcde",borderRadius:"4px",background:a?"#f0f6fc":"#fff",textAlign:"left",textDecoration:"none",boxShadow:"none"},children:[(0,i.jsxs)("div",{style:{position:"relative",height:"64px",background:"#f6f7f7",display:"flex",alignItems:"center",justifyContent:"center",overflow:"hidden",borderRadius:"3px"},children:["complete"===e.status||"saved"===e.status||"error"===e.status?o?(0,i.jsx)("img",{src:o,alt:"",style:{width:"100%",height:"100%",objectFit:"cover"}}):(0,i.jsx)("span",{children:(0,t.__)("Preview unavailable","wp-banana")}):(0,i.jsx)(s.Spinner,{}),"saved"===e.status&&(0,i.jsx)("span",{style:{position:"absolute",top:"4px",right:"4px",background:"#007cba",color:"#fff",padding:"2px 6px",borderRadius:"3px",fontSize:"11px",fontWeight:600},children:(0,t.__)("Saved","wp-banana")})]}),(0,i.jsxs)("div",{style:{display:"flex",flexDirection:"column",gap:"2px"},children:[(0,i.jsx)("strong",{children:(0,t.sprintf)((0,t.__)("Variation %d","wp-banana"),e.index+1)}),(0,i.jsx)("span",{style:{fontSize:"12px",color:"#555"},children:b(e.status)})]})]},e.id)})}),(0,i.jsxs)("div",{className:"wp-banana-generate-variations-preview",style:{flex:1,minWidth:"260px",display:"flex",flexDirection:"column",gap:"16px"},children:[(0,i.jsx)("div",{style:{position:"relative",background:"#f6f7f7",border:"1px solid #dcdcde",borderRadius:"4px",minHeight:"300px",display:"flex",alignItems:"center",justifyContent:"center",padding:"12px"},children:n?"loading"===n.status||"queued"===n.status?(0,i.jsx)(s.Spinner,{}):"error"===n.status?(0,i.jsx)(s.Notice,{status:"error",isDismissible:!1,children:null!==(f=n.error)&&void 0!==f?f:(0,t.__)("Failed to generate image.","wp-banana")}):(0,i.jsxs)(i.Fragment,{children:[a?(0,i.jsx)("img",{src:a,alt:"",style:{maxWidth:"100%",maxHeight:"500px",borderRadius:"4px",objectFit:"contain"}}):(0,i.jsx)("span",{children:(0,t.__)("Preview unavailable","wp-banana")}),"saving"===n.status&&(0,i.jsxs)("div",{style:{position:"absolute",inset:0,background:"rgba(255,255,255,0.7)",display:"flex",alignItems:"center",justifyContent:"center",gap:"8px"},children:[(0,i.jsx)(s.Spinner,{})," ",(0,t.__)("Saving…","wp-banana")]})]}):(0,i.jsx)("span",{children:(0,t.__)("No preview selected.","wp-banana")})}),(0,i.jsxs)("div",{style:{display:"flex",gap:"8px"},children:[(0,i.jsx)("button",{type:"button",className:"button button-primary",onClick:n?()=>u(n.id):void 0,disabled:!c||"saving"===n?.status,children:(0,t.__)("Save","wp-banana")}),(0,i.jsx)("button",{type:"button",className:"button",onClick:n?()=>m(n.id):void 0,disabled:!p||"saving"===n?.status,children:(0,t.__)("Discard","wp-banana")})]})]})]})]})},h=({providers:e,restNamespace:a,onComplete:f,defaultGeneratorModel:b,defaultGeneratorProvider:h,aspectRatioOptions:x,defaultAspectRatio:y,resolutionOptions:_,defaultResolution:R,enableReferenceDragDrop:j=!1})=>{const[C,S]=(0,n.useState)(""),[k,A]=(0,n.useState)(null),[P,E]=(0,n.useState)(!1),[O,M]=(0,n.useState)(!1),[D,N]=(0,n.useState)(!1),I=(0,n.useCallback)(()=>{A(null)},[]),{fileInputRef:L,referenceImages:G,referenceError:U,setReferenceError:T,referenceCount:F,removeReference:$,handleReferenceSelection:B,triggerReferenceDialog:V,resetReferenceImages:W,prepareReferenceFiles:q,dropOverlayVisible:H}=(({limit:e=4,enableReferenceDragDrop:a=!1,onReferencesChange:r,allowSelection:s})=>{const[i,o]=(0,n.useState)([]),[l,d]=(0,n.useState)(null),[c,p]=(0,n.useState)(!1),u=(0,n.useRef)([]),m=(0,n.useRef)(null),f=(0,n.useRef)(0),v=!1!==s,b=(0,n.useCallback)(e=>{u.current=e,o(e),r&&r()},[r]);(0,n.useEffect)(()=>{u.current=i},[i]),(0,n.useEffect)(()=>()=>{u.current.forEach(e=>{e.revokeOnCleanup&&e.url&&window.URL.revokeObjectURL(e.url)})},[]);const w=(0,n.useCallback)(()=>{u.current.forEach(e=>{e.revokeOnCleanup&&e.url&&window.URL.revokeObjectURL(e.url)}),b([]),d(null)},[b]),h=(0,n.useCallback)(()=>{v&&m.current&&m.current.click()},[v]),x=(0,n.useCallback)(n=>{if(!Array.isArray(n)||0===n.length)return;const a=Array.isArray(u.current)?u.current:[];let r=Math.max(0,e-a.length),s=0,i=0;const o=[];if(n.forEach(e=>{if(!e?.type||!e.type.startsWith("image/"))return;if(i+=1,r<=0)return;const n=`${Date.now()}-${Math.random().toString(36).slice(2)}`,t=window.URL.createObjectURL(e);o.push({id:n,file:e,url:t,revokeOnCleanup:!0,filename:e.name,mimeType:e.type}),r-=1,s+=1}),s>0){const e=[...a,...o];b(e),d(i>s?(0,t.__)("You can upload up to 4 reference images.","wp-banana"):null)}else i>0&&d((0,t.__)("You can upload up to 4 reference images.","wp-banana"))},[b,e]),y=(0,n.useCallback)(e=>{if(!v)return void(e.target.value="");const n=e.target.files;n&&n.length>0&&x(Array.from(n)),e.target.value=""},[x,v]),_=(0,n.useCallback)(e=>{const n=i.filter(n=>n.id!==e||(n.revokeOnCleanup&&n.url&&window.URL.revokeObjectURL(n.url),!1));b(n),d(null)},[i,b]),R=(0,n.useCallback)(async()=>{const e=Array.isArray(u.current)?[...u.current]:[],n=[];let a=!1;for(let r=0;r<e.length;r+=1){const s=e[r];if(s.file instanceof File){n.push(s.file);continue}if(!s.sourceUrl)throw new Error((0,t.__)("Could not load the selected images.","wp-banana"));let i;try{i=await window.fetch(s.sourceUrl,{credentials:"same-origin"})}catch(e){throw new Error((0,t.__)("Could not load the selected images.","wp-banana"))}if(!i.ok)throw new Error((0,t.__)("Could not load the selected images.","wp-banana"));const o=await i.blob(),l=o.type||s.mimeType||"image/png",d=g(s.filename,r+1,l),c=new File([o],d,{type:l});e[r]={...s,file:c,mimeType:l},n.push(c),a=!0}return a&&b(e),u.current=e,n},[b]),j=(0,n.useCallback)(n=>{if(w(),!Array.isArray(n)||0===n.length)return;const a=[];n.slice(0,e).forEach(e=>{if(!e.sourceUrl||0===e.sourceUrl.length)return;const n=`${Date.now()}-${Math.random().toString(36).slice(2)}`,t=e.sourceUrl,r=e.previewUrl&&e.previewUrl.length>0?e.previewUrl:t;a.push({id:n,url:r,sourceUrl:t,filename:e.filename,mimeType:e.mime})}),b(a),n.length>e&&d((0,t.__)("Only the first 4 selected images were attached as references.","wp-banana"))},[b,e,w]);(0,n.useEffect)(()=>{const e=e=>{if(!e)return;const n=window,t=n.wpBananaReferenceQueue;if(!Array.isArray(t)||0===t.length)return;const a=t.indexOf(e);a>=0&&t.splice(a,1),0===t.length&&delete n.wpBananaReferenceQueue},n=n=>{const t=n,a=t.detail?.references;Array.isArray(a)&&0!==a.length?(e(a),j(a)):e(a)};return(()=>{const e=window,n=e.wpBananaReferenceQueue;if(Array.isArray(n)&&0!==n.length){for(;n.length>0;){const e=n.shift();Array.isArray(e)&&e.length>0&&j(e)}delete e.wpBananaReferenceQueue}})(),window.addEventListener("wp-banana:set-reference-images",n),()=>{window.removeEventListener("wp-banana:set-reference-images",n)}},[j]),(0,n.useEffect)(()=>{if(!a||!v)return;const e=e=>{const n=e.dataTransfer?.types;return!!n&&Array.from(n).includes("Files")},n=n=>{e(n)&&(n.preventDefault(),n.stopPropagation(),f.current+=1,p(!0))},t=n=>{e(n)&&(n.preventDefault(),n.stopPropagation(),n.dataTransfer&&(n.dataTransfer.dropEffect="copy"),p(!0))},r=()=>{f.current=0,p(!1)},s=n=>{e(n)&&(n.preventDefault(),n.stopPropagation(),f.current=Math.max(0,f.current-1),0===f.current&&p(!1))},i=n=>{if(!e(n))return;n.preventDefault(),n.stopPropagation();const t=n.dataTransfer,a=t?Array.from(t.files||[]):[];if(a.length>0&&x(a),t)try{t.clearData()}catch(e){}r()},o=n=>{e(n)&&r()};return window.addEventListener("dragenter",n),window.addEventListener("dragover",t),window.addEventListener("dragleave",s),window.addEventListener("drop",i),window.addEventListener("dragend",o),()=>{window.removeEventListener("dragenter",n),window.removeEventListener("dragover",t),window.removeEventListener("dragleave",s),window.removeEventListener("drop",i),window.removeEventListener("dragend",o),r()}},[x,a,v]);const C=(0,n.useMemo)(()=>a&&c,[a,c]);return{fileInputRef:m,referenceImages:i,referenceError:l,setReferenceError:d,referenceCount:i.length,addReferenceFiles:x,removeReference:_,handleReferenceSelection:y,triggerReferenceDialog:h,resetReferenceImages:w,prepareReferenceFiles:R,dropOverlayVisible:C,isDraggingFiles:c}})({enableReferenceDragDrop:j,onReferencesChange:I}),z=F>1,{provider:K,setProvider:Q,model:Y,setModel:J,modelOptions:X,modelsLoading:Z,loadError:ee,aspectRatio:ne,setAspectRatio:te,aspectRatioEnabled:ae,aspectOptions:re,resolution:se,setResolution:ie,resolutionEnabled:oe,resolutionOptions:le,connectedProviders:de,summary:ce,modelRequirementSatisfied:pe,preferredAspectRatio:ue,preferredResolution:me}=(({providers:e,restNamespace:a,defaultGeneratorModel:s,defaultGeneratorProvider:i,aspectRatioOptions:o,defaultAspectRatio:l,resolutionOptions:d,defaultResolution:c,referenceCount:p,multiReferenceMode:f,purposeOverride:g})=>{const v=(0,n.useMemo)(()=>e.filter(e=>!1!==e.connected),[e]),b=(0,n.useMemo)(()=>Array.isArray(o)?o.map(e=>"string"==typeof e?e.trim().toUpperCase():"").filter(e=>e.length>0):[],[o]),w=(0,n.useMemo)(()=>{var e;if("string"==typeof l){const e=l.trim().toUpperCase();if(e&&b.includes(e))return e}return null!==(e=b[0])&&void 0!==e?e:""},[b,l]),h=(0,n.useMemo)(()=>Array.isArray(d)?d.map(e=>"string"==typeof e?e.trim().toUpperCase():"").filter(e=>e.length>0):[],[d]),x=(0,n.useMemo)(()=>{var e;if("string"==typeof c){const e=c.trim().toUpperCase();if(e&&h.includes(e))return e}return null!==(e=h[0])&&void 0!==e?e:""},[h,c]),y=(0,n.useMemo)(()=>{var n,t;if(i){const e=v.find(e=>e.slug===i);if(e)return e.slug}if(s){const n=v.find(e=>e.default_model===s);if(n)return n.slug;const t=e.find(e=>e.default_model===s);if(t){const e=v.find(e=>e.slug===t.slug);if(e)return e.slug}}return null!==(n=null!==(t=v[0]?.slug)&&void 0!==t?t:e[0]?.slug)&&void 0!==n?n:""},[v,e,i,s]),[_,R]=(0,n.useState)(y),[j,C]=(0,n.useState)([]),[S,k]=(0,n.useState)(""),[A,P]=(0,n.useState)(!1),[E,O]=(0,n.useState)(null),[M,D]=(0,n.useState)(w),[N,I]=(0,n.useState)(x),L=(0,n.useMemo)(()=>{var e;if(!S||!_)return!1;const n=S.toLowerCase();return(null!==(e=m[_])&&void 0!==e?e:[]).map(e=>e.toLowerCase()).includes(n)},[S,_]);(0,n.useEffect)(()=>{var e;_&&v.some(e=>e.slug===_)||R(y||(null!==(e=v[0]?.slug)&&void 0!==e?e:""))},[y,_,v]),(0,n.useEffect)(()=>{p>0||0===b.length?""!==M&&D(""):b.includes(M)||w!==M&&D(w)},[b,M,w,p]),(0,n.useEffect)(()=>{p>0||0===h.length||!L?""!==N&&I(""):h.includes(N)||x!==N&&I(x)},[h,N,x,p,L]),(0,n.useEffect)(()=>{if(!_)return void C([]);const e=null!=g?g:p>0?"edit":"generate";let n=!0;return P(!0),O(null),r()({path:`${a}/models?provider=${_}&purpose=${e}`}).then(e=>{if(!n)return;const t=e,a=Array.isArray(t?.models)?t.models:[];C(a),0!==a.length?s&&a.includes(s)?k(s):a.includes(S)||k(a[0]):k("")}).catch(e=>{var a;if(!n)return;const r=null!==(a=e?.message)&&void 0!==a?a:(0,t.__)("Failed to load models.","wp-banana");C([]),O(r),k("")}).finally(()=>{n&&P(!1)}),()=>{n=!1}},[_,a,s,p,g]);const G=(0,n.useMemo)(()=>{var e;if(!f)return j;const n=null!==(e=u[_])&&void 0!==e?e:[];if(0===n.length)return[];const t=new Set(n);return j.filter(e=>t.has(e))},[j,f,_]);(0,n.useEffect)(()=>{A||(0!==G.length?G.includes(S)||k(G[0]):f&&""!==S&&k(""))},[G,S,A,f]);const U=(0,n.useMemo)(()=>e.find(e=>e.slug===_),[_,e]),T=(0,n.useMemo)(()=>{var n;if(U?.label)return U.label;const t=e.find(e=>e.slug===_);return null!==(n=t?.label)&&void 0!==n?n:_?_.toUpperCase():""},[_,e,U]),F=0===p&&b.length>0,$=0===p&&h.length>0&&L,B=(0,n.useMemo)(()=>{const e=F?M||(0,t.__)("Default aspect ratio","wp-banana"):"",n=U?.default_model?String(U.default_model):"";let a=S||(A?(0,t.__)("Loading model…","wp-banana"):""!==n?n:(0,t.__)("Provider default model","wp-banana"));f&&0===G.length&&(a=(0,t.__)("No compatible model","wp-banana"));const r=p>0?(0,t.sprintf)((0,t._n)("%d reference","%d references",p,"wp-banana"),p):"";return{aspect:e,model:a,provider:T,references:r,fallback:e||a||T||r?"":(0,t.__)("Using provider defaults","wp-banana")}},[F,M,S,A,U,f,G,p,T]),V=(0,n.useMemo)(()=>G.length>0?""!==S&&G.includes(S):!f&&(""!==S||0===j.length),[G,S,f,j]);return{provider:_,setProvider:R,model:S,setModel:k,models:j,modelOptions:G,modelsLoading:A,loadError:E,aspectRatio:M,setAspectRatio:D,aspectRatioEnabled:F,aspectOptions:b,resolution:N,setResolution:I,resolutionEnabled:$,resolutionOptions:h,connectedProviders:v,selectedProviderConfig:U,summary:B,modelRequirementSatisfied:V,preferredAspectRatio:w,preferredResolution:x}})({providers:e,restNamespace:a,defaultGeneratorModel:b,defaultGeneratorProvider:h,aspectRatioOptions:x,defaultAspectRatio:y,resolutionOptions:_,defaultResolution:R,referenceCount:F,multiReferenceMode:z}),fe=(0,n.useCallback)(()=>{document.dispatchEvent(new CustomEvent("wp-banana:media-refresh"))},[]),{previewItems:ge,selectedPreview:ve,selectedPreviewSrc:be,activePreviewId:we,setActivePreviewId:he,previewAction:xe,canSaveSelected:ye,canDiscardSelected:_e,resetPreviewArea:Re,startVariations:je,savePreview:Ce,discardPreview:Se,undoPreview:ke}=(({restNamespace:e,dispatchMediaRefresh:a})=>{const[s,i]=(0,n.useState)([]),[o,l]=(0,n.useState)(null),[d,c]=(0,n.useState)(null),p=(0,n.useRef)([]),u=(0,n.useRef)([]),m=(0,n.useRef)(!1),f=(0,n.useRef)({successes:0,errors:[]});(0,n.useEffect)(()=>{p.current=s},[s]);const g=(0,n.useCallback)(()=>{0!==u.current.length&&(u.current.forEach(e=>window.clearTimeout(e)),u.current=[])},[]);(0,n.useEffect)(()=>()=>{m.current=!0,g()},[g]);const b=(0,n.useCallback)(()=>{m.current=!0,g(),i([]),p.current=[],l(null),c(null),f.current={successes:0,errors:[]}},[g]),w=(0,n.useCallback)(e=>{0===e.length&&b()},[b]),h=(0,n.useCallback)(({count:e,prompt:n,multiReferenceMode:a,modelOptions:r,sendGenerateRequest:s,onSuccessReset:o,setReferenceError:d,setSubmitError:p,setIsSubmitting:w})=>{var h;const x=Math.max(1,Math.min(4,e)),y=n.trim();if(y.length<3)return void p((0,t.__)("Please enter a longer prompt.","wp-banana"));if(a&&0===r.length)return void p((0,t.__)("Choose a model that supports multiple reference images.","wp-banana"));m.current=!1,g(),p(null),d(null),c(null),f.current={successes:0,errors:[]};const _=Date.now(),R=Array.from({length:x}).map((e,n)=>({id:`${_}-${n}-${Math.random().toString(36).slice(2,10)}`,index:n,status:"queued"}));i(R),l(null!==(h=R[0]?.id)&&void 0!==h?h:null),w(!0);const j=y,C=R.map((e,n)=>new Promise(a=>{const r=window.setTimeout(async()=>{if(m.current)a();else{i(n=>n.map(n=>n.id===e.id?{...n,status:"loading"}:n));try{var n,r,o,d,p,u,g;const c=await s(j,!0);if(m.current)return void a();const b=c?.preview,w=null!==(n=c?.context)&&void 0!==n?n:{};if(!b?.data)throw new Error((0,t.__)("Failed to generate image.","wp-banana"));const h={provider:null!==(r=w.provider)&&void 0!==r?r:"",model:w.model,format:null!==(o=w.format)&&void 0!==o?o:v(b.mime),prompt:null!==(d=w.prompt)&&void 0!==d?d:j,filenameBase:null!==(p=null!==(u=w.filename_base)&&void 0!==u?u:w.filenameBase)&&void 0!==p?p:"",title:null!==(g=w.title)&&void 0!==g?g:""};i(n=>n.map(n=>{var t,a;return n.id===e.id?{...n,status:"complete",data:null!==(t=b.data)&&void 0!==t?t:"",mime:null!==(a=b.mime)&&void 0!==a?a:"image/png",width:b.width,height:b.height,bytes:b.bytes,context:h,error:void 0}:n})),f.current.successes+=1,l(n=>null!=n?n:e.id)}catch(n){var b;if(m.current)return void a();const r=n,s=null!==(b=r?.message)&&void 0!==b?b:(0,t.__)("Failed to generate image.","wp-banana");f.current.errors.push(s),i(n=>n.map(n=>n.id===e.id?{...n,status:"error",error:s}:n)),c({message:s,type:"error"})}finally{a()}}},1e3*n);u.current.push(r)}));Promise.all(C).then(()=>{g(),m.current||(f.current.successes>0?o():(b(),f.current.errors.length>0&&p(f.current.errors[0])),w(!1))})},[g,b]),x=(0,n.useCallback)(async n=>{const s=p.current.find(e=>e.id===n);if(s&&("complete"===s.status||"error"===s.status)&&s.data&&s.context){c(null),i(e=>e.map(e=>e.id===n?{...e,status:"saving",error:void 0}:e));try{var o;const l=await r()({path:`${e}/generate/save-preview`,method:"POST",data:{data:s.data,provider:s.context.provider,model:null!==(o=s.context.model)&&void 0!==o?o:"",format:s.context.format,mime:s.mime,prompt:s.context.prompt,filename_base:s.context.filenameBase,title:s.context.title}});i(e=>{const t=e.map(e=>e.id===n?{...e,status:"saved",attachmentId:l?.attachment_id,url:l?.url,error:void 0}:e);return w(t),t}),c({message:(0,t.__)("Image saved to Media Library.","wp-banana"),type:"success"}),a()}catch(e){var l;const a=e,r=null!==(l=a?.message)&&void 0!==l?l:(0,t.__)("Failed to save image.","wp-banana");i(e=>e.map(e=>e.id===n?{...e,status:"error",error:r}:e)),c({message:r,type:"error"})}}},[e,w,a]),y=(0,n.useCallback)(e=>{const n=Array.isArray(p.current)?p.current:[],a=n.find(n=>n.id===e)||null,r=n.filter(n=>n.id!==e);if(i(r),p.current=r,0===r.length?l(null):o===e&&l(r[0].id),w(r),a){const e={...a,status:"complete"};c({message:(0,t.__)("Deleted.","wp-banana"),type:"warning",undo:e})}else c({message:(0,t.__)("Deleted.","wp-banana"),type:"warning"})},[o,w]),_=(0,n.useCallback)(()=>{const e=d?.undo;e&&(i(n=>{if(n.some(n=>n.id===e.id))return n;const t=[e,...n];return t.sort((e,n)=>e.index-n.index),t}),l(e.id),c(null))},[d]),R=(0,n.useMemo)(()=>{if(0===s.length)return null;const e=s.find(e=>e.id===o);return null!=e?e:s[0]},[s,o]),j=R&&R.data&&R.mime?`data:${R.mime};base64,${R.data}`:"",C=!!R&&("complete"===R.status||"error"===R.status),S=!!R&&"saving"!==R.status&&"saved"!==R.status;return{previewItems:s,selectedPreview:R,selectedPreviewSrc:j,activePreviewId:o,setActivePreviewId:l,previewAction:d,setPreviewAction:c,canSaveSelected:C,canDiscardSelected:S,resetPreviewArea:b,startVariations:h,savePreview:x,discardPreview:y,undoPreview:_}})({restNamespace:a,dispatchMediaRefresh:fe}),Ae=(0,n.useMemo)(()=>!(P||Z||C.trim().length<3||""===K||!pe||ae&&""===ne),[P,Z,C,K,pe,ae,ne]),Pe=(0,n.useCallback)(async(e,n)=>{if(F>0){let s=[];try{s=await q()}catch(e){throw T((0,t.__)("Could not load the selected images.","wp-banana")),e}const i=new window.FormData;return i.append("prompt",e),i.append("provider",K),Y&&i.append("model",Y),n&&i.append("preview_only","1"),s.forEach(e=>{i.append("reference_images[]",e,e.name)}),r()({path:`${a}/generate`,method:"POST",body:i})}const s={prompt:e,provider:K};return Y&&(s.model=Y),ae&&ne&&(s.aspect_ratio=ne),oe&&se&&(s.resolution=se),n&&(s.preview_only="1"),r()({path:`${a}/generate`,method:"POST",data:s})},[F,q,T,K,Y,a,ae,ne,oe,se]),Ee=(0,n.useCallback)(async()=>{const e=C.trim();if(e.length<3)A((0,t.__)("Please enter a longer prompt.","wp-banana"));else if(z&&0===X.length)A((0,t.__)("Choose a model that supports multiple reference images.","wp-banana"));else{A(null),T(null),E(!0);try{await Pe(e,!1),S(""),ae&&te(ue),oe&&ie(me),M(!1),W(),fe(),f()}catch(e){const n=e;n?.message?A(n.message):e instanceof Error&&e.message?A(e.message):A((0,t.__)("Failed to generate image.","wp-banana"))}finally{E(!1)}}},[C,z,X,T,Pe,ae,ue,oe,me,W,fe,f]),Oe=(0,n.useCallback)(e=>{"Enter"===e.key&&(e.metaKey||e.ctrlKey)&&(e.preventDefault(),Ae&&!P&&Ee())},[Ae,P,Ee]),Me=(0,n.useRef)(null);(0,n.useEffect)(()=>{if(!D)return;const e=e=>{Me.current&&e.target instanceof Node&&!Me.current.contains(e.target)&&N(!1)};return document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[D]);const De=(0,n.useCallback)(()=>{!P&&Ae&&N(e=>!e)},[P,Ae]),Ne=(0,n.useCallback)(()=>{S(""),ae&&te(ue),oe&&ie(me),W(),M(!1)},[ae,ue,oe,me,W]),Ie=(0,n.useCallback)(e=>{N(!1),P||je({count:e,prompt:C,multiReferenceMode:z,modelOptions:X,sendGenerateRequest:Pe,onSuccessReset:Ne,setReferenceError:T,setSubmitError:A,setIsSubmitting:E})},[P,je,C,z,X,Pe,Ne,T,A]),Le=(0,i.jsx)(c,{isOpen:D,options:p,onSelect:Ie});return(0,i.jsx)(s.Card,{children:(0,i.jsxs)(s.CardBody,{children:[ee&&(0,i.jsx)(s.Notice,{status:"error",isDismissible:!1,children:ee}),k&&(0,i.jsx)(s.Notice,{status:"error",isDismissible:!1,children:k}),U&&(0,i.jsx)(s.Notice,{status:"warning",isDismissible:!1,children:U}),z&&!Z&&0===X.length&&(0,i.jsx)(s.Notice,{status:"warning",isDismissible:!1,children:(0,t.__)("Switch to a supported model to send multiple reference images.","wp-banana")}),(0,i.jsx)(o,{prompt:C,onPromptChange:S,onPromptKeyDown:Oe,isSubmitting:P,canSubmit:Ae,onSubmit:Ee,onReferenceClick:V,showOptions:O,onToggleOptions:()=>M(e=>!e),summary:ce,variationMenuRef:Me,onVariationToggle:De,isVariationMenuOpen:D,variationMenu:Le,enableReferenceDragDrop:j,dropOverlayVisible:H,referenceTray:(0,i.jsx)(d,{referenceImages:G,onRemove:$,fileInputRef:L,onReferenceSelection:B})}),(0,i.jsx)(l,{show:O,connectedProviders:de,provider:K,onProviderChange:Q,model:Y,onModelChange:J,modelOptions:X,modelsLoading:Z,aspectRatioEnabled:ae,aspectRatio:ne,onAspectRatioChange:te,aspectOptions:re,resolutionEnabled:oe,resolution:se,onResolutionChange:ie,resolutionOptions:le,isSubmitting:P}),(0,i.jsx)(w,{previewItems:ge,selectedPreview:ve,selectedPreviewSrc:be,onSelect:he,previewAction:xe,onUndo:ke,onClear:Re,canSaveSelected:ye,canDiscardSelected:_e,onSave:Ce,onDiscard:Se})]})})};let x=null;const y=e=>{e.innerHTML="";const n=document.createElement("div");n.className="notice notice-warning";const a=document.createElement("p");a.textContent=(0,t.__)("No connected providers available. Add a key in Settings → AI Images.","wp-banana"),n.appendChild(a),e.appendChild(n)},_=()=>{const e=document.getElementById("wp-banana-generate-page");if(!e)return;const t=window.wpBananaGeneratePage;if(!t||!Array.isArray(t.providers))return void y(e);const a=t.providers.filter(e=>!1!==e.connected);0!==a.length?((e,t)=>{const a=window.wp?.element,r=()=>{t.redirectUrl?window.location.href=t.redirectUrl:window.location.reload()};if("function"==typeof a?.createRoot)return x||(x=a.createRoot(e)),void x.render((0,i.jsx)(h,{providers:t.providers,restNamespace:t.restNamespace,onComplete:r,defaultGeneratorModel:t.defaultGeneratorModel,defaultGeneratorProvider:t.defaultGeneratorProvider,defaultAspectRatio:t.defaultAspectRatio,aspectRatioOptions:t.aspectRatioOptions,defaultResolution:t.defaultResolution,resolutionOptions:t.resolutionOptions,enableReferenceDragDrop:!0}));(0,n.render)((0,i.jsx)(h,{providers:t.providers,restNamespace:t.restNamespace,onComplete:r,defaultGeneratorModel:t.defaultGeneratorModel,defaultGeneratorProvider:t.defaultGeneratorProvider,defaultAspectRatio:t.defaultAspectRatio,aspectRatioOptions:t.aspectRatioOptions,defaultResolution:t.defaultResolution,resolutionOptions:t.resolutionOptions,enableReferenceDragDrop:!0}),e)})(e,{restNamespace:t.restNamespace,providers:a,redirectUrl:t.redirectUrl,defaultGeneratorModel:t.defaultGeneratorModel,defaultGeneratorProvider:t.defaultGeneratorProvider,defaultAspectRatio:t.defaultAspectRatio,aspectRatioOptions:t.aspectRatioOptions,defaultResolution:t.defaultResolution,resolutionOptions:t.resolutionOptions}):y(e)};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",_):_()})();