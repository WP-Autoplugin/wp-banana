(()=>{"use strict";var e={n:a=>{var n=a&&a.__esModule?()=>a.default:()=>a;return e.d(n,{a:n}),n},d:(a,n)=>{for(var t in n)e.o(n,t)&&!e.o(a,t)&&Object.defineProperty(a,t,{enumerable:!0,get:n[t]})},o:(e,a)=>Object.prototype.hasOwnProperty.call(e,a)};const a=window.wp.element,n=window.wp.i18n,t=window.React,r=window.wp.apiFetch;var l=e.n(r);const s=window.wp.components,o=window.ReactJSXRuntime,i={gemini:["gemini-2.5-flash-image-preview","gemini-2.5-flash-image"],openai:["gpt-image-1","gpt-image-1-mini"],replicate:["google/nano-banana","bytedance/seedream-4","reve/remix"]},d={"image/jpeg":"jpg","image/jpg":"jpg","image/png":"png","image/webp":"webp"},c=(e,a,n)=>{var t;const r=`reference-${a}`,l=e&&e.trim().length>0?e.trim():r,s=null!==(t=d[n.toLowerCase()])&&void 0!==t?t:"";if(""===s)return l;if(l.toLowerCase().endsWith(`.${s}`))return l;const o=l.lastIndexOf(".");return o>0?`${l.slice(0,o)}.${s}`:`${l}.${s}`},p=({providers:e,restNamespace:r,onComplete:d,defaultGeneratorModel:p,defaultGeneratorProvider:u,aspectRatioOptions:f,defaultAspectRatio:m,enableReferenceDragDrop:g=!1})=>{const w=(0,a.useMemo)(()=>e.filter(e=>!1!==e.connected),[e]),h=(0,a.useMemo)(()=>Array.isArray(f)?f.map(e=>"string"==typeof e?e.trim().toUpperCase():"").filter(e=>e.length>0):[],[f]),b=(0,a.useMemo)(()=>{var e;if("string"==typeof m){const e=m.trim().toUpperCase();if(e&&h.includes(e))return e}return null!==(e=h[0])&&void 0!==e?e:""},[h,m]),v=(0,a.useMemo)(()=>{var a;if(u){const e=w.find(e=>e.slug===u);if(e)return e.slug}if(p){const a=w.find(e=>e.default_model===p);if(a)return a.slug;const n=e.find(e=>e.default_model===p);if(n){const e=w.find(e=>e.slug===n.slug);if(e)return e.slug}}return w.length>0?w[0].slug:null!==(a=e[0]?.slug)&&void 0!==a?a:""},[w,e,u,p]),[y,_]=(0,a.useState)(v),[x,j]=(0,a.useState)(""),[C,R]=(0,a.useState)([]),[A,E]=(0,a.useState)(""),[k,N]=(0,a.useState)(!1),[L,S]=(0,a.useState)(null),[D,M]=(0,a.useState)(null),[U,O]=(0,a.useState)(!1),[P,G]=(0,a.useState)(b),[$,T]=(0,a.useState)(!1),[I,B]=(0,a.useState)([]),[F,W]=(0,a.useState)(null),[Q,H]=(0,a.useState)(!1),K=(0,t.useRef)(null),Y=(0,t.useRef)(I),J=(0,t.useRef)(0),X=I.length,q=X>1,z=(0,a.useMemo)(()=>{var e;if(!q)return C;const a=null!==(e=i[y])&&void 0!==e?e:[];if(0===a.length)return[];const n=new Set(a);return C.filter(e=>n.has(e))},[C,q,y]),V=0===X&&h.length>0;(0,a.useEffect)(()=>{Y.current=I},[I]),(0,a.useEffect)(()=>()=>{Y.current.forEach(e=>{e.revokeOnCleanup&&e.url&&window.URL.revokeObjectURL(e.url)})},[]);const Z=(0,t.useCallback)(()=>{Y.current.forEach(e=>{e.revokeOnCleanup&&e.url&&window.URL.revokeObjectURL(e.url)}),B([]),W(null)},[]),ee=(0,t.useCallback)(e=>{if(j(""),M(null),Z(),!Array.isArray(e)||0===e.length)return;const a=[];e.slice(0,4).forEach(e=>{if(!e.sourceUrl||0===e.sourceUrl.length)return;const n=`${Date.now()}-${Math.random().toString(36).slice(2)}`,t=e.sourceUrl,r=e.previewUrl&&e.previewUrl.length>0?e.previewUrl:t;a.push({id:n,url:r,sourceUrl:t,filename:e.filename,mimeType:e.mime})}),B(a),Y.current=a,e.length>4&&W((0,n.__)("Only the first 4 selected images were attached as references.","wp-banana"))},[Z]);(0,a.useEffect)(()=>{const e=e=>{if(!e)return;const a=window,n=a.wpBananaReferenceQueue;if(!Array.isArray(n)||0===n.length)return;const t=n.indexOf(e);t>=0&&n.splice(t,1),0===n.length&&delete a.wpBananaReferenceQueue},a=a=>{const n=a,t=n.detail?.references;Array.isArray(t)&&0!==t.length?(e(t),ee(t)):e(t)};return(()=>{const e=window,a=e.wpBananaReferenceQueue;if(Array.isArray(a)&&0!==a.length){for(;a.length>0;){const e=a.shift();Array.isArray(e)&&e.length>0&&ee(e)}delete e.wpBananaReferenceQueue}})(),window.addEventListener("wp-banana:set-reference-images",a),()=>{window.removeEventListener("wp-banana:set-reference-images",a)}},[ee]),(0,a.useEffect)(()=>{X>0?""!==P&&G(""):0!==h.length?h.includes(P)||b!==P&&G(b):""!==P&&G("")},[h,P,b,X]);const ae=(0,a.useMemo)(()=>e.find(e=>e.slug===y),[y,e]),ne=(0,a.useMemo)(()=>{var a;if(ae?.label)return ae.label;const n=e.find(e=>e.slug===y);return null!==(a=n?.label)&&void 0!==a?a:y?y.toUpperCase():""},[y,e,ae]),te=(0,a.useMemo)(()=>{const e=V?P||(0,n.__)("Default aspect ratio","wp-banana"):"",a=ae?.default_model?String(ae.default_model):"";let t=A||(k?(0,n.__)("Loading model…","wp-banana"):""!==a?a:(0,n.__)("Provider default model","wp-banana"));q&&0===z.length&&(t=(0,n.__)("No compatible model","wp-banana"));const r=ne,l=X>0?(0,n.sprintf)((0,n._n)("%d reference","%d references",X,"wp-banana"),X):"";return{aspect:e,model:t,provider:r,references:l,fallback:e||t||r||l?"":(0,n.__)("Using provider defaults","wp-banana")}},[V,P,A,k,ne,ae,q,z,X]);(0,a.useEffect)(()=>{y&&w.some(e=>e.slug===y)||v&&_(v)},[v,y,w]),(0,a.useEffect)(()=>{if(!y)return;const e=X>0?"edit":"generate";let a=!0;return N(!0),S(null),l()({path:`${r}/models?provider=${y}&purpose=${e}`}).then(e=>{if(!a)return;const n=e,t=Array.isArray(n.models)?n.models:[];if(R(t),0===t.length)return void E("");const r=(X>0?[ae?.default_model]:[p,ae?.default_model]).find(e=>!!e&&t.includes(e));E(r||t[0])}).catch(e=>{var t;a&&(R([]),E(""),S(null!==(t=e?.message)&&void 0!==t?t:(0,n.__)("Failed to load models.","wp-banana")))}).finally(()=>{a&&N(!1)}),()=>{a=!1}},[y,r,ae,p,X]),(0,a.useEffect)(()=>{k||(0!==z.length?z.includes(A)||E(z[0]):q&&""!==A&&E(""))},[z,A,k,q]);const re=(0,a.useMemo)(()=>z.length>0?""!==A&&z.includes(A):!q&&(""!==A||0===C.length),[z,A,q,C]),le=(0,a.useMemo)(()=>!(U||k||x.trim().length<3||""===y||!re||V&&""===P),[U,k,x,y,re,V,P]),se=(0,t.useCallback)(()=>{K.current&&K.current.click()},[]),oe=(0,t.useCallback)(e=>{if(!Array.isArray(e)||0===e.length)return;const a=Array.isArray(Y.current)?Y.current:[];let t=Math.max(0,4-a.length),r=0,l=0;const s=[];if(e.forEach(e=>{if(!e?.type||!e.type.startsWith("image/"))return;if(l+=1,t<=0)return;const a=`${Date.now()}-${Math.random().toString(36).slice(2)}`,n=window.URL.createObjectURL(e);s.push({id:a,file:e,url:n,revokeOnCleanup:!0,filename:e.name,mimeType:e.type}),t-=1,r+=1}),r>0){const e=[...a,...s];Y.current=e,B(e),M(null),W(l>r?(0,n.__)("You can upload up to 4 reference images.","wp-banana"):null)}else l>0&&W((0,n.__)("You can upload up to 4 reference images.","wp-banana"))},[B,M,W]),ie=(0,t.useCallback)(e=>{const a=e.target.files;a&&a.length>0&&oe(Array.from(a)),e.target.value=""},[oe]),de=(0,t.useCallback)(e=>{const a=I.filter(a=>a.id!==e||(a.revokeOnCleanup&&a.url&&window.URL.revokeObjectURL(a.url),!1));B(a),W(null)},[I]);(0,a.useEffect)(()=>{if(!g)return;const e=e=>{const a=e.dataTransfer?.types;return!!a&&Array.from(a).includes("Files")},a=a=>{e(a)&&(a.preventDefault(),a.stopPropagation(),J.current+=1,H(!0))},n=a=>{e(a)&&(a.preventDefault(),a.stopPropagation(),a.dataTransfer&&(a.dataTransfer.dropEffect="copy"),H(!0))},t=()=>{J.current=0,H(!1)},r=a=>{e(a)&&(a.preventDefault(),a.stopPropagation(),J.current=Math.max(0,J.current-1),0===J.current&&H(!1))},l=a=>{if(!e(a))return;a.preventDefault(),a.stopPropagation();const n=a.dataTransfer,r=n?Array.from(n.files||[]):[];if(r.length>0&&oe(r),n)try{n.clearData()}catch(e){}t()},s=a=>{e(a)&&t()};return window.addEventListener("dragenter",a),window.addEventListener("dragover",n),window.addEventListener("dragleave",r),window.addEventListener("drop",l),window.addEventListener("dragend",s),()=>{window.removeEventListener("dragenter",a),window.removeEventListener("dragover",n),window.removeEventListener("dragleave",r),window.removeEventListener("drop",l),window.removeEventListener("dragend",s),J.current=0,H(!1)}},[oe,g]);const ce=async()=>{const e=x.trim();if(e.length<3)M((0,n.__)("Please enter a longer prompt.","wp-banana"));else if(q&&0===z.length)M((0,n.__)("Choose a model that supports multiple reference images.","wp-banana"));else{M(null),W(null),O(!0);try{if(X>0){const a=async()=>{const e=[...I],a=[];let t=!1;for(let r=0;r<e.length;r+=1){const l=e[r];if(l.file instanceof File){a.push(l.file);continue}if(!l.sourceUrl)throw new Error((0,n.__)("Could not load the selected images.","wp-banana"));let s;try{s=await window.fetch(l.sourceUrl,{credentials:"same-origin"})}catch(e){throw new Error((0,n.__)("Could not load the selected images.","wp-banana"))}if(!s.ok)throw new Error((0,n.__)("Could not load the selected images.","wp-banana"));const o=await s.blob(),i=o.type||l.mimeType||"image/png",d=c(l.filename,r+1,i),p=new File([o],d,{type:i});e[r]={...l,file:p,mimeType:i},a.push(p),t=!0}return t&&B(e),Y.current=e,a};let t=[];try{t=await a()}catch(e){throw W((0,n.__)("Could not load the selected images.","wp-banana")),e}const s=new window.FormData;s.append("prompt",e),s.append("provider",y),A&&s.append("model",A),t.forEach(e=>{s.append("reference_images[]",e,e.name)}),await l()({path:`${r}/generate`,method:"POST",body:s})}else{const a={prompt:e,provider:y};A&&(a.model=A),V&&P&&(a.aspect_ratio=P),await l()({path:`${r}/generate`,method:"POST",data:a})}j(""),V&&G(b),T(!1),Z(),d()}catch(e){var a;const t=e;M(null!==(a=t?.message)&&void 0!==a?a:(0,n.__)("Failed to generate image.","wp-banana"))}finally{O(!1)}}},pe=(0,t.useCallback)(e=>{"Enter"===e.key&&(e.metaKey||e.ctrlKey)&&(e.preventDefault(),le&&!U&&ce())},[le,U,ce]),ue=g&&Q;return(0,o.jsxs)(o.Fragment,{children:[g&&(0,o.jsx)("div",{className:"uploader-window wp-banana-generate-page__drop-overlay",style:{display:ue?"block":"none",opacity:ue?1:0},"aria-hidden":"true",children:(0,o.jsx)("div",{className:"uploader-window-content",children:(0,o.jsx)("div",{className:"uploader-editor-title",children:(0,n.__)("Drop files to attach","wp-banana")})})}),(0,o.jsx)(s.Card,{children:(0,o.jsxs)(s.CardBody,{children:[L&&(0,o.jsx)(s.Notice,{status:"error",isDismissible:!1,children:L}),D&&(0,o.jsx)(s.Notice,{status:"error",isDismissible:!1,children:D}),F&&(0,o.jsx)(s.Notice,{status:"warning",isDismissible:!1,children:F}),q&&!k&&0===z.length&&(0,o.jsx)(s.Notice,{status:"warning",isDismissible:!1,children:(0,n.__)("Switch to a supported model to send multiple reference images.","wp-banana")}),(0,o.jsxs)("div",{className:"wp-banana-generate-panel__prompt",style:{position:"relative",marginBottom:"8px"},children:[(0,o.jsx)(s.TextareaControl,{label:(0,n.__)("Describe the image","wp-banana"),value:x,onChange:j,onKeyDown:pe,rows:5,placeholder:(0,n.__)("A cat surfing a wave at sunset…","wp-banana"),disabled:U}),(0,o.jsx)("button",{type:"button",className:"button button-secondary button-small wp-banana-generate-panel__reference-picker",onClick:se,disabled:U,"aria-label":(0,n.__)("Add reference images","wp-banana"),style:{position:"absolute",top:"24px",right:"0",lineHeight:"20px",padding:"0 4px",border:"none",borderRadius:0,background:"transparent"},children:(0,o.jsx)("span",{className:"dashicons dashicons-paperclip","aria-hidden":"true"})}),(0,o.jsx)("input",{ref:K,type:"file",accept:"image/png,image/jpeg,image/webp",multiple:!0,onChange:ie,style:{display:"none"}})]}),I.length>0&&(0,o.jsx)("div",{className:"wp-banana-generate-panel__reference-list",style:{display:"flex",gap:"8px",marginBottom:"16px",flexWrap:"wrap"},children:I.map(e=>(0,o.jsxs)("div",{style:{position:"relative",width:"72px",height:"72px",overflow:"hidden",borderRadius:"4px",border:"1px solid #dcdcde"},children:[(0,o.jsx)("img",{src:e.url,alt:"",style:{width:"100%",height:"100%",objectFit:"cover"}}),(0,o.jsx)("button",{type:"button",className:"button-link wp-banana-generate-panel__reference-remove",onClick:()=>de(e.id),"aria-label":(0,n.__)("Remove reference image","wp-banana"),style:{position:"absolute",top:"2px",right:"2px",display:"inline-flex",alignItems:"center",justifyContent:"center",width:"22px",height:"22px",background:"rgba(0,0,0,0.55)",color:"#fff",borderRadius:"3px",textDecoration:"none"},children:(0,o.jsx)("span",{className:"dashicons dashicons-no"})})]},e.id))}),$&&w.length>1&&(0,o.jsx)(s.SelectControl,{label:(0,n.__)("Provider","wp-banana"),value:y,onChange:e=>_(e),options:w.map(e=>({label:e.label,value:e.slug})),disabled:U}),$&&(0,o.jsx)(s.SelectControl,{label:(0,n.__)("Model","wp-banana"),value:A,onChange:e=>E(e),disabled:k||0===z.length||U,options:z.length>0?z.map(e=>({label:e,value:e})):[{label:(0,n.__)("No models available","wp-banana"),value:""}]}),$&&V&&(0,o.jsx)(s.SelectControl,{label:(0,n.__)("Aspect ratio","wp-banana"),value:P,onChange:e=>G(e),disabled:U,options:h.map(e=>({label:e,value:e}))}),k&&(0,o.jsxs)("div",{className:"wp-banana-generate-panel__spinner",style:{display:"flex",alignItems:"center",gap:"8px"},children:[(0,o.jsx)(s.Spinner,{})," ",(0,n.__)("Loading models…","wp-banana")]}),(0,o.jsxs)("div",{className:"wp-banana-generate-panel__actions",style:{marginTop:"16px",display:"flex",flexWrap:"wrap",alignItems:"center",gap:"12px",justifyContent:"space-between"},children:[(0,o.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"12px"},children:[(0,o.jsx)("button",{type:"button",className:"button button-primary wp-banana-generate-panel__submit",onClick:ce,disabled:!le||U,children:(0,n.__)("Generate Image","wp-banana")}),U&&(0,o.jsx)("span",{className:"spinner is-active","aria-hidden":"true"})]}),(0,o.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"8px",flexWrap:"wrap",textAlign:"right"},children:[te.fallback?(0,o.jsx)("span",{children:te.fallback}):(0,o.jsxs)("span",{children:[te.aspect&&(0,o.jsxs)("span",{children:[te.aspect," — "]}),(0,o.jsx)("code",{children:te.model}),te.provider&&(0,o.jsxs)("span",{children:[" (",te.provider,")"]}),te.references&&(0,o.jsxs)("span",{children:[" - ",te.references]})]}),(0,o.jsx)("button",{type:"button",className:"button-link",onClick:()=>T(!$),children:$?(0,n.__)("Hide options","wp-banana"):(0,n.__)("Change","wp-banana")})]})]})]})})]})};let u=null;const f=e=>{e.innerHTML="";const a=document.createElement("div");a.className="notice notice-warning";const t=document.createElement("p");t.textContent=(0,n.__)("No connected providers available. Add a key in Settings → AI Images.","wp-banana"),a.appendChild(t),e.appendChild(a)},m=()=>{const e=document.getElementById("wp-banana-generate-page");if(!e)return;const n=window.wpBananaGeneratePage;if(!n||!Array.isArray(n.providers))return void f(e);const t=n.providers.filter(e=>!1!==e.connected);0!==t.length?((e,n)=>{const t=window.wp?.element,r=()=>{n.redirectUrl?window.location.href=n.redirectUrl:window.location.reload()};if("function"==typeof t?.createRoot)return u||(u=t.createRoot(e)),void u.render((0,o.jsx)(p,{providers:n.providers,restNamespace:n.restNamespace,onComplete:r,defaultGeneratorModel:n.defaultGeneratorModel,defaultGeneratorProvider:n.defaultGeneratorProvider,defaultAspectRatio:n.defaultAspectRatio,aspectRatioOptions:n.aspectRatioOptions,enableReferenceDragDrop:!0}));(0,a.render)((0,o.jsx)(p,{providers:n.providers,restNamespace:n.restNamespace,onComplete:r,defaultGeneratorModel:n.defaultGeneratorModel,defaultGeneratorProvider:n.defaultGeneratorProvider,defaultAspectRatio:n.defaultAspectRatio,aspectRatioOptions:n.aspectRatioOptions,enableReferenceDragDrop:!0}),e)})(e,{restNamespace:n.restNamespace,providers:t,redirectUrl:n.redirectUrl,defaultGeneratorModel:n.defaultGeneratorModel,defaultGeneratorProvider:n.defaultGeneratorProvider,defaultAspectRatio:n.defaultAspectRatio,aspectRatioOptions:n.aspectRatioOptions}):f(e)};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",m):m()})();