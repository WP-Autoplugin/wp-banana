(()=>{"use strict";var e={n:a=>{var n=a&&a.__esModule?()=>a.default:()=>a;return e.d(n,{a:n}),n},d:(a,n)=>{for(var t in n)e.o(n,t)&&!e.o(a,t)&&Object.defineProperty(a,t,{enumerable:!0,get:n[t]})},o:(e,a)=>Object.prototype.hasOwnProperty.call(e,a)};const a=window.wp.element,n=window.wp.i18n,t=window.wp.apiFetch;var r=e.n(t);const s=window.wp.components,i=window.ReactJSXRuntime,o=({prompt:e,onPromptChange:a,onPromptKeyDown:t,isSubmitting:r,canSubmit:o,onSubmit:l,onReferenceClick:d,showOptions:c,onToggleOptions:p,summary:u,variationMenuRef:m,onVariationToggle:g,isVariationMenuOpen:f,variationMenu:v,enableReferenceDragDrop:b=!1,dropOverlayVisible:w=!1,promptLabel:h,promptPlaceholder:x,submitLabel:y,submitTooltip:_})=>{const R=Boolean(m&&g&&"boolean"==typeof f),j=null!=h?h:(0,n.__)("Describe the image","wp-banana"),C=null!=x?x:(0,n.__)("A cat surfing a wave at sunset…","wp-banana"),S=null!=y?y:(0,n.__)("Generate Image","wp-banana"),k=null!=_?_:(0,n.__)("Generate one image and save to Media Library","wp-banana");return(0,i.jsxs)(i.Fragment,{children:[b&&(0,i.jsx)("div",{className:"uploader-window wp-banana-generate-page__drop-overlay",style:{display:w?"block":"none",opacity:w?1:0},"aria-hidden":"true",children:(0,i.jsx)("div",{className:"uploader-window-content",children:(0,i.jsx)("div",{className:"uploader-editor-title",children:(0,n.__)("Drop files to attach","wp-banana")})})}),(0,i.jsxs)("div",{className:"wp-banana-generate-panel__prompt",style:{position:"relative",marginBottom:"8px"},children:[(0,i.jsx)(s.TextareaControl,{label:j,value:e,onChange:a,onKeyDown:t,rows:5,placeholder:C,disabled:r}),(0,i.jsx)("button",{type:"button",className:"button button-secondary button-small wp-banana-generate-panel__reference-picker",onClick:d,disabled:r,"aria-label":(0,n.__)("Add reference images","wp-banana"),style:{position:"absolute",top:"24px",right:"0",lineHeight:"20px",padding:"0 4px",border:"none",borderRadius:0,background:"transparent"},children:(0,i.jsx)("span",{className:"dashicons dashicons-paperclip","aria-hidden":"true"})})]}),(0,i.jsxs)("div",{className:"wp-banana-generate-panel__actions",style:{marginTop:"16px",display:"flex",flexWrap:"wrap",alignItems:"center",gap:"12px",justifyContent:"space-between"},children:[(0,i.jsxs)("div",{ref:R&&null!=m?m:null,style:{display:"flex",alignItems:"center",gap:"12px",position:"relative",zIndex:1e3},children:[(0,i.jsxs)("div",{className:"button-group",children:[(0,i.jsx)("button",{type:"button",className:"button button-primary wp-banana-generate-panel__submit",onClick:l,disabled:!o||r,title:k,children:S}),R&&(0,i.jsx)("button",{type:"button",className:"button button-primary",onClick:g,disabled:r||!o,"aria-haspopup":"menu","aria-expanded":f,"aria-label":(0,n.__)("Generate multiple variations","wp-banana"),style:{padding:"0 4px"},title:(0,n.__)("Generate multiple variations and preview before saving","wp-banana"),children:(0,i.jsx)("span",{className:"dashicons dashicons-arrow-down-alt2","aria-hidden":"true",style:{lineHeight:"30px"}})})]}),r&&(0,i.jsx)("span",{className:"spinner is-active","aria-hidden":"true"}),R&&v]}),(0,i.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"8px",flexWrap:"wrap",textAlign:"right"},children:[u.fallback?(0,i.jsx)("span",{children:u.fallback}):(0,i.jsxs)("span",{children:[u.aspect&&(0,i.jsxs)("span",{children:[u.aspect," — "]}),(0,i.jsx)("code",{children:u.model}),u.provider&&(0,i.jsxs)("span",{children:[" (",u.provider,")"]}),u.references&&(0,i.jsxs)("span",{children:[" - ",u.references]})]}),(0,i.jsx)("button",{type:"button",className:"button-link",onClick:p,children:c?(0,n.__)("Hide options","wp-banana"):(0,n.__)("Change","wp-banana")})]})]})]})},l=({show:e,connectedProviders:a,provider:t,onProviderChange:r,model:o,onModelChange:l,modelOptions:d,modelsLoading:c,aspectRatioEnabled:p,aspectRatio:u,onAspectRatioChange:m,aspectOptions:g,isSubmitting:f,children:v})=>e?(0,i.jsxs)("div",{className:"wp-banana-generate-panel__options",children:[v,a.length>1&&(0,i.jsx)(s.SelectControl,{label:(0,n.__)("Provider","wp-banana"),value:t,onChange:r,options:a.map(e=>({label:e.label,value:e.slug})),disabled:f}),(0,i.jsx)(s.SelectControl,{label:(0,n.__)("Model","wp-banana"),value:o,onChange:l,disabled:c||0===d.length||f,options:d.length>0?d.map(e=>({label:e,value:e})):[{label:(0,n.__)("No models available","wp-banana"),value:""}]}),p&&(0,i.jsx)(s.SelectControl,{label:(0,n.__)("Aspect ratio","wp-banana"),value:u,onChange:m,disabled:f,options:g.map(e=>({label:e,value:e}))}),c&&(0,i.jsxs)("div",{className:"wp-banana-generate-panel__spinner",style:{display:"flex",alignItems:"center",gap:"8px"},children:[(0,i.jsx)(s.Spinner,{})," ",(0,n.__)("Loading models…","wp-banana")]})]}):(0,i.jsxs)(i.Fragment,{children:[v,c&&(0,i.jsxs)("div",{className:"wp-banana-generate-panel__spinner",style:{display:"flex",alignItems:"center",gap:"8px"},children:[(0,i.jsx)(s.Spinner,{})," ",(0,n.__)("Loading models…","wp-banana")]})]}),d=({referenceImages:e,onRemove:a,fileInputRef:t,onReferenceSelection:r})=>(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)("input",{ref:t,type:"file",accept:"image/png,image/jpeg,image/webp",multiple:!0,onChange:r,style:{display:"none"}}),e.length>0&&(0,i.jsx)("div",{className:"wp-banana-generate-panel__reference-list",style:{display:"flex",gap:"8px",marginBottom:"16px",flexWrap:"wrap"},children:e.map(e=>(0,i.jsxs)("div",{style:{position:"relative",width:"72px",height:"72px",overflow:"hidden",borderRadius:"4px",border:"1px solid #dcdcde"},children:[(0,i.jsx)("img",{src:e.url,alt:"",style:{width:"100%",height:"100%",objectFit:"cover"}}),(0,i.jsx)("button",{type:"button",className:"button-link wp-banana-generate-panel__reference-remove",onClick:()=>a(e.id),"aria-label":(0,n.__)("Remove reference image","wp-banana"),style:{position:"absolute",top:"2px",right:"2px",display:"inline-flex",alignItems:"center",justifyContent:"center",width:"22px",height:"22px",background:"rgba(0,0,0,0.55)",color:"#fff",borderRadius:"3px",textDecoration:"none"},children:(0,i.jsx)("span",{className:"dashicons dashicons-no"})})]},e.id))})]}),c=({isOpen:e,options:a,onSelect:t})=>e?(0,i.jsxs)("div",{className:"wp-banana-generate-panel__variation-menu",role:"menu",style:{position:"absolute",top:"100%",right:0,marginTop:"4px",background:"#fff",border:"1px solid #dcdcde",borderRadius:"4px",boxShadow:"0 4px 12px rgba(0,0,0,0.15)",zIndex:10,minWidth:"180px",padding:"4px 0"},children:[a.map(e=>(0,i.jsxs)("button",{type:"button",role:"menuitem",className:"button button-link",style:{display:"flex",width:"100%",justifyContent:"space-between",alignItems:"center",padding:"6px 12px",boxSizing:"border-box",textDecoration:"none"},onClick:()=>t(e),children:[(0,i.jsx)("span",{children:(0,n.sprintf)((0,n._n)("%d image","%d images",e,"wp-banana"),e)}),1===e&&(0,i.jsx)("span",{className:"dashicons dashicons-format-image","aria-hidden":"true"}),e>1&&(0,i.jsx)("span",{className:"dashicons dashicons-images-alt2","aria-hidden":"true"})]},e)),(0,i.jsx)("span",{style:{display:"block",padding:"4px 12px 2px",fontSize:"11px",fontWeight:"400",color:"#555d66",borderTop:"1px solid #e1e1e1"},children:(0,n.__)("Generate and Preview Images","wp-banana")})]}):null,p=[1,2,3,4],u={gemini:["gemini-2.5-flash-image-preview","gemini-2.5-flash-image"],openai:["gpt-image-1","gpt-image-1-mini"],replicate:["google/nano-banana","bytedance/seedream-4","reve/remix"]},m={"image/jpeg":"jpg","image/jpg":"jpg","image/png":"png","image/webp":"webp"},g=(e,a,n)=>{var t;const r=`reference-${a}`,s=e&&e.trim().length>0?e.trim():r,i=null!==(t=m[n.toLowerCase()])&&void 0!==t?t:"";if(""===i)return s;if(s.toLowerCase().endsWith(`.${i}`))return s;const o=s.lastIndexOf(".");return o>0?`${s.slice(0,o)}.${i}`:`${s}.${i}`},f=e=>{if(!e)return"png";const a=m[e.toLowerCase()];return null!=a?a:"png"},v=e=>{switch(e){case"queued":case"loading":return(0,n.__)("Generating…","wp-banana");case"complete":return(0,n.__)("Ready","wp-banana");case"saving":return(0,n.__)("Saving…","wp-banana");case"saved":return(0,n.__)("Saved","wp-banana");case"error":return(0,n.__)("Failed","wp-banana");default:return""}},b=({previewItems:e,selectedPreview:a,selectedPreviewSrc:t,onSelect:r,previewAction:o,onUndo:l,onClear:d,canSaveSelected:c,canDiscardSelected:p,onSave:u,onDiscard:m})=>{var g;return 0===e.length?null:(0,i.jsxs)("div",{className:"wp-banana-generate-panel__variations",style:{marginTop:"24px",borderTop:"1px solid #dcdcde",paddingTop:"16px"},children:[(0,i.jsxs)("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:"12px",gap:"12px"},children:[(0,i.jsx)("h3",{style:{margin:0},children:(0,n.__)("Generated Variations","wp-banana")}),(0,i.jsx)("button",{type:"button",className:"button",onClick:d,children:(0,n.__)("Clear previews","wp-banana")})]}),o&&"success"!==o.type&&(0,i.jsx)(s.Notice,{status:"warning"===o.type?"warning":"error",isDismissible:!1,style:{marginBottom:"16px"},children:(0,i.jsxs)("div",{className:"wp-banana-generate-variations-notice",style:{display:"flex",alignItems:"center",gap:"8px",flexWrap:"wrap"},children:[(0,i.jsx)("span",{children:o.message}),o.undo?(0,i.jsx)("button",{type:"button",className:"button-link",onClick:l,children:(0,n.__)("Undo","wp-banana")}):null]})}),(0,i.jsxs)("div",{className:"wp-banana-generate-variations-layout",style:{display:"flex",gap:"16px",flexWrap:"wrap"},children:[(0,i.jsx)("div",{className:"wp-banana-generate-variations-list",style:{width:"200px",maxHeight:"440px",overflowY:"auto",display:"flex",flexDirection:"column",gap:"8px"},children:e.map(e=>{const t=e.id===a?.id,o=e.data&&e.mime?`data:${e.mime};base64,${e.data}`:"";return(0,i.jsxs)("button",{type:"button",onClick:()=>r(e.id),className:"button button-link",style:{display:"flex",flexDirection:"column",alignItems:"stretch",gap:"6px",padding:"6px",border:t?"2px solid #007cba":"1px solid #dcdcde",borderRadius:"4px",background:t?"#f0f6fc":"#fff",textAlign:"left",textDecoration:"none",boxShadow:"none"},children:[(0,i.jsxs)("div",{style:{position:"relative",height:"64px",background:"#f6f7f7",display:"flex",alignItems:"center",justifyContent:"center",overflow:"hidden",borderRadius:"3px"},children:["complete"===e.status||"saved"===e.status||"error"===e.status?o?(0,i.jsx)("img",{src:o,alt:"",style:{width:"100%",height:"100%",objectFit:"cover"}}):(0,i.jsx)("span",{children:(0,n.__)("Preview unavailable","wp-banana")}):(0,i.jsx)(s.Spinner,{}),"saved"===e.status&&(0,i.jsx)("span",{style:{position:"absolute",top:"4px",right:"4px",background:"#007cba",color:"#fff",padding:"2px 6px",borderRadius:"3px",fontSize:"11px",fontWeight:600},children:(0,n.__)("Saved","wp-banana")})]}),(0,i.jsxs)("div",{style:{display:"flex",flexDirection:"column",gap:"2px"},children:[(0,i.jsx)("strong",{children:(0,n.sprintf)((0,n.__)("Variation %d","wp-banana"),e.index+1)}),(0,i.jsx)("span",{style:{fontSize:"12px",color:"#555"},children:v(e.status)})]})]},e.id)})}),(0,i.jsxs)("div",{className:"wp-banana-generate-variations-preview",style:{flex:1,minWidth:"260px",display:"flex",flexDirection:"column",gap:"16px"},children:[(0,i.jsx)("div",{style:{position:"relative",background:"#f6f7f7",border:"1px solid #dcdcde",borderRadius:"4px",minHeight:"300px",display:"flex",alignItems:"center",justifyContent:"center",padding:"12px"},children:a?"loading"===a.status||"queued"===a.status?(0,i.jsx)(s.Spinner,{}):"error"===a.status?(0,i.jsx)(s.Notice,{status:"error",isDismissible:!1,children:null!==(g=a.error)&&void 0!==g?g:(0,n.__)("Failed to generate image.","wp-banana")}):(0,i.jsxs)(i.Fragment,{children:[t?(0,i.jsx)("img",{src:t,alt:"",style:{maxWidth:"100%",maxHeight:"500px",borderRadius:"4px",objectFit:"contain"}}):(0,i.jsx)("span",{children:(0,n.__)("Preview unavailable","wp-banana")}),"saving"===a.status&&(0,i.jsxs)("div",{style:{position:"absolute",inset:0,background:"rgba(255,255,255,0.7)",display:"flex",alignItems:"center",justifyContent:"center",gap:"8px"},children:[(0,i.jsx)(s.Spinner,{})," ",(0,n.__)("Saving…","wp-banana")]})]}):(0,i.jsx)("span",{children:(0,n.__)("No preview selected.","wp-banana")})}),(0,i.jsxs)("div",{style:{display:"flex",gap:"8px"},children:[(0,i.jsx)("button",{type:"button",className:"button button-primary",onClick:a?()=>u(a.id):void 0,disabled:!c||"saving"===a?.status,children:(0,n.__)("Save","wp-banana")}),(0,i.jsx)("button",{type:"button",className:"button",onClick:a?()=>m(a.id):void 0,disabled:!p||"saving"===a?.status,children:(0,n.__)("Discard","wp-banana")})]})]})]})]})},w=({providers:e,restNamespace:t,onComplete:m,defaultGeneratorModel:v,defaultGeneratorProvider:w,aspectRatioOptions:h,defaultAspectRatio:x,enableReferenceDragDrop:y=!1})=>{const[_,R]=(0,a.useState)(""),[j,C]=(0,a.useState)(null),[S,k]=(0,a.useState)(!1),[P,A]=(0,a.useState)(!1),[E,D]=(0,a.useState)(!1),N=(0,a.useCallback)(()=>{C(null)},[]),{fileInputRef:M,referenceImages:O,referenceError:I,setReferenceError:L,referenceCount:G,removeReference:U,handleReferenceSelection:T,triggerReferenceDialog:F,resetReferenceImages:$,prepareReferenceFiles:B,dropOverlayVisible:V}=(({limit:e=4,enableReferenceDragDrop:t=!1,onReferencesChange:r,allowSelection:s})=>{const[i,o]=(0,a.useState)([]),[l,d]=(0,a.useState)(null),[c,p]=(0,a.useState)(!1),u=(0,a.useRef)([]),m=(0,a.useRef)(null),f=(0,a.useRef)(0),v=!1!==s,b=(0,a.useCallback)(e=>{u.current=e,o(e),r&&r()},[r]);(0,a.useEffect)(()=>{u.current=i},[i]),(0,a.useEffect)(()=>()=>{u.current.forEach(e=>{e.revokeOnCleanup&&e.url&&window.URL.revokeObjectURL(e.url)})},[]);const w=(0,a.useCallback)(()=>{u.current.forEach(e=>{e.revokeOnCleanup&&e.url&&window.URL.revokeObjectURL(e.url)}),b([]),d(null)},[b]),h=(0,a.useCallback)(()=>{v&&m.current&&m.current.click()},[v]),x=(0,a.useCallback)(a=>{if(!Array.isArray(a)||0===a.length)return;const t=Array.isArray(u.current)?u.current:[];let r=Math.max(0,e-t.length),s=0,i=0;const o=[];if(a.forEach(e=>{if(!e?.type||!e.type.startsWith("image/"))return;if(i+=1,r<=0)return;const a=`${Date.now()}-${Math.random().toString(36).slice(2)}`,n=window.URL.createObjectURL(e);o.push({id:a,file:e,url:n,revokeOnCleanup:!0,filename:e.name,mimeType:e.type}),r-=1,s+=1}),s>0){const e=[...t,...o];b(e),d(i>s?(0,n.__)("You can upload up to 4 reference images.","wp-banana"):null)}else i>0&&d((0,n.__)("You can upload up to 4 reference images.","wp-banana"))},[b,e]),y=(0,a.useCallback)(e=>{if(!v)return void(e.target.value="");const a=e.target.files;a&&a.length>0&&x(Array.from(a)),e.target.value=""},[x,v]),_=(0,a.useCallback)(e=>{const a=i.filter(a=>a.id!==e||(a.revokeOnCleanup&&a.url&&window.URL.revokeObjectURL(a.url),!1));b(a),d(null)},[i,b]),R=(0,a.useCallback)(async()=>{const e=Array.isArray(u.current)?[...u.current]:[],a=[];let t=!1;for(let r=0;r<e.length;r+=1){const s=e[r];if(s.file instanceof File){a.push(s.file);continue}if(!s.sourceUrl)throw new Error((0,n.__)("Could not load the selected images.","wp-banana"));let i;try{i=await window.fetch(s.sourceUrl,{credentials:"same-origin"})}catch(e){throw new Error((0,n.__)("Could not load the selected images.","wp-banana"))}if(!i.ok)throw new Error((0,n.__)("Could not load the selected images.","wp-banana"));const o=await i.blob(),l=o.type||s.mimeType||"image/png",d=g(s.filename,r+1,l),c=new File([o],d,{type:l});e[r]={...s,file:c,mimeType:l},a.push(c),t=!0}return t&&b(e),u.current=e,a},[b]),j=(0,a.useCallback)(a=>{if(w(),!Array.isArray(a)||0===a.length)return;const t=[];a.slice(0,e).forEach(e=>{if(!e.sourceUrl||0===e.sourceUrl.length)return;const a=`${Date.now()}-${Math.random().toString(36).slice(2)}`,n=e.sourceUrl,r=e.previewUrl&&e.previewUrl.length>0?e.previewUrl:n;t.push({id:a,url:r,sourceUrl:n,filename:e.filename,mimeType:e.mime})}),b(t),a.length>e&&d((0,n.__)("Only the first 4 selected images were attached as references.","wp-banana"))},[b,e,w]);(0,a.useEffect)(()=>{const e=e=>{if(!e)return;const a=window,n=a.wpBananaReferenceQueue;if(!Array.isArray(n)||0===n.length)return;const t=n.indexOf(e);t>=0&&n.splice(t,1),0===n.length&&delete a.wpBananaReferenceQueue},a=a=>{const n=a,t=n.detail?.references;Array.isArray(t)&&0!==t.length?(e(t),j(t)):e(t)};return(()=>{const e=window,a=e.wpBananaReferenceQueue;if(Array.isArray(a)&&0!==a.length){for(;a.length>0;){const e=a.shift();Array.isArray(e)&&e.length>0&&j(e)}delete e.wpBananaReferenceQueue}})(),window.addEventListener("wp-banana:set-reference-images",a),()=>{window.removeEventListener("wp-banana:set-reference-images",a)}},[j]),(0,a.useEffect)(()=>{if(!t||!v)return;const e=e=>{const a=e.dataTransfer?.types;return!!a&&Array.from(a).includes("Files")},a=a=>{e(a)&&(a.preventDefault(),a.stopPropagation(),f.current+=1,p(!0))},n=a=>{e(a)&&(a.preventDefault(),a.stopPropagation(),a.dataTransfer&&(a.dataTransfer.dropEffect="copy"),p(!0))},r=()=>{f.current=0,p(!1)},s=a=>{e(a)&&(a.preventDefault(),a.stopPropagation(),f.current=Math.max(0,f.current-1),0===f.current&&p(!1))},i=a=>{if(!e(a))return;a.preventDefault(),a.stopPropagation();const n=a.dataTransfer,t=n?Array.from(n.files||[]):[];if(t.length>0&&x(t),n)try{n.clearData()}catch(e){}r()},o=a=>{e(a)&&r()};return window.addEventListener("dragenter",a),window.addEventListener("dragover",n),window.addEventListener("dragleave",s),window.addEventListener("drop",i),window.addEventListener("dragend",o),()=>{window.removeEventListener("dragenter",a),window.removeEventListener("dragover",n),window.removeEventListener("dragleave",s),window.removeEventListener("drop",i),window.removeEventListener("dragend",o),r()}},[x,t,v]);const C=(0,a.useMemo)(()=>t&&c,[t,c]);return{fileInputRef:m,referenceImages:i,referenceError:l,setReferenceError:d,referenceCount:i.length,addReferenceFiles:x,removeReference:_,handleReferenceSelection:y,triggerReferenceDialog:h,resetReferenceImages:w,prepareReferenceFiles:R,dropOverlayVisible:C,isDraggingFiles:c}})({enableReferenceDragDrop:y,onReferencesChange:N}),W=G>1,{provider:q,setProvider:H,model:z,setModel:K,modelOptions:Q,modelsLoading:Y,loadError:J,aspectRatio:X,setAspectRatio:Z,aspectRatioEnabled:ee,aspectOptions:ae,connectedProviders:ne,summary:te,modelRequirementSatisfied:re,preferredAspectRatio:se}=(({providers:e,restNamespace:t,defaultGeneratorModel:s,defaultGeneratorProvider:i,aspectRatioOptions:o,defaultAspectRatio:l,referenceCount:d,multiReferenceMode:c,purposeOverride:p})=>{const m=(0,a.useMemo)(()=>e.filter(e=>!1!==e.connected),[e]),g=(0,a.useMemo)(()=>Array.isArray(o)?o.map(e=>"string"==typeof e?e.trim().toUpperCase():"").filter(e=>e.length>0):[],[o]),f=(0,a.useMemo)(()=>{var e;if("string"==typeof l){const e=l.trim().toUpperCase();if(e&&g.includes(e))return e}return null!==(e=g[0])&&void 0!==e?e:""},[g,l]),v=(0,a.useMemo)(()=>{var a,n;if(i){const e=m.find(e=>e.slug===i);if(e)return e.slug}if(s){const a=m.find(e=>e.default_model===s);if(a)return a.slug;const n=e.find(e=>e.default_model===s);if(n){const e=m.find(e=>e.slug===n.slug);if(e)return e.slug}}return null!==(a=null!==(n=m[0]?.slug)&&void 0!==n?n:e[0]?.slug)&&void 0!==a?a:""},[m,e,i,s]),[b,w]=(0,a.useState)(v),[h,x]=(0,a.useState)([]),[y,_]=(0,a.useState)(""),[R,j]=(0,a.useState)(!1),[C,S]=(0,a.useState)(null),[k,P]=(0,a.useState)(f);(0,a.useEffect)(()=>{var e;b&&m.some(e=>e.slug===b)||w(v||(null!==(e=m[0]?.slug)&&void 0!==e?e:""))},[v,b,m]),(0,a.useEffect)(()=>{d>0||0===g.length?""!==k&&P(""):g.includes(k)||f!==k&&P(f)},[g,k,f,d]),(0,a.useEffect)(()=>{if(!b)return void x([]);const e=null!=p?p:d>0?"edit":"generate";let a=!0;return j(!0),S(null),r()({path:`${t}/models?provider=${b}&purpose=${e}`}).then(e=>{if(!a)return;const n=e,t=Array.isArray(n?.models)?n.models:[];x(t),0!==t.length?s&&t.includes(s)?_(s):t.includes(y)||_(t[0]):_("")}).catch(e=>{var t;if(!a)return;const r=null!==(t=e?.message)&&void 0!==t?t:(0,n.__)("Failed to load models.","wp-banana");x([]),S(r),_("")}).finally(()=>{a&&j(!1)}),()=>{a=!1}},[b,t,s,d,p]);const A=(0,a.useMemo)(()=>{var e;if(!c)return h;const a=null!==(e=u[b])&&void 0!==e?e:[];if(0===a.length)return[];const n=new Set(a);return h.filter(e=>n.has(e))},[h,c,b]);(0,a.useEffect)(()=>{R||(0!==A.length?A.includes(y)||_(A[0]):c&&""!==y&&_(""))},[A,y,R,c]);const E=(0,a.useMemo)(()=>e.find(e=>e.slug===b),[b,e]),D=(0,a.useMemo)(()=>{var a;if(E?.label)return E.label;const n=e.find(e=>e.slug===b);return null!==(a=n?.label)&&void 0!==a?a:b?b.toUpperCase():""},[b,e,E]),N=0===d&&g.length>0,M=(0,a.useMemo)(()=>{const e=N?k||(0,n.__)("Default aspect ratio","wp-banana"):"",a=E?.default_model?String(E.default_model):"";let t=y||(R?(0,n.__)("Loading model…","wp-banana"):""!==a?a:(0,n.__)("Provider default model","wp-banana"));c&&0===A.length&&(t=(0,n.__)("No compatible model","wp-banana"));const r=d>0?(0,n.sprintf)((0,n._n)("%d reference","%d references",d,"wp-banana"),d):"";return{aspect:e,model:t,provider:D,references:r,fallback:e||t||D||r?"":(0,n.__)("Using provider defaults","wp-banana")}},[N,k,y,R,E,c,A,d,D]),O=(0,a.useMemo)(()=>A.length>0?""!==y&&A.includes(y):!c&&(""!==y||0===h.length),[A,y,c,h]);return{provider:b,setProvider:w,model:y,setModel:_,models:h,modelOptions:A,modelsLoading:R,loadError:C,aspectRatio:k,setAspectRatio:P,aspectRatioEnabled:N,aspectOptions:g,connectedProviders:m,selectedProviderConfig:E,summary:M,modelRequirementSatisfied:O,preferredAspectRatio:f}})({providers:e,restNamespace:t,defaultGeneratorModel:v,defaultGeneratorProvider:w,aspectRatioOptions:h,defaultAspectRatio:x,referenceCount:G,multiReferenceMode:W}),ie=(0,a.useCallback)(()=>{document.dispatchEvent(new CustomEvent("wp-banana:media-refresh"))},[]),{previewItems:oe,selectedPreview:le,selectedPreviewSrc:de,activePreviewId:ce,setActivePreviewId:pe,previewAction:ue,canSaveSelected:me,canDiscardSelected:ge,resetPreviewArea:fe,startVariations:ve,savePreview:be,discardPreview:we,undoPreview:he}=(({restNamespace:e,dispatchMediaRefresh:t})=>{const[s,i]=(0,a.useState)([]),[o,l]=(0,a.useState)(null),[d,c]=(0,a.useState)(null),p=(0,a.useRef)([]),u=(0,a.useRef)([]),m=(0,a.useRef)(!1),g=(0,a.useRef)({successes:0,errors:[]});(0,a.useEffect)(()=>{p.current=s},[s]);const v=(0,a.useCallback)(()=>{0!==u.current.length&&(u.current.forEach(e=>window.clearTimeout(e)),u.current=[])},[]);(0,a.useEffect)(()=>()=>{m.current=!0,v()},[v]);const b=(0,a.useCallback)(()=>{m.current=!0,v(),i([]),p.current=[],l(null),c(null),g.current={successes:0,errors:[]}},[v]),w=(0,a.useCallback)(e=>{0===e.length&&b()},[b]),h=(0,a.useCallback)(({count:e,prompt:a,multiReferenceMode:t,modelOptions:r,sendGenerateRequest:s,onSuccessReset:o,setReferenceError:d,setSubmitError:p,setIsSubmitting:w})=>{var h;const x=Math.max(1,Math.min(4,e)),y=a.trim();if(y.length<3)return void p((0,n.__)("Please enter a longer prompt.","wp-banana"));if(t&&0===r.length)return void p((0,n.__)("Choose a model that supports multiple reference images.","wp-banana"));m.current=!1,v(),p(null),d(null),c(null),g.current={successes:0,errors:[]};const _=Date.now(),R=Array.from({length:x}).map((e,a)=>({id:`${_}-${a}-${Math.random().toString(36).slice(2,10)}`,index:a,status:"queued"}));i(R),l(null!==(h=R[0]?.id)&&void 0!==h?h:null),w(!0);const j=y,C=R.map((e,a)=>new Promise(t=>{const r=window.setTimeout(async()=>{if(m.current)t();else{i(a=>a.map(a=>a.id===e.id?{...a,status:"loading"}:a));try{var a,r,o,d,p,u,v;const c=await s(j,!0);if(m.current)return void t();const b=c?.preview,w=null!==(a=c?.context)&&void 0!==a?a:{};if(!b?.data)throw new Error((0,n.__)("Failed to generate image.","wp-banana"));const h={provider:null!==(r=w.provider)&&void 0!==r?r:"",model:w.model,format:null!==(o=w.format)&&void 0!==o?o:f(b.mime),prompt:null!==(d=w.prompt)&&void 0!==d?d:j,filenameBase:null!==(p=null!==(u=w.filename_base)&&void 0!==u?u:w.filenameBase)&&void 0!==p?p:"",title:null!==(v=w.title)&&void 0!==v?v:""};i(a=>a.map(a=>{var n,t;return a.id===e.id?{...a,status:"complete",data:null!==(n=b.data)&&void 0!==n?n:"",mime:null!==(t=b.mime)&&void 0!==t?t:"image/png",width:b.width,height:b.height,bytes:b.bytes,context:h,error:void 0}:a})),g.current.successes+=1,l(a=>null!=a?a:e.id)}catch(a){var b;if(m.current)return void t();const r=a,s=null!==(b=r?.message)&&void 0!==b?b:(0,n.__)("Failed to generate image.","wp-banana");g.current.errors.push(s),i(a=>a.map(a=>a.id===e.id?{...a,status:"error",error:s}:a)),c({message:s,type:"error"})}finally{t()}}},1e3*a);u.current.push(r)}));Promise.all(C).then(()=>{v(),m.current||(g.current.successes>0?o():(b(),g.current.errors.length>0&&p(g.current.errors[0])),w(!1))})},[v,b]),x=(0,a.useCallback)(async a=>{const s=p.current.find(e=>e.id===a);if(s&&("complete"===s.status||"error"===s.status)&&s.data&&s.context){c(null),i(e=>e.map(e=>e.id===a?{...e,status:"saving",error:void 0}:e));try{var o;const l=await r()({path:`${e}/generate/save-preview`,method:"POST",data:{data:s.data,provider:s.context.provider,model:null!==(o=s.context.model)&&void 0!==o?o:"",format:s.context.format,mime:s.mime,prompt:s.context.prompt,filename_base:s.context.filenameBase,title:s.context.title}});i(e=>{const n=e.map(e=>e.id===a?{...e,status:"saved",attachmentId:l?.attachment_id,url:l?.url,error:void 0}:e);return w(n),n}),c({message:(0,n.__)("Image saved to Media Library.","wp-banana"),type:"success"}),t()}catch(e){var l;const t=e,r=null!==(l=t?.message)&&void 0!==l?l:(0,n.__)("Failed to save image.","wp-banana");i(e=>e.map(e=>e.id===a?{...e,status:"error",error:r}:e)),c({message:r,type:"error"})}}},[e,w,t]),y=(0,a.useCallback)(e=>{const a=Array.isArray(p.current)?p.current:[],t=a.find(a=>a.id===e)||null,r=a.filter(a=>a.id!==e);if(i(r),p.current=r,0===r.length?l(null):o===e&&l(r[0].id),w(r),t){const e={...t,status:"complete"};c({message:(0,n.__)("Deleted.","wp-banana"),type:"warning",undo:e})}else c({message:(0,n.__)("Deleted.","wp-banana"),type:"warning"})},[o,w]),_=(0,a.useCallback)(()=>{const e=d?.undo;e&&(i(a=>{if(a.some(a=>a.id===e.id))return a;const n=[e,...a];return n.sort((e,a)=>e.index-a.index),n}),l(e.id),c(null))},[d]),R=(0,a.useMemo)(()=>{if(0===s.length)return null;const e=s.find(e=>e.id===o);return null!=e?e:s[0]},[s,o]),j=R&&R.data&&R.mime?`data:${R.mime};base64,${R.data}`:"",C=!!R&&("complete"===R.status||"error"===R.status),S=!!R&&"saving"!==R.status&&"saved"!==R.status;return{previewItems:s,selectedPreview:R,selectedPreviewSrc:j,activePreviewId:o,setActivePreviewId:l,previewAction:d,setPreviewAction:c,canSaveSelected:C,canDiscardSelected:S,resetPreviewArea:b,startVariations:h,savePreview:x,discardPreview:y,undoPreview:_}})({restNamespace:t,dispatchMediaRefresh:ie}),xe=(0,a.useMemo)(()=>!(S||Y||_.trim().length<3||""===q||!re||ee&&""===X),[S,Y,_,q,re,ee,X]),ye=(0,a.useCallback)(async(e,a)=>{if(G>0){let s=[];try{s=await B()}catch(e){throw L((0,n.__)("Could not load the selected images.","wp-banana")),e}const i=new window.FormData;return i.append("prompt",e),i.append("provider",q),z&&i.append("model",z),a&&i.append("preview_only","1"),s.forEach(e=>{i.append("reference_images[]",e,e.name)}),r()({path:`${t}/generate`,method:"POST",body:i})}const s={prompt:e,provider:q};return z&&(s.model=z),ee&&X&&(s.aspect_ratio=X),a&&(s.preview_only="1"),r()({path:`${t}/generate`,method:"POST",data:s})},[G,B,L,q,z,t,ee,X]),_e=(0,a.useCallback)(async()=>{const e=_.trim();if(e.length<3)C((0,n.__)("Please enter a longer prompt.","wp-banana"));else if(W&&0===Q.length)C((0,n.__)("Choose a model that supports multiple reference images.","wp-banana"));else{C(null),L(null),k(!0);try{await ye(e,!1),R(""),ee&&Z(se),A(!1),$(),ie(),m()}catch(e){const a=e;a?.message?C(a.message):e instanceof Error&&e.message?C(e.message):C((0,n.__)("Failed to generate image.","wp-banana"))}finally{k(!1)}}},[_,W,Q,L,ye,ee,se,$,ie,m]),Re=(0,a.useCallback)(e=>{"Enter"===e.key&&(e.metaKey||e.ctrlKey)&&(e.preventDefault(),xe&&!S&&_e())},[xe,S,_e]),je=(0,a.useRef)(null);(0,a.useEffect)(()=>{if(!E)return;const e=e=>{je.current&&e.target instanceof Node&&!je.current.contains(e.target)&&D(!1)};return document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[E]);const Ce=(0,a.useCallback)(()=>{!S&&xe&&D(e=>!e)},[S,xe]),Se=(0,a.useCallback)(()=>{R(""),ee&&Z(se),$(),A(!1)},[ee,se,$]),ke=(0,a.useCallback)(e=>{D(!1),S||ve({count:e,prompt:_,multiReferenceMode:W,modelOptions:Q,sendGenerateRequest:ye,onSuccessReset:Se,setReferenceError:L,setSubmitError:C,setIsSubmitting:k})},[S,ve,_,W,Q,ye,Se,L,C]),Pe=(0,i.jsx)(c,{isOpen:E,options:p,onSelect:ke});return(0,i.jsx)(s.Card,{children:(0,i.jsxs)(s.CardBody,{children:[J&&(0,i.jsx)(s.Notice,{status:"error",isDismissible:!1,children:J}),j&&(0,i.jsx)(s.Notice,{status:"error",isDismissible:!1,children:j}),I&&(0,i.jsx)(s.Notice,{status:"warning",isDismissible:!1,children:I}),W&&!Y&&0===Q.length&&(0,i.jsx)(s.Notice,{status:"warning",isDismissible:!1,children:(0,n.__)("Switch to a supported model to send multiple reference images.","wp-banana")}),(0,i.jsx)(o,{prompt:_,onPromptChange:R,onPromptKeyDown:Re,isSubmitting:S,canSubmit:xe,onSubmit:_e,onReferenceClick:F,showOptions:P,onToggleOptions:()=>A(e=>!e),summary:te,variationMenuRef:je,onVariationToggle:Ce,isVariationMenuOpen:E,variationMenu:Pe,enableReferenceDragDrop:y,dropOverlayVisible:V}),(0,i.jsx)(d,{referenceImages:O,onRemove:U,fileInputRef:M,onReferenceSelection:T}),(0,i.jsx)(l,{show:P,connectedProviders:ne,provider:q,onProviderChange:H,model:z,onModelChange:K,modelOptions:Q,modelsLoading:Y,aspectRatioEnabled:ee,aspectRatio:X,onAspectRatioChange:Z,aspectOptions:ae,isSubmitting:S}),(0,i.jsx)(b,{previewItems:oe,selectedPreview:le,selectedPreviewSrc:de,onSelect:pe,previewAction:ue,onUndo:he,onClear:fe,canSaveSelected:me,canDiscardSelected:ge,onSave:be,onDiscard:we})]})})};let h=null;const x=e=>{e.innerHTML="";const a=document.createElement("div");a.className="notice notice-warning";const t=document.createElement("p");t.textContent=(0,n.__)("No connected providers available. Add a key in Settings → AI Images.","wp-banana"),a.appendChild(t),e.appendChild(a)},y=()=>{const e=document.getElementById("wp-banana-generate-page");if(!e)return;const n=window.wpBananaGeneratePage;if(!n||!Array.isArray(n.providers))return void x(e);const t=n.providers.filter(e=>!1!==e.connected);0!==t.length?((e,n)=>{const t=window.wp?.element,r=()=>{n.redirectUrl?window.location.href=n.redirectUrl:window.location.reload()};if("function"==typeof t?.createRoot)return h||(h=t.createRoot(e)),void h.render((0,i.jsx)(w,{providers:n.providers,restNamespace:n.restNamespace,onComplete:r,defaultGeneratorModel:n.defaultGeneratorModel,defaultGeneratorProvider:n.defaultGeneratorProvider,defaultAspectRatio:n.defaultAspectRatio,aspectRatioOptions:n.aspectRatioOptions,enableReferenceDragDrop:!0}));(0,a.render)((0,i.jsx)(w,{providers:n.providers,restNamespace:n.restNamespace,onComplete:r,defaultGeneratorModel:n.defaultGeneratorModel,defaultGeneratorProvider:n.defaultGeneratorProvider,defaultAspectRatio:n.defaultAspectRatio,aspectRatioOptions:n.aspectRatioOptions,enableReferenceDragDrop:!0}),e)})(e,{restNamespace:n.restNamespace,providers:t,redirectUrl:n.redirectUrl,defaultGeneratorModel:n.defaultGeneratorModel,defaultGeneratorProvider:n.defaultGeneratorProvider,defaultAspectRatio:n.defaultAspectRatio,aspectRatioOptions:n.aspectRatioOptions}):x(e)};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",y):y()})();