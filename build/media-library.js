(()=>{"use strict";var e={n:t=>{var n=t&&t.__esModule?()=>t.default:()=>t;return e.d(n,{a:n}),n},d:(t,n)=>{for(var a in n)e.o(n,a)&&!e.o(t,a)&&Object.defineProperty(t,a,{enumerable:!0,get:n[a]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const t=window.wp.element,n=window.wp.i18n,a=window.React,r=window.wp.apiFetch;var i=e.n(r);const o=window.wp.components,s=window.ReactJSXRuntime,l={gemini:["gemini-2.5-flash-image-preview"],openai:["gpt-image-1"],replicate:["google/nano-banana","bytedance/seedream-4"]},d={"image/jpeg":"jpg","image/jpg":"jpg","image/png":"png","image/webp":"webp"},c=(e,t,n)=>{var a;const r=`reference-${t}`,i=e&&e.trim().length>0?e.trim():r,o=null!==(a=d[n.toLowerCase()])&&void 0!==a?a:"";if(""===o)return i;if(i.toLowerCase().endsWith(`.${o}`))return i;const s=i.lastIndexOf(".");return s>0?`${i.slice(0,s)}.${o}`:`${i}.${o}`},p=({providers:e,restNamespace:r,onComplete:d,defaultGeneratorModel:p,defaultGeneratorProvider:u,aspectRatioOptions:m,defaultAspectRatio:f,enableReferenceDragDrop:h=!1})=>{const b=(0,t.useMemo)(()=>e.filter(e=>!1!==e.connected),[e]),g=(0,t.useMemo)(()=>Array.isArray(m)?m.map(e=>"string"==typeof e?e.trim().toUpperCase():"").filter(e=>e.length>0):[],[m]),w=(0,t.useMemo)(()=>{var e;if("string"==typeof f){const e=f.trim().toUpperCase();if(e&&g.includes(e))return e}return null!==(e=g[0])&&void 0!==e?e:""},[g,f]),y=(0,t.useMemo)(()=>{var t;if(u){const e=b.find(e=>e.slug===u);if(e)return e.slug}if(p){const t=b.find(e=>e.default_model===p);if(t)return t.slug;const n=e.find(e=>e.default_model===p);if(n){const e=b.find(e=>e.slug===n.slug);if(e)return e.slug}}return b.length>0?b[0].slug:null!==(t=e[0]?.slug)&&void 0!==t?t:""},[b,e,u,p]),[v,_]=(0,t.useState)(y),[x,E]=(0,t.useState)(""),[C,k]=(0,t.useState)([]),[j,A]=(0,t.useState)(""),[S,N]=(0,t.useState)(!1),[L,R]=(0,t.useState)(null),[M,I]=(0,t.useState)(null),[O,P]=(0,t.useState)(!1),[$,D]=(0,t.useState)(w),[T,U]=(0,t.useState)(!1),[B,F]=(0,t.useState)([]),[G,q]=(0,t.useState)(null),[H,W]=(0,t.useState)(!1),J=(0,a.useRef)(null),Q=(0,a.useRef)(B),z=(0,a.useRef)(0),K=B.length,V=K>1,Y=(0,t.useMemo)(()=>{var e;if(!V)return C;const t=null!==(e=l[v])&&void 0!==e?e:[];if(0===t.length)return[];const n=new Set(t);return C.filter(e=>n.has(e))},[C,V,v]),X=0===K&&g.length>0;(0,t.useEffect)(()=>{Q.current=B},[B]),(0,t.useEffect)(()=>()=>{Q.current.forEach(e=>{e.revokeOnCleanup&&e.url&&window.URL.revokeObjectURL(e.url)})},[]);const Z=(0,a.useCallback)(()=>{Q.current.forEach(e=>{e.revokeOnCleanup&&e.url&&window.URL.revokeObjectURL(e.url)}),F([]),q(null)},[]),ee=(0,a.useCallback)(e=>{if(E(""),I(null),Z(),!Array.isArray(e)||0===e.length)return;const t=[];e.slice(0,4).forEach(e=>{if(!e.sourceUrl||0===e.sourceUrl.length)return;const n=`${Date.now()}-${Math.random().toString(36).slice(2)}`,a=e.sourceUrl,r=e.previewUrl&&e.previewUrl.length>0?e.previewUrl:a;t.push({id:n,url:r,sourceUrl:a,filename:e.filename,mimeType:e.mime})}),F(t),Q.current=t,e.length>4&&q((0,n.__)("Only the first 4 selected images were attached as references.","wp-banana"))},[Z]);(0,t.useEffect)(()=>{const e=e=>{if(!e)return;const t=window,n=t.wpBananaReferenceQueue;if(!Array.isArray(n)||0===n.length)return;const a=n.indexOf(e);a>=0&&n.splice(a,1),0===n.length&&delete t.wpBananaReferenceQueue},t=t=>{const n=t,a=n.detail?.references;Array.isArray(a)&&0!==a.length?(e(a),ee(a)):e(a)};return(()=>{const e=window,t=e.wpBananaReferenceQueue;if(Array.isArray(t)&&0!==t.length){for(;t.length>0;){const e=t.shift();Array.isArray(e)&&e.length>0&&ee(e)}delete e.wpBananaReferenceQueue}})(),window.addEventListener("wp-banana:set-reference-images",t),()=>{window.removeEventListener("wp-banana:set-reference-images",t)}},[ee]),(0,t.useEffect)(()=>{K>0?""!==$&&D(""):0!==g.length?g.includes($)||w!==$&&D(w):""!==$&&D("")},[g,$,w,K]);const te=(0,t.useMemo)(()=>e.find(e=>e.slug===v),[v,e]),ne=(0,t.useMemo)(()=>{var t;if(te?.label)return te.label;const n=e.find(e=>e.slug===v);return null!==(t=n?.label)&&void 0!==t?t:v?v.toUpperCase():""},[v,e,te]),ae=(0,t.useMemo)(()=>{const e=X?$||(0,n.__)("Default aspect ratio","wp-banana"):"",t=te?.default_model?String(te.default_model):"";let a=j||(S?(0,n.__)("Loading modelâ€¦","wp-banana"):""!==t?t:(0,n.__)("Provider default model","wp-banana"));V&&0===Y.length&&(a=(0,n.__)("No compatible model","wp-banana"));const r=ne,i=K>0?(0,n.sprintf)((0,n._n)("%d reference","%d references",K,"wp-banana"),K):"";return{aspect:e,model:a,provider:r,references:i,fallback:e||a||r||i?"":(0,n.__)("Using provider defaults","wp-banana")}},[X,$,j,S,ne,te,V,Y,K]);(0,t.useEffect)(()=>{v&&b.some(e=>e.slug===v)||y&&_(y)},[y,v,b]),(0,t.useEffect)(()=>{if(!v)return;const e=K>0?"edit":"generate";let t=!0;return N(!0),R(null),i()({path:`${r}/models?provider=${v}&purpose=${e}`}).then(e=>{if(!t)return;const n=e,a=Array.isArray(n.models)?n.models:[];if(k(a),0===a.length)return void A("");const r=(K>0?[te?.default_model]:[p,te?.default_model]).find(e=>!!e&&a.includes(e));A(r||a[0])}).catch(e=>{var a;t&&(k([]),A(""),R(null!==(a=e?.message)&&void 0!==a?a:(0,n.__)("Failed to load models.","wp-banana")))}).finally(()=>{t&&N(!1)}),()=>{t=!1}},[v,r,te,p,K]),(0,t.useEffect)(()=>{S||(0!==Y.length?Y.includes(j)||A(Y[0]):V&&""!==j&&A(""))},[Y,j,S,V]);const re=(0,t.useMemo)(()=>Y.length>0?""!==j&&Y.includes(j):!V&&(""!==j||0===C.length),[Y,j,V,C]),ie=(0,t.useMemo)(()=>!(O||S||x.trim().length<3||""===v||!re||X&&""===$),[O,S,x,v,re,X,$]),oe=(0,a.useCallback)(()=>{J.current&&J.current.click()},[]),se=(0,a.useCallback)(e=>{if(!Array.isArray(e)||0===e.length)return;const t=Array.isArray(Q.current)?Q.current:[];let a=Math.max(0,4-t.length),r=0,i=0;const o=[];if(e.forEach(e=>{if(!e?.type||!e.type.startsWith("image/"))return;if(i+=1,a<=0)return;const t=`${Date.now()}-${Math.random().toString(36).slice(2)}`,n=window.URL.createObjectURL(e);o.push({id:t,file:e,url:n,revokeOnCleanup:!0,filename:e.name,mimeType:e.type}),a-=1,r+=1}),r>0){const e=[...t,...o];Q.current=e,F(e),I(null),q(i>r?(0,n.__)("You can upload up to 4 reference images.","wp-banana"):null)}else i>0&&q((0,n.__)("You can upload up to 4 reference images.","wp-banana"))},[F,I,q]),le=(0,a.useCallback)(e=>{const t=e.target.files;t&&t.length>0&&se(Array.from(t)),e.target.value=""},[se]),de=(0,a.useCallback)(e=>{const t=B.filter(t=>t.id!==e||(t.revokeOnCleanup&&t.url&&window.URL.revokeObjectURL(t.url),!1));F(t),q(null)},[B]);(0,t.useEffect)(()=>{if(!h)return;const e=e=>{const t=e.dataTransfer?.types;return!!t&&Array.from(t).includes("Files")},t=t=>{e(t)&&(t.preventDefault(),t.stopPropagation(),z.current+=1,W(!0))},n=t=>{e(t)&&(t.preventDefault(),t.stopPropagation(),t.dataTransfer&&(t.dataTransfer.dropEffect="copy"),W(!0))},a=()=>{z.current=0,W(!1)},r=t=>{e(t)&&(t.preventDefault(),t.stopPropagation(),z.current=Math.max(0,z.current-1),0===z.current&&W(!1))},i=t=>{if(!e(t))return;t.preventDefault(),t.stopPropagation();const n=t.dataTransfer,r=n?Array.from(n.files||[]):[];if(r.length>0&&se(r),n)try{n.clearData()}catch(e){}a()},o=t=>{e(t)&&a()};return window.addEventListener("dragenter",t),window.addEventListener("dragover",n),window.addEventListener("dragleave",r),window.addEventListener("drop",i),window.addEventListener("dragend",o),()=>{window.removeEventListener("dragenter",t),window.removeEventListener("dragover",n),window.removeEventListener("dragleave",r),window.removeEventListener("drop",i),window.removeEventListener("dragend",o),z.current=0,W(!1)}},[se,h]);const ce=async()=>{const e=x.trim();if(e.length<3)I((0,n.__)("Please enter a longer prompt.","wp-banana"));else if(V&&0===Y.length)I((0,n.__)("Choose a model that supports multiple reference images.","wp-banana"));else{I(null),q(null),P(!0);try{if(K>0){const t=async()=>{const e=[...B],t=[];let a=!1;for(let r=0;r<e.length;r+=1){const i=e[r];if(i.file instanceof File){t.push(i.file);continue}if(!i.sourceUrl)throw new Error((0,n.__)("Could not load the selected images.","wp-banana"));let o;try{o=await window.fetch(i.sourceUrl,{credentials:"same-origin"})}catch(e){throw new Error((0,n.__)("Could not load the selected images.","wp-banana"))}if(!o.ok)throw new Error((0,n.__)("Could not load the selected images.","wp-banana"));const s=await o.blob(),l=s.type||i.mimeType||"image/png",d=c(i.filename,r+1,l),p=new File([s],d,{type:l});e[r]={...i,file:p,mimeType:l},t.push(p),a=!0}return a&&F(e),Q.current=e,t};let a=[];try{a=await t()}catch(e){throw q((0,n.__)("Could not load the selected images.","wp-banana")),e}const o=new window.FormData;o.append("prompt",e),o.append("provider",v),j&&o.append("model",j),a.forEach(e=>{o.append("reference_images[]",e,e.name)}),await i()({path:`${r}/generate`,method:"POST",body:o})}else{const t={prompt:e,provider:v};j&&(t.model=j),X&&$&&(t.aspect_ratio=$),await i()({path:`${r}/generate`,method:"POST",data:t})}E(""),X&&D(w),U(!1),Z(),d()}catch(e){var t;const a=e;I(null!==(t=a?.message)&&void 0!==t?t:(0,n.__)("Failed to generate image.","wp-banana"))}finally{P(!1)}}},pe=(0,a.useCallback)(e=>{"Enter"===e.key&&(e.metaKey||e.ctrlKey)&&(e.preventDefault(),ie&&!O&&ce())},[ie,O,ce]),ue=h&&H;return(0,s.jsxs)(s.Fragment,{children:[h&&(0,s.jsx)("div",{className:"uploader-window wp-banana-generate-page__drop-overlay",style:{display:ue?"block":"none",opacity:ue?1:0},"aria-hidden":"true",children:(0,s.jsx)("div",{className:"uploader-window-content",children:(0,s.jsx)("div",{className:"uploader-editor-title",children:(0,n.__)("Drop files to attach","wp-banana")})})}),(0,s.jsx)(o.Card,{children:(0,s.jsxs)(o.CardBody,{children:[L&&(0,s.jsx)(o.Notice,{status:"error",isDismissible:!1,children:L}),M&&(0,s.jsx)(o.Notice,{status:"error",isDismissible:!1,children:M}),G&&(0,s.jsx)(o.Notice,{status:"warning",isDismissible:!1,children:G}),V&&!S&&0===Y.length&&(0,s.jsx)(o.Notice,{status:"warning",isDismissible:!1,children:(0,n.__)("Switch to a supported model to send multiple reference images.","wp-banana")}),(0,s.jsxs)("div",{className:"wp-banana-generate-panel__prompt",style:{position:"relative",marginBottom:"8px"},children:[(0,s.jsx)(o.TextareaControl,{label:(0,n.__)("Describe the image","wp-banana"),value:x,onChange:E,onKeyDown:pe,rows:5,placeholder:(0,n.__)("A cat surfing a wave at sunsetâ€¦","wp-banana"),disabled:O}),(0,s.jsx)("button",{type:"button",className:"button button-secondary button-small wp-banana-generate-panel__reference-picker",onClick:oe,disabled:O,"aria-label":(0,n.__)("Add reference images","wp-banana"),style:{position:"absolute",top:"24px",right:"0",lineHeight:"20px",padding:"0 4px",border:"none",borderRadius:0,background:"transparent"},children:(0,s.jsx)("span",{className:"dashicons dashicons-paperclip","aria-hidden":"true"})}),(0,s.jsx)("input",{ref:J,type:"file",accept:"image/png,image/jpeg,image/webp",multiple:!0,onChange:le,style:{display:"none"}})]}),B.length>0&&(0,s.jsx)("div",{className:"wp-banana-generate-panel__reference-list",style:{display:"flex",gap:"8px",marginBottom:"16px",flexWrap:"wrap"},children:B.map(e=>(0,s.jsxs)("div",{style:{position:"relative",width:"72px",height:"72px",overflow:"hidden",borderRadius:"4px",border:"1px solid #dcdcde"},children:[(0,s.jsx)("img",{src:e.url,alt:"",style:{width:"100%",height:"100%",objectFit:"cover"}}),(0,s.jsx)("button",{type:"button",className:"button-link wp-banana-generate-panel__reference-remove",onClick:()=>de(e.id),"aria-label":(0,n.__)("Remove reference image","wp-banana"),style:{position:"absolute",top:"2px",right:"2px",display:"inline-flex",alignItems:"center",justifyContent:"center",width:"22px",height:"22px",background:"rgba(0,0,0,0.55)",color:"#fff",borderRadius:"3px",textDecoration:"none"},children:(0,s.jsx)("span",{className:"dashicons dashicons-no"})})]},e.id))}),T&&b.length>1&&(0,s.jsx)(o.SelectControl,{label:(0,n.__)("Provider","wp-banana"),value:v,onChange:e=>_(e),options:b.map(e=>({label:e.label,value:e.slug})),disabled:O}),T&&(0,s.jsx)(o.SelectControl,{label:(0,n.__)("Model","wp-banana"),value:j,onChange:e=>A(e),disabled:S||0===Y.length||O,options:Y.length>0?Y.map(e=>({label:e,value:e})):[{label:(0,n.__)("No models available","wp-banana"),value:""}]}),T&&X&&(0,s.jsx)(o.SelectControl,{label:(0,n.__)("Aspect ratio","wp-banana"),value:$,onChange:e=>D(e),disabled:O,options:g.map(e=>({label:e,value:e}))}),S&&(0,s.jsxs)("div",{className:"wp-banana-generate-panel__spinner",style:{display:"flex",alignItems:"center",gap:"8px"},children:[(0,s.jsx)(o.Spinner,{})," ",(0,n.__)("Loading modelsâ€¦","wp-banana")]}),(0,s.jsxs)("div",{className:"wp-banana-generate-panel__actions",style:{marginTop:"16px",display:"flex",flexWrap:"wrap",alignItems:"center",gap:"12px",justifyContent:"space-between"},children:[(0,s.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"12px"},children:[(0,s.jsx)("button",{type:"button",className:"button button-primary wp-banana-generate-panel__submit",onClick:ce,disabled:!ie||O,children:(0,n.__)("Generate Image","wp-banana")}),O&&(0,s.jsx)("span",{className:"spinner is-active","aria-hidden":"true"})]}),(0,s.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"8px",flexWrap:"wrap",textAlign:"right"},children:[ae.fallback?(0,s.jsx)("span",{children:ae.fallback}):(0,s.jsxs)("span",{children:[ae.aspect&&(0,s.jsxs)("span",{children:[ae.aspect," â€” "]}),(0,s.jsx)("code",{children:ae.model}),ae.provider&&(0,s.jsxs)("span",{children:[" (",ae.provider,")"]}),ae.references&&(0,s.jsxs)("span",{children:[" - ",ae.references]})]}),(0,s.jsx)("button",{type:"button",className:"button-link",onClick:()=>U(!T),children:T?(0,n.__)("Hide options","wp-banana"):(0,n.__)("Change","wp-banana")})]})]})]})})]})};let u=null;const m=()=>{if("upload"!==window.pagenow)return;const e=window.wpBananaMedia;if(!e||!Array.isArray(e.providers)||0===e.providers.length)return;const a=e.providers.filter(e=>!1!==e.connected);if(0===a.length)return;const r=document.querySelector("#wpbody-content .wrap");if(!r)return;const i=r.querySelector(".page-title-action"),o=document.createElement("button");if(o.type="button",o.className="page-title-action wp-banana-generate-toggle",o.textContent=(0,n.__)("Generate Image","wp-banana"),o.setAttribute("aria-expanded","false"),i&&i.parentNode)i.insertAdjacentElement("afterend",o);else{const e=r.querySelector(".wp-heading-inline");e?e.insertAdjacentElement("afterend",o):r.prepend(o)}const l=document.createElement("div");l.id="wp-banana-generate-panel",l.className="wp-banana-generate-panel",l.style.display="none",l.style.marginTop="12px",l.style.width="100%",l.style.maxWidth="none",l.style.boxSizing="border-box";const d=r.querySelector(".wp-header-end");d?d.insertAdjacentElement("afterend",l):o.nextElementSibling?o.insertAdjacentElement("afterend",l):r.appendChild(l),o.setAttribute("aria-controls",l.id);let c=!1;const m=()=>{c||(((e,n)=>{const a=window.wp?.element;if("function"==typeof a?.createRoot)return u||(u=a.createRoot(e)),void u.render((0,s.jsx)(p,{providers:n.providers,restNamespace:n.restNamespace,onComplete:()=>window.location.reload(),defaultGeneratorModel:n.defaultGeneratorModel,defaultGeneratorProvider:n.defaultGeneratorProvider,defaultAspectRatio:n.defaultAspectRatio,aspectRatioOptions:n.aspectRatioOptions}));(0,t.render)((0,s.jsx)(p,{providers:n.providers,restNamespace:n.restNamespace,onComplete:()=>window.location.reload(),defaultGeneratorModel:n.defaultGeneratorModel,defaultGeneratorProvider:n.defaultGeneratorProvider,defaultAspectRatio:n.defaultAspectRatio,aspectRatioOptions:n.aspectRatioOptions}),e)})(l,{restNamespace:e.restNamespace,providers:a,defaultGeneratorModel:e.defaultGeneratorModel,defaultGeneratorProvider:e.defaultGeneratorProvider,defaultAspectRatio:e.defaultAspectRatio,aspectRatioOptions:e.aspectRatioOptions}),c=!0),l.style.display="block",o.setAttribute("aria-expanded","true"),o.classList.add("wp-banana-generate-toggle--open"),(()=>{const e=l.querySelector("textarea");e&&e.focus()})()};o.addEventListener("click",e=>{if(e.stopPropagation(),e.stopImmediatePropagation(),"block"===l.style.display)return l.style.display="none",o.setAttribute("aria-expanded","false"),void o.classList.remove("wp-banana-generate-toggle--open");m()}),(()=>{let e=null,t=null,a=null,i=null,o=0;const s=window,d=["add","remove","reset","update"],c=()=>!!(()=>{var a;if(e)return!0;const i=r.querySelector(".media-toolbar-secondary"),o=null!==(a=i?.querySelector(".delete-selected-button"))&&void 0!==a?a:null;if(!i||!o)return!1;const c=s.wp?.media?.frame;if(!c)return!1;const p="function"==typeof c.state?c.state():null;if(!p||"function"!=typeof p.get)return!1;const u=p.get("selection");if(!u)return!1;e=document.createElement("button"),e.type="button",e.className="button media-button button-primary button-large wp-banana-bulk-variant-button hidden",e.textContent=(0,n.__)("Create AI Variant","wp-banana"),e.disabled=!0,o.insertAdjacentElement("beforebegin",e);const f=()=>{const t=(()=>{if("number"==typeof u.length)return u.length;const e=u.models;return Array.isArray(e)?e.length:0})();if(o.classList.contains("hidden")||o.hasAttribute("hidden")||null===o.offsetParent)return e?.classList.add("hidden"),void(e&&(e.disabled=!0));e?.classList.remove("hidden"),e&&(e.disabled=0===t,e.textContent=t>1?(0,n.__)("Combine with AI","wp-banana"):(0,n.__)("Create AI Variant","wp-banana"))};return"function"==typeof u.on&&d.forEach(e=>{u.on(e,f)}),t=new MutationObserver(()=>{f()}),t.observe(o,{attributes:!0,attributeFilter:["class","style","hidden","disabled","aria-hidden"]}),e.addEventListener("click",()=>{const e=("function"==typeof u.toArray?u.toArray():null!==(t=u.models)&&void 0!==t?t:[]).map(e=>{var t;return e?"function"==typeof e.toJSON?e.toJSON():null!==(t=e.attributes)&&void 0!==t?t:null:null}).filter(e=>!!e);var t;if(0===e.length)return;const a=e.filter(e=>("string"==typeof e.mime?e.mime:"string"==typeof e.type&&"string"==typeof e.subtype?`${e.type}/${e.subtype}`:"").startsWith("image/"));if(0===a.length)return void window.alert((0,n.__)("Selected items must be images to use them as AI references.","wp-banana"));a.length>4&&window.alert((0,n.__)("Select up to four images for AI references.","wp-banana"));const r=a.slice(0,4),i=[];r.forEach(e=>{const t="string"==typeof e.mime?e.mime:"string"==typeof e.type&&"string"==typeof e.subtype?`${e.type}/${e.subtype}`:void 0,n="string"==typeof e.filename?e.filename:void 0,a="string"==typeof e.url?e.url:void 0;if(!a)return;const r=e.sizes&&"object"==typeof e.sizes?e.sizes:void 0,o=["medium","large","thumbnail","full"].map(e=>r?.[e]?.url).find(e=>"string"==typeof e&&e.length>0),s=null!=o?o:a;i.push({attachmentId:"number"==typeof e.id?e.id:parseInt(String(e.id),10)||void 0,sourceUrl:a,previewUrl:s,filename:n,mime:t})}),0!==i.length?((e=>{const t=window;Array.isArray(t.wpBananaReferenceQueue)||(t.wpBananaReferenceQueue=[]),t.wpBananaReferenceQueue.push(e),window.dispatchEvent(new CustomEvent("wp-banana:set-reference-images",{detail:{references:e}}))})(i),m(),l.scrollIntoView({behavior:"smooth",block:"start"})):window.alert((0,n.__)("Unable to load the selected images.","wp-banana"))}),f(),!0})()&&(a&&(a.disconnect(),a=null),null!==i&&(window.clearInterval(i),i=null),!0);if(c())return;a=new MutationObserver(()=>{c()}),a.observe(r,{childList:!0,subtree:!0});const p=r.querySelector(".select-mode-toggle");p&&p.addEventListener("click",()=>{window.setTimeout(()=>{c()},0)}),i=window.setInterval(()=>{o+=1,(c()||o>40)&&null!==i&&(window.clearInterval(i),i=null)},250)})()};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",m):m();const f={generate:(0,n.__)("Generated","wp-banana"),edit:(0,n.__)("Edited","wp-banana")},h={new:(0,n.__)("New copy","wp-banana"),replace:(0,n.__)("Replaced original","wp-banana"),save_as:(0,n.__)("Saved as copy","wp-banana"),buffer:(0,n.__)("Buffered edit","wp-banana")},b=(e,t,n)=>{const a=document.createElement("div");a.className=e;const r=document.createElement("strong");return r.textContent=t,a.appendChild(r),a.appendChild(document.createTextNode(" ")),n.forEach(e=>{"string"!=typeof e?a.appendChild(e):a.appendChild(document.createTextNode(e))}),a},g=e=>{if("number"==typeof e&&Number.isFinite(e))return e;if("string"==typeof e){const t=parseInt(e,10);if(!Number.isNaN(t))return t}return null},w=e=>{const t=e?.el;if(!(t&&t instanceof HTMLElement))return;const a=t.querySelector(".details");if(!a)return;const r=a.querySelector(".wp-banana-ai-details");r&&r.remove();const i=e?.model?.toJSON?e.model.toJSON():null;if(!i||"object"!=typeof i)return;const o=i.wpBanana;if(!o)return;if(!Boolean(o.isGenerated||o.derivedFrom||o.historyCount&&o.historyCount>0||o.lastPrompt&&""!==o.lastPrompt.trim()))return;const s=document.createElement("div");s.className="wp-banana-ai-details";const l=g(i.id),d=g(o.derivedFrom?.id),c=null!==l&&null!==d&&l===d;if(o.derivedFrom&&o.derivedFrom.id&&!c){var p;const e=document.createElement("a");e.href=o.derivedFrom.editLink||o.derivedFrom.viewLink||"#",e.textContent=null!==(p=o.derivedFrom.title)&&void 0!==p?p:`#${o.derivedFrom.id}`,e.target="_blank",e.rel="noopener noreferrer";const t=b("wp-banana-ai-details__item",(0,n.__)("Derived from:","wp-banana"),[e]);s.appendChild(t)}if(o.historyCount&&o.historyCount>0&&Array.isArray(o.history)){const e=document.createElement("button");e.type="button",e.className="button-link wp-banana-history-toggle";const t=(0,n.sprintf)((0,n._n)("View history (%d entry)","View history (%d entries)",o.historyCount,"wp-banana"),o.historyCount),a=(0,n.__)("Hide history","wp-banana");e.textContent=t,e.setAttribute("aria-expanded","false");const r=(e=>{const t=document.createElement("div");t.className="wp-banana-history-list";const a=document.createElement("ul");a.className="wp-banana-history-list__items";const r=[...e].reverse();if(r.forEach(e=>{var t;const r=document.createElement("li");r.className="wp-banana-history-list__item";const i=[],o=e.type?null!==(t=f[e.type])&&void 0!==t?t:e.type:"";o&&i.push(o);const s=e.provider?(e=>{var t;if(!e)return"";const n=(()=>{const e=window;return e.wpBananaMedia&&Array.isArray(e.wpBananaMedia.providers)?e.wpBananaMedia.providers:[]})().find(t=>t.slug===e);return null!==(t=n?.label)&&void 0!==t?t:e})(e.provider):"";if(s&&i.push((0,n.sprintf)((0,n.__)("via %s","wp-banana"),s)),e.model&&i.push(e.model),e.mode){var l;const t=null!==(l=h[e.mode])&&void 0!==l?l:e.mode;i.push(t)}if(i.length>0){const e=document.createElement("span");e.className="wp-banana-history-list__summary",e.textContent=i.join(", "),e.style.display="block",r.appendChild(e)}const d=[],c=(e=>{if(!e||Number.isNaN(e))return"";try{const t=new Date(1e3*e);return new Intl.DateTimeFormat(void 0,{year:"numeric",month:"short",day:"2-digit",hour:"numeric",minute:"2-digit"}).format(t)}catch(e){return""}})(e.timestamp);if(c&&d.push(c),e.user?.name&&d.push((0,n.sprintf)((0,n.__)("by %s","wp-banana"),e.user.name)),d.length>0){const e=document.createElement("span");e.className="wp-banana-history-list__meta",e.textContent=d.join(" Â· "),r.appendChild(e)}if(e.derivedFrom&&e.derivedFrom.id){var p;const t=document.createElement("div");t.className="wp-banana-history-list__derived";const a=document.createElement("a");a.href=e.derivedFrom.editLink||e.derivedFrom.viewLink||"#",a.textContent=null!==(p=e.derivedFrom.title)&&void 0!==p?p:`#${e.derivedFrom.id}`,a.target="_blank",a.rel="noopener noreferrer",t.appendChild(document.createTextNode((0,n.__)("Source:","wp-banana")+" ")),t.appendChild(a),r.appendChild(t)}if(e.prompt&&""!==e.prompt.trim()){const t=document.createElement("div");t.className="wp-banana-history-list__prompt",t.textContent=e.prompt.trim(),r.appendChild(t)}a.appendChild(r)}),0===r.length){const e=document.createElement("li");e.className="wp-banana-history-list__item is-empty",e.textContent=(0,n.__)("No AI history events recorded yet.","wp-banana"),a.appendChild(e)}return t.appendChild(a),t})(o.history);r.style.display="none",e.addEventListener("click",n=>{n.preventDefault();const i=!("true"===e.getAttribute("aria-expanded"));e.setAttribute("aria-expanded",i?"true":"false"),e.textContent=i?a:t,r.style.display=i?"block":"none"});const i=b("wp-banana-ai-details__item wp-banana-ai-details__history",(0,n.__)("AI history:","wp-banana"),[e]);i.appendChild(r),s.appendChild(i)}else if(!1===o.historyEnabled){const e=b("wp-banana-ai-details__item",(0,n.__)("AI history:","wp-banana"),[(0,n.__)("History tracking is disabled for this site.","wp-banana")]);s.appendChild(e)}a.insertBefore(s,a.firstChild)},y=()=>{const e=window,t=e.wp?.media?.view?.Attachment?.Details;if(!t)return;if(t.__wpBananaDetailsPatched)return;const n=t.prototype?.render;if("function"==typeof n){if(t.prototype.render=function(...e){const t=n.apply(this,e);return w(this),t},t.TwoColumn){const e=t.TwoColumn.prototype?.render;"function"==typeof e&&(t.TwoColumn.prototype.render=function(...t){const n=e.apply(this,t);return w(this),n})}t.__wpBananaDetailsPatched=!0}},v=()=>{y()};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",v):v();const _=new WeakMap,x=(e,a)=>{if(e.querySelector(".media-menu-item.wp-banana-media-tab"))return;let r=null;const i=e.querySelector(".media-router"),o=e.querySelector(".media-frame-content");if(!i||!o)return;const l=`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`,d=`wp-banana-generate-tab-${l}`,c=`wp-banana-generate-panel-${l}`,u=document.createElement("button");u.type="button",u.id=d,u.className="media-menu-item wp-banana-media-tab",u.textContent=(0,n.__)("Generate Image","wp-banana"),u.setAttribute("role","tab"),u.setAttribute("aria-selected","false"),u.setAttribute("aria-controls",c),u.dataset.wpBanana="1",i.appendChild(u);const m=()=>{const e=document.createElement("div");return e.className="wp-banana-media-panel",e.id=c,e.setAttribute("role","tabpanel"),e.setAttribute("aria-labelledby",d),e.setAttribute("hidden","hidden"),e.setAttribute("aria-hidden","true"),e.style.display="none",o.appendChild(e),e};r=m();let f=!1;const h=()=>{e.classList.remove("wp-banana-media-tab-active"),u.classList.remove("active"),u.setAttribute("aria-selected","false"),r&&r.isConnected&&(r.setAttribute("hidden","hidden"),r.setAttribute("aria-hidden","true"),r.style.display="none")};i.addEventListener("click",n=>{const o=n.target,l=o?.closest(".media-menu-item");if(l)return l===u?(n.preventDefault(),n.stopPropagation(),n.stopImmediatePropagation(),void(()=>{r&&r.isConnected||(r&&_.delete(r),r=m(),f=!1),f||(((e,n,a)=>{const r=window,i=r.wp?.element;if("function"==typeof i?.createRoot){let t=_.get(e);return t||(t=i.createRoot(e),_.set(e,t)),void t.render((0,s.jsx)(p,{providers:n.providers,restNamespace:n.restNamespace,onComplete:a,defaultGeneratorModel:n.defaultGeneratorModel,defaultGeneratorProvider:n.defaultGeneratorProvider,defaultAspectRatio:n.defaultAspectRatio,aspectRatioOptions:n.aspectRatioOptions}))}(0,t.render)((0,s.jsx)(p,{providers:n.providers,restNamespace:n.restNamespace,onComplete:a,defaultGeneratorModel:n.defaultGeneratorModel,defaultGeneratorProvider:n.defaultGeneratorProvider,defaultAspectRatio:n.defaultAspectRatio,aspectRatioOptions:n.aspectRatioOptions}),e)})(r,a,()=>{(()=>{const e=window,t=e.wp?.media,n=t?.frame;if(!n)return;const a=[],r="function"==typeof n.state?n.state():null,i=r&&"function"==typeof r.get?r.get("library"):null;i&&a.push(i),n.library&&a.push(n.library);const o="function"==typeof n.content?.get?n.content.get():null;o?.collection&&a.push(o.collection),a.forEach(e=>{if(!e)return;"function"==typeof e.props?.set&&e.props.set({ignore:Date.now()});const t=(()=>{if("function"==typeof e.url)try{return e.url()}catch(e){return""}return e.url})();"string"==typeof t&&t.length>0&&("function"!=typeof e.more?"function"==typeof e.fetch&&e.fetch():e.more())}),"function"==typeof n.trigger&&n.trigger("library:refresh")})(),(()=>{const e=i.querySelector("#menu-item-browse")||i.querySelector('.media-menu-item[data-router="browse"]')||i.querySelector('.media-menu-item[data-router="library"]')||i.querySelector(".media-menu-item:not(.wp-banana-media-tab)");e&&e!==u?(h(),"function"==typeof e.click&&e.click()):h()})()}),f=!0),r.removeAttribute("hidden"),r.removeAttribute("aria-hidden"),r.style.display="block",i.querySelectorAll(".media-menu-item").forEach(e=>{const t=e===u;e.classList.toggle("active",t),e.setAttribute("aria-selected",t?"true":"false")}),e.classList.add("wp-banana-media-tab-active");const n=r.querySelector("textarea");n&&setTimeout(()=>n.focus(),50)})()):void h()});const b=e.querySelector(".media-modal-close");b&&b.addEventListener("click",h);const g=e.nextElementSibling;g&&g.classList.contains("media-modal-backdrop")&&g.addEventListener("click",h),new MutationObserver(()=>{("none"===e.style.display||"true"===e.getAttribute("aria-hidden"))&&h()}).observe(e,{attributes:!0,attributeFilter:["style","class","aria-hidden"]}),h()},E=()=>{const e=(()=>{const e=window.wpBananaMedia;if(!e||!Array.isArray(e.providers))return null;const t=e.providers.filter(e=>!1!==e.connected);return 0===t.length?null:{restNamespace:e.restNamespace,providers:t,defaultGeneratorModel:e.defaultGeneratorModel,defaultGeneratorProvider:e.defaultGeneratorProvider,defaultAspectRatio:e.defaultAspectRatio,aspectRatioOptions:e.aspectRatioOptions}})();if(!e)return;const t=t=>x(t,e);document.querySelectorAll(".media-modal").forEach(t),new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.forEach(e=>{e instanceof HTMLElement&&(e.matches(".media-modal")?t(e):e.querySelectorAll(".media-modal").forEach(e=>{t(e)}))})})}).observe(document.body,{childList:!0,subtree:!0})};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",E):E();const C={gemini:["gemini-2.5-flash-image-preview"],openai:["gpt-image-1"],replicate:["google/nano-banana","bytedance/seedream-4"]},k="banana",j="wp-banana-ai-notice",A="wp-banana-history-change",S=e=>e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"),N=(e,t,a,r,i)=>{var o;const s=document.getElementById(`imgedit-response-${e}`);if(!s)return;const l="success"===t?"notice notice-success":"notice notice-error",d=!1!==i?.openInNewTab,c=null!==(o=i?.label)&&void 0!==o?o:(0,n.__)("Open image in new tab","wp-banana");let p=`<div class="${l}" tabindex="-1" role="alert"><p>${S(a)}`;if(r){const e=d?' target="_blank" rel="noopener noreferrer"':"";p+=` <a href="${S(r)}"${e}><em>${S(c)}</em></a>`}p+="</p></div>",s.innerHTML=p;const u=window.wp?.a11y?.speak;"function"==typeof u&&u(a)},L=()=>{const e=window.imageEdit,t=window.jQuery;if(!e||!t||e.__wpBananaPatched)return;const n=e=>{"number"!=typeof e||Number.isNaN(e)||document.dispatchEvent(new CustomEvent(A,{detail:{attachmentId:e}}))};if(e.filterHistory=function(e,n){const a=t(`#imgedit-history-${e}`),r=t(`#imgedit-undone-${e}`),i=a.val();if(""===i||null==i)return n&&(this.hold.w=this.hold.ow,this.hold.h=this.hold.oh),"";let o;try{o=JSON.parse(i)}catch(e){return""}let s=parseInt(r.val()||"0",10);if(s>0&&(o=o.slice(0,o.length-s)),n){if(0===o.length)return this.hold.w=this.hold.ow,this.hold.h=this.hold.oh,"";const e=o[o.length-1];if(e){const t=e[k];if(t&&void 0!==t.fw)this.hold.w=t.fw,this.hold.h=t.fh;else{const t=e.c,n=e.r,a=e.f,r=t||n||a;r&&void 0!==r.fw&&void 0!==r.fh&&(this.hold.w=r.fw,this.hold.h=r.fh)}}}const l=[];for(let e=0;e<o.length;e++){const t=o[e];if(t&&t.c){const n=t.c;l[e]={c:{x:n.x,y:n.y,w:n.w,h:n.h,r:n.r}}}else if(t&&t.r){const n=t.r;l[e]={r:n.r}}else if(t&&t.f){const n=t.f;l[e]={f:n.f}}else if(t&&t[k]){const n=t[k];l[e]={[k]:{key:n.key,fw:n.fw,fh:n.fh,mime:n.mime||""}}}}return JSON.stringify(l)},e.__wpBananaPatched=!0,!e.__wpBananaHistoryPatched){const t="function"==typeof e.addStep?e.addStep:null;t&&(e.addStep=function(e,a,r){const i=t.call(this,e,a,r);return n(a),i});const a="function"==typeof e.undo?e.undo:null;a&&(e.undo=function(e,t){const r=a.call(this,e,t);return n(e),r});const r="function"==typeof e.redo?e.redo:null;r&&(e.redo=function(e,t){const a=r.call(this,e,t);return n(e),a}),e.__wpBananaHistoryPatched=!0}},R=({attachmentId:e,providers:r,restNamespace:l,defaultEditorModel:d,defaultEditorProvider:c})=>{var p;const u=(0,t.useMemo)(()=>r.filter(e=>!1!==e.connected),[r]),m=(0,t.useMemo)(()=>{var e,t;if(c){const e=u.find(e=>e.slug===c);if(e)return e.slug}if(d){const e=u.find(e=>e.default_model===d);if(e)return e.slug;const t=r.find(e=>e.default_model===d);if(t){const e=u.find(e=>e.slug===t.slug);if(e)return e.slug}}const n=u.find(e=>"replicate"===e.slug);return n?n.slug:null!==(e=null!==(t=u[0]?.slug)&&void 0!==t?t:r[0]?.slug)&&void 0!==e?e:""},[u,r,c,d]),[f,h]=(0,t.useState)(m),[b,g]=(0,t.useState)(""),[w,y]=(0,t.useState)([]),[v,_]=(0,t.useState)(""),[x,E]=(0,t.useState)(!1),[A,S]=(0,t.useState)(null),[N,R]=(0,t.useState)(null),[M,I]=(0,t.useState)(!1),[O,P]=(0,t.useState)(null),[$,D]=(0,t.useState)(!1),[T,U]=(0,t.useState)([]),[B,F]=(0,t.useState)(null),G=(0,a.useRef)(null),q=(0,a.useRef)(T),H=T.length,W=H>0,J=(0,t.useMemo)(()=>{var e;if(!W)return w;const t=null!==(e=C[f])&&void 0!==e?e:[];if(0===t.length)return[];const n=new Set(t);return w.filter(e=>n.has(e))},[w,f,W]);(0,t.useEffect)(()=>{const e=e=>{const t=e;t.detail&&P(t.detail)};return document.addEventListener(j,e),()=>{document.removeEventListener(j,e)}},[]),(0,t.useEffect)(()=>{q.current=T},[T]),(0,t.useEffect)(()=>()=>{q.current.forEach(e=>{window.URL.revokeObjectURL(e.url)})},[]);const Q=(0,t.useMemo)(()=>r.find(e=>e.slug===f),[f,r]),z=(0,t.useMemo)(()=>{var e;if(Q?.label)return Q.label;const t=r.find(e=>e.slug===f);return null!==(e=t?.label)&&void 0!==e?e:f?f.toUpperCase():""},[f,r,Q]),K=(0,t.useMemo)(()=>{const e=Q?.default_model?String(Q.default_model):"",t=v||(x?(0,n.__)("Loading modelâ€¦","wp-banana"):""!==e?e:(0,n.__)("Provider default model","wp-banana")),a=z,r=H>0?(0,n.sprintf)((0,n._n)("%d reference","%d references",H,"wp-banana"),H):"";return{model:t,provider:a,references:r,fallback:t||a||r?"":(0,n.__)("Using provider defaults","wp-banana")}},[v,x,z,Q,H]);(0,t.useEffect)(()=>{f&&u.some(e=>e.slug===f)||m&&h(m)},[m,f,u]),(0,t.useEffect)(()=>{if(!f)return;let e=!0;return E(!0),S(null),i()({path:`${l}/models?provider=${f}&purpose=edit`}).then(t=>{if(!e)return;const n=t,a=Array.isArray(n.models)?n.models:[];if(y(a),0===a.length)return void _("");const r=[d,Q?.default_model].find(e=>!!e&&a.includes(e));_(r||a[0])}).catch(t=>{var a;e&&(y([]),_(""),S(null!==(a=t?.message)&&void 0!==a?a:(0,n.__)("Failed to load models.","wp-banana")))}).finally(()=>{e&&E(!1)}),()=>{e=!1}},[f,l,Q,d]),(0,t.useEffect)(()=>{x||(0!==J.length?J.includes(v)||_(J[0]):W&&""!==v&&_(""))},[J,v,x,W]);const V=(0,t.useMemo)(()=>J.length>0?""!==v&&J.includes(v):!W&&(""!==v||0===w.length),[J,v,W,w]),Y=(0,t.useMemo)(()=>!(M||x||b.trim().length<3||""===f||!V),[M,x,b,f,V]),X=(0,a.useCallback)(()=>{q.current.forEach(e=>{window.URL.revokeObjectURL(e.url)}),q.current=[],U([]),F(null)},[]),Z=(0,a.useCallback)(()=>{G.current&&G.current.click()},[]),ee=(0,a.useCallback)(e=>{const t=e.target.files;if(!t||0===t.length)return;let a=Math.max(0,4-T.length),r=0,i=0;const o=[];Array.from(t).forEach(e=>{if(!e.type||!e.type.startsWith("image/"))return;if(i+=1,a<=0)return;const t=`${Date.now()}-${Math.random().toString(36).slice(2)}`;o.push({id:t,file:e,url:window.URL.createObjectURL(e)}),a-=1,r+=1}),r>0?(U([...T,...o]),R(null),F(i>r?(0,n.__)("You can upload up to 4 reference images.","wp-banana"):null)):i>0&&F((0,n.__)("You can upload up to 4 reference images.","wp-banana")),e.target.value=""},[T]),te=(0,a.useCallback)(e=>{let t=!1;const n=T.filter(n=>n.id!==e||(window.URL.revokeObjectURL(n.url),t=!0,!1));t&&(q.current=n),U(n),F(null)},[T]),ne=async()=>{const t=b.trim();if(t.length<3)R((0,n.__)("Please enter a longer prompt.","wp-banana"));else if(W&&0===J.length)R((0,n.__)("Choose a model that supports multiple reference images.","wp-banana"));else{R(null),F(null),P(null),I(!0);try{let u;const m=(e=>{const t=(e=>{const t=document.getElementById(`imgedit-history-${e}`);if(!t)return[];const n=(e=>{if(!e)return[];try{const t=JSON.parse(e);return Array.isArray(t)?t:[]}catch(e){return[]}})(t.value||"");if(0===n.length)return n;const a=document.getElementById(`imgedit-undone-${e}`);if(!a||!a.value)return n;const r=parseInt(a.value,10);return Number.isNaN(r)||r<=0?n:n.slice(0,Math.max(0,n.length-r))})(e);for(let e=t.length-1;e>=0;e-=1){const n=t[e];if(!n||"object"!=typeof n)continue;const a=n[k];if(a&&"object"==typeof a){const e=a.key;if("string"==typeof e&&e.length>0)return e}}return null})(e);if(H>0){const n=new window.FormData;n.append("attachment_id",String(e)),n.append("prompt",t),n.append("provider",f),v&&n.append("model",v),n.append("save_mode","buffer"),m&&n.append("base_buffer_key",m),T.forEach(e=>{n.append("reference_images[]",e.file,e.file.name)}),u=await i()({path:`${l}/edit`,method:"POST",body:n})}else{const n={attachment_id:e,prompt:t,provider:f,model:v,save_mode:"buffer"};m&&(n.base_buffer_key=m),u=await i()({path:`${l}/edit`,method:"POST",data:n})}const h=u;if(h&&"string"==typeof h.buffer_key){var a,r,o,s,d,c,p;const i={buffer_key:h.buffer_key,width:null!==(a=h.width)&&void 0!==a?a:0,height:null!==(r=h.height)&&void 0!==r?r:0,mime:null!==(o=h.mime)&&void 0!==o?o:"image/png",attachment_id:null!==(s=h.attachment_id)&&void 0!==s?s:e,provider:null!==(d=h.provider)&&void 0!==d?d:f,model:null!==(c=h.model)&&void 0!==c?c:v,prompt:null!==(p=h.prompt)&&void 0!==p?p:t};try{(e=>{L();const t=window.imageEdit;if(!t)throw new Error((0,n.__)("Image editor not ready.","wp-banana"));const a=document.getElementById(`imgedit-nonce-${e.attachment_id}`);if(!a||""===a.value)throw new Error((0,n.__)("Editor security token missing.","wp-banana"));const r={key:e.buffer_key,fw:e.width,fh:e.height,mime:e.mime};e.provider&&(r.provider=e.provider),e.model&&(r.model=e.model),e.prompt&&(r.prompt=e.prompt),t.addStep({[k]:r},e.attachment_id,a.value)})(i),P({type:"success",message:(0,n.__)("AI edit applied. Use Save Edits or Save As to keep these changes.","wp-banana")}),g(""),X()}catch(e){const t=e instanceof Error?e.message:(0,n.__)("Failed to apply edit in editor.","wp-banana");R(t)}}else{const e=u;e&&e.url?P({type:"success",message:(0,n.__)("Edited image saved.","wp-banana"),url:e.url}):P({type:"success",message:(0,n.__)("Edit completed.","wp-banana")}),g(""),X()}D(!1)}catch(e){var u;const t=e;R(null!==(u=t?.message)&&void 0!==u?u:(0,n.__)("Failed to edit image.","wp-banana"))}finally{I(!1)}}},ae=(0,a.useCallback)(e=>{"Enter"===e.key&&(e.metaKey||e.ctrlKey)&&(e.preventDefault(),Y&&ne())},[Y,ne]);return(0,s.jsx)(o.Card,{children:(0,s.jsxs)(o.CardBody,{children:[A&&(0,s.jsx)(o.Notice,{status:"error",isDismissible:!0,onRemove:()=>S(null),children:A}),N&&(0,s.jsx)(o.Notice,{status:"error",isDismissible:!0,onRemove:()=>R(null),children:N}),B&&(0,s.jsx)(o.Notice,{status:"warning",isDismissible:!0,onRemove:()=>F(null),children:B}),W&&!x&&0===J.length&&(0,s.jsx)(o.Notice,{status:"warning",isDismissible:!1,children:(0,n.__)("Switch to a supported model to send multiple reference images.","wp-banana")}),O&&(0,s.jsxs)(o.Notice,{status:"success"===O.type?"success":"info",isDismissible:!0,onRemove:()=>P(null),children:[O.message,O.url&&(0,s.jsxs)(s.Fragment,{children:[" ",(0,s.jsx)("a",{href:O.url,target:!1===O.openInNewTab?void 0:"_blank",rel:!1===O.openInNewTab?void 0:"noopener noreferrer",children:(0,s.jsx)("em",{children:null!==(p=O.linkLabel)&&void 0!==p?p:(0,n.__)("Open image in new tab","wp-banana")})})]})]}),(0,s.jsxs)("div",{style:{position:"relative",marginBottom:"8px"},children:[(0,s.jsx)(o.TextareaControl,{label:(0,n.__)("Describe the desired changes","wp-banana"),value:b,onChange:e=>g(e),onKeyDown:ae,rows:4,placeholder:(0,n.__)("Add a glowing neon outlineâ€¦","wp-banana"),disabled:M}),(0,s.jsx)("button",{type:"button",className:"button button-secondary button-small",onClick:Z,disabled:M,"aria-label":(0,n.__)("Add reference images","wp-banana"),style:{position:"absolute",top:"26px",right:"0",lineHeight:"20px",padding:"0 4px",border:"none",borderRadius:0,background:"transparent"},children:(0,s.jsx)("span",{className:"dashicons dashicons-paperclip","aria-hidden":"true"})}),(0,s.jsx)("input",{ref:G,type:"file",accept:"image/png,image/jpeg,image/webp",multiple:!0,onChange:ee,style:{display:"none"}})]}),T.length>0&&(0,s.jsx)("div",{style:{display:"flex",gap:"8px",marginBottom:"16px",flexWrap:"wrap"},children:T.map(e=>(0,s.jsxs)("div",{style:{position:"relative",width:"72px",height:"72px",overflow:"hidden",borderRadius:"4px",border:"1px solid #dcdcde"},children:[(0,s.jsx)("img",{src:e.url,alt:"",style:{width:"100%",height:"100%",objectFit:"cover"}}),(0,s.jsx)("button",{type:"button",className:"button-link",onClick:()=>te(e.id),"aria-label":(0,n.__)("Remove reference image","wp-banana"),style:{position:"absolute",top:"2px",right:"2px",background:"rgba(0,0,0,0.55)",borderRadius:"3px",color:"#fff",width:"22px",height:"22px",display:"inline-flex",alignItems:"center",justifyContent:"center",textDecoration:"none"},children:(0,s.jsx)("span",{className:"dashicons dashicons-no"})})]},e.id))}),$&&u.length>1&&(0,s.jsx)(o.SelectControl,{label:(0,n.__)("Provider","wp-banana"),value:f,onChange:e=>h(e),disabled:M,options:u.map(e=>({label:e.label,value:e.slug}))}),$&&(0,s.jsx)(o.SelectControl,{label:(0,n.__)("Model","wp-banana"),value:v,onChange:e=>_(e),options:J.length>0?J.map(e=>({label:e,value:e})):[{label:(0,n.__)("No models available","wp-banana"),value:""}],disabled:x||0===J.length||M}),x&&(0,s.jsxs)("div",{className:"wp-banana-edit-panel__spinner",style:{display:"flex",alignItems:"center",gap:"8px"},children:[(0,s.jsx)(o.Spinner,{})," ",(0,n.__)("Loading modelsâ€¦","wp-banana")]}),(0,s.jsxs)("div",{className:"wp-banana-edit-panel__actions",style:{marginTop:"12px",display:"flex",flexWrap:"wrap",alignItems:"center",gap:"12px",justifyContent:"space-between"},children:[(0,s.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"12px"},children:[(0,s.jsx)("button",{type:"button",className:"button button-primary wp-banana-edit-panel__submit",onClick:ne,disabled:!Y,children:(0,n.__)("Apply AI Edit","wp-banana")}),M&&(0,s.jsx)("span",{className:"spinner is-active","aria-hidden":"true"})]}),(0,s.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"8px",flexWrap:"wrap",textAlign:"right"},children:[K.fallback?(0,s.jsx)("span",{children:K.fallback}):(0,s.jsxs)("span",{children:[(0,s.jsx)("code",{children:K.model}),K.provider&&(0,s.jsxs)("span",{children:[" (",K.provider,")"]}),K.references&&(0,s.jsxs)("span",{children:[" - ",K.references]})]}),(0,s.jsx)("button",{type:"button",className:"button-link",onClick:()=>D(!$),children:$?(0,n.__)("Hide options","wp-banana"):(0,n.__)("Change","wp-banana")})]})]})]})})},M=new WeakMap,I=(e,a)=>{if("1"===e.dataset.wpBananaEnhanced)return;const r=e.querySelector(".imgedit-menu");if(!r)return;const o=(e=>{const t=e.closest('[id^="imgedit-panel-"]');if(!t)return null;const n=t.id.match(/imgedit-panel-(\d+)/);return n?parseInt(n[1],10):null})(e);if(!o)return;L(),(()=>{var e,t;const n="wp-banana-edit-toggle-styles";if(document.getElementById(n))return;const a=document.createElement("style");a.id=n,a.textContent="\n.imgedit-menu .wp-banana-edit-toggle.button:after {\n\tfont: normal 16px/1 dashicons;\n\tcontent: '\\f140';\n\tmargin-left: 2px;\n\tmargin-right: 0;\n\tspeak: never;\n\t-webkit-font-smoothing: antialiased;\n\tdisplay: inline-block;\n\ttop: 0;\n}\n.imgedit-menu .wp-banana-edit-toggle.button[aria-expanded=\"true\"]:after {\n\tcontent: '\\f142';\n}\n";const r=null!==(e=null!==(t=document.head)&&void 0!==t?t:document.body)&&void 0!==e?e:document.documentElement;r&&r.appendChild(a)})();const l=document.createElement("button");if(l.type="button",l.className="button wp-banana-edit-toggle",l.setAttribute("aria-expanded","false"),l.style.marginLeft="8px",l.style.whiteSpace="nowrap",l.style.display="inline-flex",l.style.alignItems="center",l.style.gap="6px",a.data.iconUrl){const e=document.createElement("span");e.setAttribute("aria-hidden","true"),e.style.display="inline-block",e.style.width="16px",e.style.height="16px",e.style.backgroundColor="currentColor",e.style.maskImage=`url(${a.data.iconUrl})`,e.style.webkitMaskImage=`url(${a.data.iconUrl})`,e.style.maskRepeat="no-repeat",e.style.webkitMaskRepeat="no-repeat",e.style.maskPosition="center",e.style.webkitMaskPosition="center",e.style.maskSize="contain",e.style.webkitMaskSize="contain",l.appendChild(e)}l.appendChild(document.createTextNode((0,n.__)("AI Edit","wp-banana"))),r.appendChild(l);const d=document.createElement("div");d.className="wp-banana-edit-panel",d.style.display="none",d.style.marginTop="12px",d.style.maxWidth="100%",d.style.width="100%",d.style.flexBasis="100%",d.style.flexGrow="0",d.style.flexShrink="0",d.style.flex="0 0 100%",d.style.alignSelf="stretch",d.style.clear="both",d.style.boxSizing="border-box";const c=e.querySelector(".imgedit-submit");c?c.insertAdjacentElement("afterend",d):e.appendChild(d);let p=!1;const u=()=>{p||(p=!0,(({container:e,attachmentId:n,providers:a,restNamespace:r,defaultEditorModel:i,defaultEditorProvider:o})=>{let l=M.get(e);if(!l){const n=window.wp?.element;if("function"==typeof n?.createRoot){const t=n.createRoot(e);l={render:e=>t.render(e)}}else l={render:n=>(0,t.render)(n,e)};M.set(e,l)}l.render((0,s.jsx)(R,{attachmentId:n,providers:a,restNamespace:r,defaultEditorModel:i,defaultEditorProvider:o}))})({container:d,attachmentId:o,providers:a.data.providers,restNamespace:a.data.restNamespace,defaultEditorModel:a.data.defaultEditorModel,defaultEditorProvider:a.data.defaultEditorProvider})),d.style.display="block",l.setAttribute("aria-expanded","true"),l.classList.add("wp-banana-edit-toggle--open");const e=d.querySelector("textarea");e&&setTimeout(()=>e.focus(),50)};((e,t,a,r)=>{const o=e.querySelector(".imgedit-submit");if(!o||o.querySelector(".wp-banana-save-as"))return;const s=document.createElement("button");s.type="button",s.className="button wp-banana-save-as",s.textContent=(0,n.__)("Save As Copy","wp-banana"),s.style.marginLeft="8px",o.appendChild(s);const l=e=>{document.dispatchEvent(new CustomEvent(j,{detail:e}))},d=()=>{s.classList.contains("is-busy")||(s.disabled=!(()=>{const e=window.imageEdit;if(!e||"function"!=typeof e.filterHistory)return!1;const n=e.filterHistory(t,0);return!!n&&"[]"!==n})())};d(),document.addEventListener(A,e=>{const n=e;n.detail&&n.detail.attachmentId===t&&d()}),s.addEventListener("click",async()=>{const e=window.imageEdit;if(!e){const e=(0,n.__)("Image editor not ready.","wp-banana");return r(),N(t,"error",e),void l({type:"info",message:e})}const o=e.filterHistory(t,0);if(!o||"[]"===o){const e=(0,n.__)("No edits to save.","wp-banana");return r(),N(t,"error",e),void l({type:"info",message:e})}s.disabled=!0,s.classList.add("is-busy");try{var c,p;const e=await i()({path:`${a}/edit/save-as`,method:"POST",data:{attachment_id:t,history:o}}),s=null!==(c=e?.filename)&&void 0!==c?c:"",d=s?(0,n.sprintf)((0,n.__)("Copy saved: %s","wp-banana"),s):(0,n.__)("Copy saved.","wp-banana"),u=(e=>{const t=window.ajaxurl;if(t)try{const n=new URL(t,window.location.origin);n.hash="";const a=n.pathname.split("/");return a[a.length-1]="upload.php",n.pathname=a.join("/"),n.search=`item=${e}`,n.toString()}catch(e){}return`${window.location.origin.replace(/\/$/,"")}/wp-admin/upload.php?item=${e}`})(null!==(p=e?.attachment_id)&&void 0!==p?p:t),m=(0,n.__)("Open image","wp-banana");r(),N(t,"success",d,u,{openInNewTab:!1,label:m}),l({type:"success",message:d,url:u,linkLabel:m,openInNewTab:!1})}catch(e){var u;const a=e,i=null!==(u=a?.message)&&void 0!==u?u:(0,n.__)("Failed to save copy.","wp-banana");r(),N(t,"error",i),l({type:"info",message:i})}finally{s.disabled=!1,s.classList.remove("is-busy"),d()}})})(e,o,a.data.restNamespace,u),l.addEventListener("click",e=>{if(e.preventDefault(),"block"===d.style.display)return d.style.display="none",l.setAttribute("aria-expanded","false"),void l.classList.remove("wp-banana-edit-toggle--open");u()}),e.dataset.wpBananaEnhanced="1"},O=()=>{const e=window.wpBananaMedia;var t;e&&Array.isArray(e.providers)&&0!==e.providers.length&&(0!==e.providers.filter(e=>!1!==e.connected).length&&(L(),t={data:e},document.querySelectorAll(".imgedit-panel-content.imgedit-panel-tools").forEach(e=>{e instanceof HTMLElement&&I(e,t)}),new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.forEach(e=>{e instanceof HTMLElement&&(e.matches(".imgedit-panel-content.imgedit-panel-tools")?I(e,t):e.querySelectorAll(".imgedit-panel-content.imgedit-panel-tools").forEach(e=>{e instanceof HTMLElement&&I(e,t)}))})})}).observe(document.body,{childList:!0,subtree:!0})))};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",O):O()})();