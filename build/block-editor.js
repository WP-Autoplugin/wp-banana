(()=>{"use strict";var e={n:t=>{var n=t&&t.__esModule?()=>t.default:()=>t;return e.d(n,{a:n}),n},d:(t,n)=>{for(var a in n)e.o(n,a)&&!e.o(t,a)&&Object.defineProperty(t,a,{enumerable:!0,get:n[a]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const t=window.wp.element,n=window.wp.i18n,a=window.wp.apiFetch;var r=e.n(a);const o=window.wp.components,i=window.ReactJSXRuntime,s=({prompt:e,onPromptChange:t,onPromptKeyDown:a,isSubmitting:r,canSubmit:s,onSubmit:l,onReferenceClick:d,showOptions:c,onToggleOptions:p,summary:u,variationMenuRef:m,onVariationToggle:f,isVariationMenuOpen:h,variationMenu:g,enableReferenceDragDrop:b=!1,dropOverlayVisible:w=!1,promptLabel:v,promptPlaceholder:y,submitLabel:_,submitTooltip:x,referenceTray:C})=>{const E=Boolean(m&&f&&"boolean"==typeof h),R=null!=v?v:(0,n.__)("Describe the image","wp-banana"),S=null!=y?y:(0,n.__)("A cat surfing a wave at sunset…","wp-banana"),j=null!=_?_:(0,n.__)("Generate Image","wp-banana"),k=null!=x?x:(0,n.__)("Generate one image and save to Media Library","wp-banana");return(0,i.jsxs)(i.Fragment,{children:[b&&(0,i.jsx)("div",{className:"uploader-window wp-banana-generate-page__drop-overlay",style:{display:w?"block":"none",opacity:w?1:0},"aria-hidden":"true",children:(0,i.jsx)("div",{className:"uploader-window-content",children:(0,i.jsx)("div",{className:"uploader-editor-title",children:(0,n.__)("Drop files to attach","wp-banana")})})}),(0,i.jsxs)("div",{className:"wp-banana-generate-panel__prompt",style:{position:"relative",marginBottom:"8px"},children:[(0,i.jsx)(o.TextareaControl,{label:R,value:e,onChange:t,onKeyDown:a,rows:5,placeholder:S,disabled:r}),(0,i.jsx)("button",{type:"button",className:"button button-secondary button-small wp-banana-generate-panel__reference-picker",onClick:d,disabled:r,"aria-label":(0,n.__)("Add reference images","wp-banana"),style:{position:"absolute",top:"24px",right:"0",lineHeight:"20px",padding:"0 4px",border:"none",borderRadius:0,background:"transparent"},children:(0,i.jsx)("span",{className:"dashicons dashicons-paperclip","aria-hidden":"true"})})]}),C,(0,i.jsxs)("div",{className:"wp-banana-generate-panel__actions",style:{marginTop:"16px",display:"flex",flexWrap:"wrap",alignItems:"center",gap:"12px",justifyContent:"space-between"},children:[(0,i.jsxs)("div",{ref:E&&null!=m?m:null,style:{display:"flex",alignItems:"center",gap:"12px",position:"relative",zIndex:1e3},children:[(0,i.jsxs)("div",{className:"button-group",children:[(0,i.jsx)("button",{type:"button",className:"button button-primary wp-banana-generate-panel__submit",onClick:l,disabled:!s||r,title:k,children:j}),E&&(0,i.jsx)("button",{type:"button",className:"button button-primary",onClick:f,disabled:r||!s,"aria-haspopup":"menu","aria-expanded":h,"aria-label":(0,n.__)("Generate multiple variations","wp-banana"),style:{padding:"0 4px"},title:(0,n.__)("Generate multiple variations and preview before saving","wp-banana"),children:(0,i.jsx)("span",{className:"dashicons dashicons-arrow-down-alt2","aria-hidden":"true",style:{lineHeight:"30px"}})})]}),r&&(0,i.jsx)("span",{className:"spinner is-active","aria-hidden":"true"}),E&&g]}),(0,i.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"8px",flexWrap:"wrap",textAlign:"right"},children:[u.fallback?(0,i.jsx)("span",{children:u.fallback}):(0,i.jsxs)("span",{children:[u.aspect&&(0,i.jsxs)("span",{children:[u.aspect," — "]}),(0,i.jsx)("code",{children:u.model}),u.provider&&(0,i.jsxs)("span",{children:[" (",u.provider,")"]}),u.references&&(0,i.jsxs)("span",{children:[" - ",u.references]})]}),(0,i.jsx)("button",{type:"button",className:"button-link",onClick:p,children:c?(0,n.__)("Hide options","wp-banana"):(0,n.__)("Change","wp-banana")})]})]})]})},l=({show:e,connectedProviders:t,provider:a,onProviderChange:r,model:s,onModelChange:l,modelOptions:d,modelsLoading:c,aspectRatioEnabled:p,aspectRatio:u,onAspectRatioChange:m,aspectOptions:f,resolutionEnabled:h,resolution:g,onResolutionChange:b,resolutionOptions:w,isSubmitting:v,children:y})=>e?(0,i.jsxs)("div",{className:"wp-banana-generate-panel__options",style:{marginTop:"16px"},children:[y,t.length>1&&(0,i.jsx)(o.SelectControl,{label:(0,n.__)("Provider","wp-banana"),value:a,onChange:r,options:t.map(e=>({label:e.label,value:e.slug})),disabled:v}),(0,i.jsx)(o.SelectControl,{label:(0,n.__)("Model","wp-banana"),value:s,onChange:l,disabled:c||0===d.length||v,options:d.length>0?d.map(e=>({label:e,value:e})):[{label:(0,n.__)("No models available","wp-banana"),value:""}]}),p&&(0,i.jsx)(o.SelectControl,{label:(0,n.__)("Aspect ratio","wp-banana"),value:u,onChange:m,disabled:v,options:f.map(e=>({label:e,value:e}))}),h&&(0,i.jsx)(o.SelectControl,{label:(0,n.__)("Resolution","wp-banana"),value:g,onChange:b,disabled:v,options:w.map(e=>({label:e,value:e}))}),c&&(0,i.jsxs)("div",{className:"wp-banana-generate-panel__spinner",style:{display:"flex",alignItems:"center",gap:"8px"},children:[(0,i.jsx)(o.Spinner,{})," ",(0,n.__)("Loading models…","wp-banana")]})]}):(0,i.jsxs)(i.Fragment,{children:[y,c&&(0,i.jsxs)("div",{className:"wp-banana-generate-panel__spinner",style:{display:"flex",alignItems:"center",gap:"8px"},children:[(0,i.jsx)(o.Spinner,{})," ",(0,n.__)("Loading models…","wp-banana")]})]}),d=({referenceImages:e,onRemove:t,fileInputRef:a,onReferenceSelection:r})=>(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)("input",{ref:a,type:"file",accept:"image/png,image/jpeg,image/webp",multiple:!0,onChange:r,style:{display:"none"}}),e.length>0&&(0,i.jsx)("div",{className:"wp-banana-generate-panel__reference-list",style:{display:"flex",gap:"8px",marginBottom:"16px",flexWrap:"wrap"},children:e.map(e=>(0,i.jsxs)("div",{style:{position:"relative",width:"72px",height:"72px",overflow:"hidden",borderRadius:"4px",border:"1px solid #dcdcde"},children:[(0,i.jsx)("img",{src:e.url,alt:"",style:{width:"100%",height:"100%",objectFit:"cover"}}),(0,i.jsx)("button",{type:"button",className:"button-link wp-banana-generate-panel__reference-remove",onClick:()=>t(e.id),"aria-label":(0,n.__)("Remove reference image","wp-banana"),style:{position:"absolute",top:"2px",right:"2px",display:"inline-flex",alignItems:"center",justifyContent:"center",width:"22px",height:"22px",background:"rgba(0,0,0,0.55)",color:"#fff",borderRadius:"3px",textDecoration:"none"},children:(0,i.jsx)("span",{className:"dashicons dashicons-no"})})]},e.id))})]}),c=({isOpen:e,options:t,onSelect:a})=>e?(0,i.jsxs)("div",{className:"wp-banana-generate-panel__variation-menu",role:"menu",style:{position:"absolute",top:"100%",right:0,marginTop:"4px",background:"#fff",border:"1px solid #dcdcde",borderRadius:"4px",boxShadow:"0 4px 12px rgba(0,0,0,0.15)",zIndex:10,minWidth:"180px",padding:"4px 0"},children:[t.map(e=>(0,i.jsxs)("button",{type:"button",role:"menuitem",className:"button button-link",style:{display:"flex",width:"100%",justifyContent:"space-between",alignItems:"center",padding:"6px 12px",boxSizing:"border-box",textDecoration:"none"},onClick:()=>a(e),children:[(0,i.jsx)("span",{children:(0,n.sprintf)((0,n._n)("%d image","%d images",e,"wp-banana"),e)}),1===e&&(0,i.jsx)("span",{className:"dashicons dashicons-format-image","aria-hidden":"true"}),e>1&&(0,i.jsx)("span",{className:"dashicons dashicons-images-alt2","aria-hidden":"true"})]},e)),(0,i.jsx)("span",{style:{display:"block",padding:"4px 12px 2px",fontSize:"11px",fontWeight:"400",color:"#555d66",borderTop:"1px solid #e1e1e1"},children:(0,n.__)("Generate and Preview Images","wp-banana")})]}):null,p=[1,2,3,4],u=(()=>{var e,t;const n=window;return null!==(e=null!==(t=n.wpBananaMedia?.multiImageModelAllowlist)&&void 0!==t?t:n.wpBananaGeneratePage?.multiImageModelAllowlist)&&void 0!==e?e:{}})(),m=((e,t)=>{const n=window;return null!==(e=null!==(t=n.wpBananaMedia?.resolutionModelAllowlist)&&void 0!==t?t:n.wpBananaGeneratePage?.resolutionModelAllowlist)&&void 0!==e?e:{}})(),f={"image/jpeg":"jpg","image/jpg":"jpg","image/png":"png","image/webp":"webp"},h=(e,t,n)=>{var a;const r=`reference-${t}`,o=e&&e.trim().length>0?e.trim():r,i=null!==(a=f[n.toLowerCase()])&&void 0!==a?a:"";if(""===i)return o;if(o.toLowerCase().endsWith(`.${i}`))return o;const s=o.lastIndexOf(".");return s>0?`${o.slice(0,s)}.${i}`:`${o}.${i}`},g=e=>{if(!e)return"png";const t=f[e.toLowerCase()];return null!=t?t:"png"},b=e=>{switch(e){case"queued":case"loading":return(0,n.__)("Generating…","wp-banana");case"complete":return(0,n.__)("Ready","wp-banana");case"saving":return(0,n.__)("Saving…","wp-banana");case"saved":return(0,n.__)("Saved","wp-banana");case"error":return(0,n.__)("Failed","wp-banana");default:return""}},w=({previewItems:e,selectedPreview:t,selectedPreviewSrc:a,onSelect:r,previewAction:s,onUndo:l,onClear:d,canSaveSelected:c,canDiscardSelected:p,onSave:u,onDiscard:m})=>{var f;return 0===e.length?null:(0,i.jsxs)("div",{className:"wp-banana-generate-panel__variations",style:{marginTop:"24px",borderTop:"1px solid #dcdcde",paddingTop:"16px"},children:[(0,i.jsxs)("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:"12px",gap:"12px"},children:[(0,i.jsx)("h3",{style:{margin:0},children:(0,n.__)("Generated Variations","wp-banana")}),(0,i.jsx)("button",{type:"button",className:"button",onClick:d,children:(0,n.__)("Clear previews","wp-banana")})]}),s&&"success"!==s.type&&(0,i.jsx)(o.Notice,{status:"warning"===s.type?"warning":"error",isDismissible:!1,style:{marginBottom:"16px"},children:(0,i.jsxs)("div",{className:"wp-banana-generate-variations-notice",style:{display:"flex",alignItems:"center",gap:"8px",flexWrap:"wrap"},children:[(0,i.jsx)("span",{children:s.message}),s.undo?(0,i.jsx)("button",{type:"button",className:"button-link",onClick:l,children:(0,n.__)("Undo","wp-banana")}):null]})}),(0,i.jsxs)("div",{className:"wp-banana-generate-variations-layout",style:{display:"flex",gap:"16px",flexWrap:"wrap"},children:[(0,i.jsx)("div",{className:"wp-banana-generate-variations-list",style:{width:"200px",maxHeight:"440px",overflowY:"auto",display:"flex",flexDirection:"column",gap:"8px"},children:e.map(e=>{const a=e.id===t?.id,s=e.data&&e.mime?`data:${e.mime};base64,${e.data}`:"";return(0,i.jsxs)("button",{type:"button",onClick:()=>r(e.id),className:"button button-link",style:{display:"flex",flexDirection:"column",alignItems:"stretch",gap:"6px",padding:"6px",border:a?"2px solid #007cba":"1px solid #dcdcde",borderRadius:"4px",background:a?"#f0f6fc":"#fff",textAlign:"left",textDecoration:"none",boxShadow:"none"},children:[(0,i.jsxs)("div",{style:{position:"relative",height:"64px",background:"#f6f7f7",display:"flex",alignItems:"center",justifyContent:"center",overflow:"hidden",borderRadius:"3px"},children:["complete"===e.status||"saved"===e.status||"error"===e.status?s?(0,i.jsx)("img",{src:s,alt:"",style:{width:"100%",height:"100%",objectFit:"cover"}}):(0,i.jsx)("span",{children:(0,n.__)("Preview unavailable","wp-banana")}):(0,i.jsx)(o.Spinner,{}),"saved"===e.status&&(0,i.jsx)("span",{style:{position:"absolute",top:"4px",right:"4px",background:"#007cba",color:"#fff",padding:"2px 6px",borderRadius:"3px",fontSize:"11px",fontWeight:600},children:(0,n.__)("Saved","wp-banana")})]}),(0,i.jsxs)("div",{style:{display:"flex",flexDirection:"column",gap:"2px"},children:[(0,i.jsx)("strong",{children:(0,n.sprintf)((0,n.__)("Variation %d","wp-banana"),e.index+1)}),(0,i.jsx)("span",{style:{fontSize:"12px",color:"#555"},children:b(e.status)})]})]},e.id)})}),(0,i.jsxs)("div",{className:"wp-banana-generate-variations-preview",style:{flex:1,minWidth:"260px",display:"flex",flexDirection:"column",gap:"16px"},children:[(0,i.jsx)("div",{style:{position:"relative",background:"#f6f7f7",border:"1px solid #dcdcde",borderRadius:"4px",minHeight:"300px",display:"flex",alignItems:"center",justifyContent:"center",padding:"12px"},children:t?"loading"===t.status||"queued"===t.status?(0,i.jsx)(o.Spinner,{}):"error"===t.status?(0,i.jsx)(o.Notice,{status:"error",isDismissible:!1,children:null!==(f=t.error)&&void 0!==f?f:(0,n.__)("Failed to generate image.","wp-banana")}):(0,i.jsxs)(i.Fragment,{children:[a?(0,i.jsx)("img",{src:a,alt:"",style:{maxWidth:"100%",maxHeight:"500px",borderRadius:"4px",objectFit:"contain"}}):(0,i.jsx)("span",{children:(0,n.__)("Preview unavailable","wp-banana")}),"saving"===t.status&&(0,i.jsxs)("div",{style:{position:"absolute",inset:0,background:"rgba(255,255,255,0.7)",display:"flex",alignItems:"center",justifyContent:"center",gap:"8px"},children:[(0,i.jsx)(o.Spinner,{})," ",(0,n.__)("Saving…","wp-banana")]})]}):(0,i.jsx)("span",{children:(0,n.__)("No preview selected.","wp-banana")})}),(0,i.jsxs)("div",{style:{display:"flex",gap:"8px"},children:[(0,i.jsx)("button",{type:"button",className:"button button-primary",onClick:t?()=>u(t.id):void 0,disabled:!c||"saving"===t?.status,children:(0,n.__)("Save","wp-banana")}),(0,i.jsx)("button",{type:"button",className:"button",onClick:t?()=>m(t.id):void 0,disabled:!p||"saving"===t?.status,children:(0,n.__)("Discard","wp-banana")})]})]})]})]})},v=({providers:e,restNamespace:a,defaultGeneratorModel:o,defaultGeneratorProvider:i,aspectRatioOptions:s,defaultAspectRatio:l,resolutionOptions:d,defaultResolution:c,referenceCount:p,multiReferenceMode:f,purposeOverride:h})=>{const g=(0,t.useMemo)(()=>e.filter(e=>!1!==e.connected),[e]),b=(0,t.useMemo)(()=>Array.isArray(s)?s.map(e=>"string"==typeof e?e.trim().toUpperCase():"").filter(e=>e.length>0):[],[s]),w=(0,t.useMemo)(()=>{var e;if("string"==typeof l){const e=l.trim().toUpperCase();if(e&&b.includes(e))return e}return null!==(e=b[0])&&void 0!==e?e:""},[b,l]),v=(0,t.useMemo)(()=>Array.isArray(d)?d.map(e=>"string"==typeof e?e.trim().toUpperCase():"").filter(e=>e.length>0):[],[d]),y=(0,t.useMemo)(()=>{var e;if("string"==typeof c){const e=c.trim().toUpperCase();if(e&&v.includes(e))return e}return null!==(e=v[0])&&void 0!==e?e:""},[v,c]),_=(0,t.useMemo)(()=>{var t,n;if(i){const e=g.find(e=>e.slug===i);if(e)return e.slug}if(o){const t=g.find(e=>e.default_model===o);if(t)return t.slug;const n=e.find(e=>e.default_model===o);if(n){const e=g.find(e=>e.slug===n.slug);if(e)return e.slug}}return null!==(t=null!==(n=g[0]?.slug)&&void 0!==n?n:e[0]?.slug)&&void 0!==t?t:""},[g,e,i,o]),[x,C]=(0,t.useState)(_),[E,R]=(0,t.useState)([]),[S,j]=(0,t.useState)(""),[k,A]=(0,t.useState)(!1),[N,M]=(0,t.useState)(null),[P,O]=(0,t.useState)(w),[L,I]=(0,t.useState)(y),D=(0,t.useMemo)(()=>{var e;if(!S||!x)return!1;const t=S.toLowerCase();return(null!==(e=m[x])&&void 0!==e?e:[]).map(e=>e.toLowerCase()).includes(t)},[S,x]);(0,t.useEffect)(()=>{var e;x&&g.some(e=>e.slug===x)||C(_||(null!==(e=g[0]?.slug)&&void 0!==e?e:""))},[_,x,g]),(0,t.useEffect)(()=>{p>0||0===b.length?""!==P&&O(""):b.includes(P)||w!==P&&O(w)},[b,P,w,p]),(0,t.useEffect)(()=>{p>0||0===v.length||!D?""!==L&&I(""):v.includes(L)||y!==L&&I(y)},[v,L,y,p,D]),(0,t.useEffect)(()=>{if(!x)return void R([]);const e=null!=h?h:p>0?"edit":"generate";let t=!0;return A(!0),M(null),r()({path:`${a}/models?provider=${x}&purpose=${e}`}).then(e=>{if(!t)return;const n=e,a=Array.isArray(n?.models)?n.models:[];R(a),0!==a.length?o&&a.includes(o)?j(o):a.includes(S)||j(a[0]):j("")}).catch(e=>{var a;if(!t)return;const r=null!==(a=e?.message)&&void 0!==a?a:(0,n.__)("Failed to load models.","wp-banana");R([]),M(r),j("")}).finally(()=>{t&&A(!1)}),()=>{t=!1}},[x,a,o,p,h]);const T=(0,t.useMemo)(()=>{var e;if(!f)return E;const t=null!==(e=u[x])&&void 0!==e?e:[];if(0===t.length)return[];const n=new Set(t);return E.filter(e=>n.has(e))},[E,f,x]);(0,t.useEffect)(()=>{k||(0!==T.length?T.includes(S)||j(T[0]):f&&""!==S&&j(""))},[T,S,k,f]);const $=(0,t.useMemo)(()=>e.find(e=>e.slug===x),[x,e]),F=(0,t.useMemo)(()=>{var t;if($?.label)return $.label;const n=e.find(e=>e.slug===x);return null!==(t=n?.label)&&void 0!==t?t:x?x.toUpperCase():""},[x,e,$]),B=0===p&&b.length>0,G=0===p&&v.length>0&&D,U=(0,t.useMemo)(()=>{const e=B?P||(0,n.__)("Default aspect ratio","wp-banana"):"",t=$?.default_model?String($.default_model):"";let a=S||(k?(0,n.__)("Loading model…","wp-banana"):""!==t?t:(0,n.__)("Provider default model","wp-banana"));f&&0===T.length&&(a=(0,n.__)("No compatible model","wp-banana"));const r=p>0?(0,n.sprintf)((0,n._n)("%d reference","%d references",p,"wp-banana"),p):"";return{aspect:e,model:a,provider:F,references:r,fallback:e||a||F||r?"":(0,n.__)("Using provider defaults","wp-banana")}},[B,P,S,k,$,f,T,p,F]),q=(0,t.useMemo)(()=>T.length>0?""!==S&&T.includes(S):!f&&(""!==S||0===E.length),[T,S,f,E]);return{provider:x,setProvider:C,model:S,setModel:j,models:E,modelOptions:T,modelsLoading:k,loadError:N,aspectRatio:P,setAspectRatio:O,aspectRatioEnabled:B,aspectOptions:b,resolution:L,setResolution:I,resolutionEnabled:G,resolutionOptions:v,connectedProviders:g,selectedProviderConfig:$,summary:U,modelRequirementSatisfied:q,preferredAspectRatio:w,preferredResolution:y}},y=({limit:e=4,enableReferenceDragDrop:a=!1,onReferencesChange:r,allowSelection:o})=>{const[i,s]=(0,t.useState)([]),[l,d]=(0,t.useState)(null),[c,p]=(0,t.useState)(!1),u=(0,t.useRef)([]),m=(0,t.useRef)(null),f=(0,t.useRef)(0),g=!1!==o,b=(0,t.useCallback)(e=>{u.current=e,s(e),r&&r()},[r]);(0,t.useEffect)(()=>{u.current=i},[i]),(0,t.useEffect)(()=>()=>{u.current.forEach(e=>{e.revokeOnCleanup&&e.url&&window.URL.revokeObjectURL(e.url)})},[]);const w=(0,t.useCallback)(()=>{u.current.forEach(e=>{e.revokeOnCleanup&&e.url&&window.URL.revokeObjectURL(e.url)}),b([]),d(null)},[b]),v=(0,t.useCallback)(()=>{g&&m.current&&m.current.click()},[g]),y=(0,t.useCallback)(t=>{if(!Array.isArray(t)||0===t.length)return;const a=Array.isArray(u.current)?u.current:[];let r=Math.max(0,e-a.length),o=0,i=0;const s=[];if(t.forEach(e=>{if(!e?.type||!e.type.startsWith("image/"))return;if(i+=1,r<=0)return;const t=`${Date.now()}-${Math.random().toString(36).slice(2)}`,n=window.URL.createObjectURL(e);s.push({id:t,file:e,url:n,revokeOnCleanup:!0,filename:e.name,mimeType:e.type}),r-=1,o+=1}),o>0){const e=[...a,...s];b(e),d(i>o?(0,n.__)("You can upload up to 4 reference images.","wp-banana"):null)}else i>0&&d((0,n.__)("You can upload up to 4 reference images.","wp-banana"))},[b,e]),_=(0,t.useCallback)(e=>{if(!g)return void(e.target.value="");const t=e.target.files;t&&t.length>0&&y(Array.from(t)),e.target.value=""},[y,g]),x=(0,t.useCallback)(e=>{const t=i.filter(t=>t.id!==e||(t.revokeOnCleanup&&t.url&&window.URL.revokeObjectURL(t.url),!1));b(t),d(null)},[i,b]),C=(0,t.useCallback)(async()=>{const e=Array.isArray(u.current)?[...u.current]:[],t=[];let a=!1;for(let r=0;r<e.length;r+=1){const o=e[r];if(o.file instanceof File){t.push(o.file);continue}if(!o.sourceUrl)throw new Error((0,n.__)("Could not load the selected images.","wp-banana"));let i;try{i=await window.fetch(o.sourceUrl,{credentials:"same-origin"})}catch(e){throw new Error((0,n.__)("Could not load the selected images.","wp-banana"))}if(!i.ok)throw new Error((0,n.__)("Could not load the selected images.","wp-banana"));const s=await i.blob(),l=s.type||o.mimeType||"image/png",d=h(o.filename,r+1,l),c=new File([s],d,{type:l});e[r]={...o,file:c,mimeType:l},t.push(c),a=!0}return a&&b(e),u.current=e,t},[b]),E=(0,t.useCallback)(t=>{if(w(),!Array.isArray(t)||0===t.length)return;const a=[];t.slice(0,e).forEach(e=>{if(!e.sourceUrl||0===e.sourceUrl.length)return;const t=`${Date.now()}-${Math.random().toString(36).slice(2)}`,n=e.sourceUrl,r=e.previewUrl&&e.previewUrl.length>0?e.previewUrl:n;a.push({id:t,url:r,sourceUrl:n,filename:e.filename,mimeType:e.mime})}),b(a),t.length>e&&d((0,n.__)("Only the first 4 selected images were attached as references.","wp-banana"))},[b,e,w]);(0,t.useEffect)(()=>{const e=e=>{if(!e)return;const t=window,n=t.wpBananaReferenceQueue;if(!Array.isArray(n)||0===n.length)return;const a=n.indexOf(e);a>=0&&n.splice(a,1),0===n.length&&delete t.wpBananaReferenceQueue},t=t=>{const n=t,a=n.detail?.references;Array.isArray(a)&&0!==a.length?(e(a),E(a)):e(a)};return(()=>{const e=window,t=e.wpBananaReferenceQueue;if(Array.isArray(t)&&0!==t.length){for(;t.length>0;){const e=t.shift();Array.isArray(e)&&e.length>0&&E(e)}delete e.wpBananaReferenceQueue}})(),window.addEventListener("wp-banana:set-reference-images",t),()=>{window.removeEventListener("wp-banana:set-reference-images",t)}},[E]),(0,t.useEffect)(()=>{if(!a||!g)return;const e=e=>{const t=e.dataTransfer?.types;return!!t&&Array.from(t).includes("Files")},t=t=>{e(t)&&(t.preventDefault(),t.stopPropagation(),f.current+=1,p(!0))},n=t=>{e(t)&&(t.preventDefault(),t.stopPropagation(),t.dataTransfer&&(t.dataTransfer.dropEffect="copy"),p(!0))},r=()=>{f.current=0,p(!1)},o=t=>{e(t)&&(t.preventDefault(),t.stopPropagation(),f.current=Math.max(0,f.current-1),0===f.current&&p(!1))},i=t=>{if(!e(t))return;t.preventDefault(),t.stopPropagation();const n=t.dataTransfer,a=n?Array.from(n.files||[]):[];if(a.length>0&&y(a),n)try{n.clearData()}catch(e){}r()},s=t=>{e(t)&&r()};return window.addEventListener("dragenter",t),window.addEventListener("dragover",n),window.addEventListener("dragleave",o),window.addEventListener("drop",i),window.addEventListener("dragend",s),()=>{window.removeEventListener("dragenter",t),window.removeEventListener("dragover",n),window.removeEventListener("dragleave",o),window.removeEventListener("drop",i),window.removeEventListener("dragend",s),r()}},[y,a,g]);const R=(0,t.useMemo)(()=>a&&c,[a,c]);return{fileInputRef:m,referenceImages:i,referenceError:l,setReferenceError:d,referenceCount:i.length,addReferenceFiles:y,removeReference:x,handleReferenceSelection:_,triggerReferenceDialog:v,resetReferenceImages:w,prepareReferenceFiles:C,dropOverlayVisible:R,isDraggingFiles:c}},_=({providers:e,restNamespace:a,onComplete:u,defaultGeneratorModel:m,defaultGeneratorProvider:f,aspectRatioOptions:h,defaultAspectRatio:b,resolutionOptions:_,defaultResolution:x,enableReferenceDragDrop:C=!1})=>{const[E,R]=(0,t.useState)(""),[S,j]=(0,t.useState)(null),[k,A]=(0,t.useState)(!1),[N,M]=(0,t.useState)(!1),[P,O]=(0,t.useState)(!1),L=(0,t.useCallback)(()=>{j(null)},[]),{fileInputRef:I,referenceImages:D,referenceError:T,setReferenceError:$,referenceCount:F,removeReference:B,handleReferenceSelection:G,triggerReferenceDialog:U,resetReferenceImages:q,prepareReferenceFiles:H,dropOverlayVisible:V}=y({enableReferenceDragDrop:C,onReferencesChange:L}),W=F>1,{provider:z,setProvider:K,model:J,setModel:Q,modelOptions:Y,modelsLoading:X,loadError:Z,aspectRatio:ee,setAspectRatio:te,aspectRatioEnabled:ne,aspectOptions:ae,resolution:re,setResolution:oe,resolutionEnabled:ie,resolutionOptions:se,connectedProviders:le,summary:de,modelRequirementSatisfied:ce,preferredAspectRatio:pe,preferredResolution:ue}=v({providers:e,restNamespace:a,defaultGeneratorModel:m,defaultGeneratorProvider:f,aspectRatioOptions:h,defaultAspectRatio:b,resolutionOptions:_,defaultResolution:x,referenceCount:F,multiReferenceMode:W}),me=(0,t.useCallback)(()=>{document.dispatchEvent(new CustomEvent("wp-banana:media-refresh"))},[]),{previewItems:fe,selectedPreview:he,selectedPreviewSrc:ge,activePreviewId:be,setActivePreviewId:we,previewAction:ve,canSaveSelected:ye,canDiscardSelected:_e,resetPreviewArea:xe,startVariations:Ce,savePreview:Ee,discardPreview:Re,undoPreview:Se}=(({restNamespace:e,dispatchMediaRefresh:a})=>{const[o,i]=(0,t.useState)([]),[s,l]=(0,t.useState)(null),[d,c]=(0,t.useState)(null),p=(0,t.useRef)([]),u=(0,t.useRef)([]),m=(0,t.useRef)(!1),f=(0,t.useRef)({successes:0,errors:[]});(0,t.useEffect)(()=>{p.current=o},[o]);const h=(0,t.useCallback)(()=>{0!==u.current.length&&(u.current.forEach(e=>window.clearTimeout(e)),u.current=[])},[]);(0,t.useEffect)(()=>()=>{m.current=!0,h()},[h]);const b=(0,t.useCallback)(()=>{m.current=!0,h(),i([]),p.current=[],l(null),c(null),f.current={successes:0,errors:[]}},[h]),w=(0,t.useCallback)(e=>{0===e.length&&b()},[b]),v=(0,t.useCallback)(({count:e,prompt:t,multiReferenceMode:a,modelOptions:r,sendGenerateRequest:o,onSuccessReset:s,setReferenceError:d,setSubmitError:p,setIsSubmitting:w})=>{var v;const y=Math.max(1,Math.min(4,e)),_=t.trim();if(_.length<3)return void p((0,n.__)("Please enter a longer prompt.","wp-banana"));if(a&&0===r.length)return void p((0,n.__)("Choose a model that supports multiple reference images.","wp-banana"));m.current=!1,h(),p(null),d(null),c(null),f.current={successes:0,errors:[]};const x=Date.now(),C=Array.from({length:y}).map((e,t)=>({id:`${x}-${t}-${Math.random().toString(36).slice(2,10)}`,index:t,status:"queued"}));i(C),l(null!==(v=C[0]?.id)&&void 0!==v?v:null),w(!0);const E=_,R=C.map((e,t)=>new Promise(a=>{const r=window.setTimeout(async()=>{if(m.current)a();else{i(t=>t.map(t=>t.id===e.id?{...t,status:"loading"}:t));try{var t,r,s,d,p,u,h;const c=await o(E,!0);if(m.current)return void a();const b=c?.preview,w=null!==(t=c?.context)&&void 0!==t?t:{};if(!b?.data)throw new Error((0,n.__)("Failed to generate image.","wp-banana"));const v={provider:null!==(r=w.provider)&&void 0!==r?r:"",model:w.model,format:null!==(s=w.format)&&void 0!==s?s:g(b.mime),prompt:null!==(d=w.prompt)&&void 0!==d?d:E,filenameBase:null!==(p=null!==(u=w.filename_base)&&void 0!==u?u:w.filenameBase)&&void 0!==p?p:"",title:null!==(h=w.title)&&void 0!==h?h:""};i(t=>t.map(t=>{var n,a;return t.id===e.id?{...t,status:"complete",data:null!==(n=b.data)&&void 0!==n?n:"",mime:null!==(a=b.mime)&&void 0!==a?a:"image/png",width:b.width,height:b.height,bytes:b.bytes,context:v,error:void 0}:t})),f.current.successes+=1,l(t=>null!=t?t:e.id)}catch(t){var b;if(m.current)return void a();const r=t,o=null!==(b=r?.message)&&void 0!==b?b:(0,n.__)("Failed to generate image.","wp-banana");f.current.errors.push(o),i(t=>t.map(t=>t.id===e.id?{...t,status:"error",error:o}:t)),c({message:o,type:"error"})}finally{a()}}},1e3*t);u.current.push(r)}));Promise.all(R).then(()=>{h(),m.current||(f.current.successes>0?s():(b(),f.current.errors.length>0&&p(f.current.errors[0])),w(!1))})},[h,b]),y=(0,t.useCallback)(async t=>{const o=p.current.find(e=>e.id===t);if(o&&("complete"===o.status||"error"===o.status)&&o.data&&o.context){c(null),i(e=>e.map(e=>e.id===t?{...e,status:"saving",error:void 0}:e));try{var s;const l=await r()({path:`${e}/generate/save-preview`,method:"POST",data:{data:o.data,provider:o.context.provider,model:null!==(s=o.context.model)&&void 0!==s?s:"",format:o.context.format,mime:o.mime,prompt:o.context.prompt,filename_base:o.context.filenameBase,title:o.context.title}});i(e=>{const n=e.map(e=>e.id===t?{...e,status:"saved",attachmentId:l?.attachment_id,url:l?.url,error:void 0}:e);return w(n),n}),c({message:(0,n.__)("Image saved to Media Library.","wp-banana"),type:"success"}),a()}catch(e){var l;const a=e,r=null!==(l=a?.message)&&void 0!==l?l:(0,n.__)("Failed to save image.","wp-banana");i(e=>e.map(e=>e.id===t?{...e,status:"error",error:r}:e)),c({message:r,type:"error"})}}},[e,w,a]),_=(0,t.useCallback)(e=>{const t=Array.isArray(p.current)?p.current:[],a=t.find(t=>t.id===e)||null,r=t.filter(t=>t.id!==e);if(i(r),p.current=r,0===r.length?l(null):s===e&&l(r[0].id),w(r),a){const e={...a,status:"complete"};c({message:(0,n.__)("Deleted.","wp-banana"),type:"warning",undo:e})}else c({message:(0,n.__)("Deleted.","wp-banana"),type:"warning"})},[s,w]),x=(0,t.useCallback)(()=>{const e=d?.undo;e&&(i(t=>{if(t.some(t=>t.id===e.id))return t;const n=[e,...t];return n.sort((e,t)=>e.index-t.index),n}),l(e.id),c(null))},[d]),C=(0,t.useMemo)(()=>{if(0===o.length)return null;const e=o.find(e=>e.id===s);return null!=e?e:o[0]},[o,s]),E=C&&C.data&&C.mime?`data:${C.mime};base64,${C.data}`:"",R=!!C&&("complete"===C.status||"error"===C.status),S=!!C&&"saving"!==C.status&&"saved"!==C.status;return{previewItems:o,selectedPreview:C,selectedPreviewSrc:E,activePreviewId:s,setActivePreviewId:l,previewAction:d,setPreviewAction:c,canSaveSelected:R,canDiscardSelected:S,resetPreviewArea:b,startVariations:v,savePreview:y,discardPreview:_,undoPreview:x}})({restNamespace:a,dispatchMediaRefresh:me}),je=(0,t.useMemo)(()=>!(k||X||E.trim().length<3||""===z||!ce||ne&&""===ee),[k,X,E,z,ce,ne,ee]),ke=(0,t.useCallback)(async(e,t)=>{if(F>0){let o=[];try{o=await H()}catch(e){throw $((0,n.__)("Could not load the selected images.","wp-banana")),e}const i=new window.FormData;return i.append("prompt",e),i.append("provider",z),J&&i.append("model",J),t&&i.append("preview_only","1"),o.forEach(e=>{i.append("reference_images[]",e,e.name)}),r()({path:`${a}/generate`,method:"POST",body:i})}const o={prompt:e,provider:z};return J&&(o.model=J),ne&&ee&&(o.aspect_ratio=ee),ie&&re&&(o.resolution=re),t&&(o.preview_only="1"),r()({path:`${a}/generate`,method:"POST",data:o})},[F,H,$,z,J,a,ne,ee,ie,re]),Ae=(0,t.useCallback)(async()=>{const e=E.trim();if(e.length<3)j((0,n.__)("Please enter a longer prompt.","wp-banana"));else if(W&&0===Y.length)j((0,n.__)("Choose a model that supports multiple reference images.","wp-banana"));else{j(null),$(null),A(!0);try{await ke(e,!1),R(""),ne&&te(pe),ie&&oe(ue),M(!1),q(),me(),u()}catch(e){const t=e;t?.message?j(t.message):e instanceof Error&&e.message?j(e.message):j((0,n.__)("Failed to generate image.","wp-banana"))}finally{A(!1)}}},[E,W,Y,$,ke,ne,pe,ie,ue,q,me,u]),Ne=(0,t.useCallback)(e=>{"Enter"===e.key&&(e.metaKey||e.ctrlKey)&&(e.preventDefault(),je&&!k&&Ae())},[je,k,Ae]),Me=(0,t.useRef)(null);(0,t.useEffect)(()=>{if(!P)return;const e=e=>{Me.current&&e.target instanceof Node&&!Me.current.contains(e.target)&&O(!1)};return document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[P]);const Pe=(0,t.useCallback)(()=>{!k&&je&&O(e=>!e)},[k,je]),Oe=(0,t.useCallback)(()=>{R(""),ne&&te(pe),ie&&oe(ue),q(),M(!1)},[ne,pe,ie,ue,q]),Le=(0,t.useCallback)(e=>{O(!1),k||Ce({count:e,prompt:E,multiReferenceMode:W,modelOptions:Y,sendGenerateRequest:ke,onSuccessReset:Oe,setReferenceError:$,setSubmitError:j,setIsSubmitting:A})},[k,Ce,E,W,Y,ke,Oe,$,j]),Ie=(0,i.jsx)(c,{isOpen:P,options:p,onSelect:Le});return(0,i.jsx)(o.Card,{children:(0,i.jsxs)(o.CardBody,{children:[Z&&(0,i.jsx)(o.Notice,{status:"error",isDismissible:!1,children:Z}),S&&(0,i.jsx)(o.Notice,{status:"error",isDismissible:!1,children:S}),T&&(0,i.jsx)(o.Notice,{status:"warning",isDismissible:!1,children:T}),W&&!X&&0===Y.length&&(0,i.jsx)(o.Notice,{status:"warning",isDismissible:!1,children:(0,n.__)("Switch to a supported model to send multiple reference images.","wp-banana")}),(0,i.jsx)(s,{prompt:E,onPromptChange:R,onPromptKeyDown:Ne,isSubmitting:k,canSubmit:je,onSubmit:Ae,onReferenceClick:U,showOptions:N,onToggleOptions:()=>M(e=>!e),summary:de,variationMenuRef:Me,onVariationToggle:Pe,isVariationMenuOpen:P,variationMenu:Ie,enableReferenceDragDrop:C,dropOverlayVisible:V,referenceTray:(0,i.jsx)(d,{referenceImages:D,onRemove:B,fileInputRef:I,onReferenceSelection:G})}),(0,i.jsx)(l,{show:N,connectedProviders:le,provider:z,onProviderChange:K,model:J,onModelChange:Q,modelOptions:Y,modelsLoading:X,aspectRatioEnabled:ne,aspectRatio:ee,onAspectRatioChange:te,aspectOptions:ae,resolutionEnabled:ie,resolution:re,onResolutionChange:oe,resolutionOptions:se,isSubmitting:k}),(0,i.jsx)(w,{previewItems:fe,selectedPreview:he,selectedPreviewSrc:ge,onSelect:we,previewAction:ve,onUndo:Se,onClear:xe,canSaveSelected:ye,canDiscardSelected:_e,onSave:Ee,onDiscard:Re})]})})},x=new WeakMap,C=()=>{const e=window,t=e.wp?.media,n=t?.frame;if(!n)return;const a=[],r="function"==typeof n.state?n.state():null,o=r&&"function"==typeof r.get?r.get("library"):null;o&&a.push(o),n.library&&a.push(n.library);const i="function"==typeof n.content?.get?n.content.get():null;i?.collection&&a.push(i.collection),a.forEach(e=>{if(!e)return;"function"==typeof e.props?.set&&e.props.set({ignore:Date.now()});const t=(()=>{if("function"==typeof e.url)try{return e.url()}catch(e){return""}return e.url})();"string"==typeof t&&t.length>0&&("function"!=typeof e.more?"function"==typeof e.fetch&&e.fetch():e.more())}),"function"==typeof n.trigger&&n.trigger("library:refresh")};"undefined"!=typeof document&&document.addEventListener("wp-banana:media-refresh",()=>{C()});const E=(e,a)=>{if(e.querySelector(".media-menu-item.wp-banana-media-tab"))return;let r=null;const o=e.querySelector(".media-router"),s=e.querySelector(".media-frame-content");if(!o||!s)return;const l=`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`,d=`wp-banana-generate-tab-${l}`,c=`wp-banana-generate-panel-${l}`,p=document.createElement("button");p.type="button",p.id=d,p.className="media-menu-item wp-banana-media-tab",p.textContent=(0,n.__)("Generate Image","wp-banana"),p.setAttribute("role","tab"),p.setAttribute("aria-selected","false"),p.setAttribute("aria-controls",c),p.dataset.wpBanana="1",o.appendChild(p);const u=()=>{const e=document.createElement("div");return e.className="wp-banana-media-panel",e.id=c,e.setAttribute("role","tabpanel"),e.setAttribute("aria-labelledby",d),e.setAttribute("hidden","hidden"),e.setAttribute("aria-hidden","true"),e.style.display="none",s.appendChild(e),e};r=u();let m=!1;const f=()=>{e.classList.remove("wp-banana-media-tab-active"),p.classList.remove("active"),p.setAttribute("aria-selected","false"),r&&r.isConnected&&(r.setAttribute("hidden","hidden"),r.setAttribute("aria-hidden","true"),r.style.display="none")};o.addEventListener("click",n=>{const s=n.target,l=s?.closest(".media-menu-item");if(l)return l===p?(n.preventDefault(),n.stopPropagation(),n.stopImmediatePropagation(),void(()=>{r&&r.isConnected||(r&&x.delete(r),r=u(),m=!1),m||(((e,n,a)=>{const r=window,o=r.wp?.element;if("function"==typeof o?.createRoot){let t=x.get(e);return t||(t=o.createRoot(e),x.set(e,t)),void t.render((0,i.jsx)(_,{providers:n.providers,restNamespace:n.restNamespace,onComplete:a,defaultGeneratorModel:n.defaultGeneratorModel,defaultGeneratorProvider:n.defaultGeneratorProvider,defaultAspectRatio:n.defaultAspectRatio,aspectRatioOptions:n.aspectRatioOptions,defaultResolution:n.defaultResolution,resolutionOptions:n.resolutionOptions}))}(0,t.render)((0,i.jsx)(_,{providers:n.providers,restNamespace:n.restNamespace,onComplete:a,defaultGeneratorModel:n.defaultGeneratorModel,defaultGeneratorProvider:n.defaultGeneratorProvider,defaultAspectRatio:n.defaultAspectRatio,aspectRatioOptions:n.aspectRatioOptions,defaultResolution:n.defaultResolution,resolutionOptions:n.resolutionOptions}),e)})(r,a,()=>{C(),(()=>{const e=o.querySelector("#menu-item-browse")||o.querySelector('.media-menu-item[data-router="browse"]')||o.querySelector('.media-menu-item[data-router="library"]')||o.querySelector(".media-menu-item:not(.wp-banana-media-tab)");e&&e!==p?(f(),"function"==typeof e.click&&e.click()):f()})()}),m=!0),r.removeAttribute("hidden"),r.removeAttribute("aria-hidden"),r.style.display="block",o.querySelectorAll(".media-menu-item").forEach(e=>{const t=e===p;e.classList.toggle("active",t),e.setAttribute("aria-selected",t?"true":"false")}),e.classList.add("wp-banana-media-tab-active");const n=r.querySelector("textarea");n&&setTimeout(()=>n.focus(),50)})()):void f()});const h=e.querySelector(".media-modal-close");h&&h.addEventListener("click",f);const g=e.nextElementSibling;g&&g.classList.contains("media-modal-backdrop")&&g.addEventListener("click",f),new MutationObserver(()=>{("none"===e.style.display||"true"===e.getAttribute("aria-hidden"))&&f()}).observe(e,{attributes:!0,attributeFilter:["style","class","aria-hidden"]}),f()},R=()=>{const e=(()=>{const e=window.wpBananaMedia;if(!e||!Array.isArray(e.providers))return null;const t=e.providers.filter(e=>!1!==e.connected);return 0===t.length?null:{restNamespace:e.restNamespace,providers:t,defaultGeneratorModel:e.defaultGeneratorModel,defaultGeneratorProvider:e.defaultGeneratorProvider,defaultAspectRatio:e.defaultAspectRatio,aspectRatioOptions:e.aspectRatioOptions,defaultResolution:e.defaultResolution,resolutionOptions:e.resolutionOptions,multiImageModelAllowlist:e.multiImageModelAllowlist,resolutionModelAllowlist:e.resolutionModelAllowlist}})();if(!e)return;const t=t=>E(t,e);document.querySelectorAll(".media-modal").forEach(t),new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.forEach(e=>{e instanceof HTMLElement&&(e.matches(".media-modal")?t(e):e.querySelectorAll(".media-modal").forEach(e=>{t(e)}))})})}).observe(document.body,{childList:!0,subtree:!0})};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",R):R();const S={generate:(0,n.__)("Generated","wp-banana"),edit:(0,n.__)("Edited","wp-banana")},j={new:(0,n.__)("New copy","wp-banana"),replace:(0,n.__)("Replaced original","wp-banana"),save_as:(0,n.__)("Saved as copy","wp-banana"),buffer:(0,n.__)("Buffered edit","wp-banana")},k=(e,t,n)=>{const a=document.createElement("div");a.className=e;const r=document.createElement("strong");return r.textContent=t,a.appendChild(r),a.appendChild(document.createTextNode(" ")),n.forEach(e=>{"string"!=typeof e?a.appendChild(e):a.appendChild(document.createTextNode(e))}),a},A=e=>{if("number"==typeof e&&Number.isFinite(e))return e;if("string"==typeof e){const t=parseInt(e,10);if(!Number.isNaN(t))return t}return null},N=e=>{const t=e?.el;if(!(t&&t instanceof HTMLElement))return;const a=t.querySelector(".details");if(!a)return;const r=a.querySelector(".wp-banana-ai-details");r&&r.remove();const o=e?.model?.toJSON?e.model.toJSON():null;if(!o||"object"!=typeof o)return;const i=o.wpBanana;if(!i)return;if(!Boolean(i.isGenerated||i.derivedFrom||i.historyCount&&i.historyCount>0||i.lastPrompt&&""!==i.lastPrompt.trim()))return;const s=document.createElement("div");s.className="wp-banana-ai-details";const l=A(o.id),d=A(i.derivedFrom?.id),c=null!==l&&null!==d&&l===d;if(i.derivedFrom&&i.derivedFrom.id&&!c){var p;const e=document.createElement("a");e.href=i.derivedFrom.editLink||i.derivedFrom.viewLink||"#",e.textContent=null!==(p=i.derivedFrom.title)&&void 0!==p?p:`#${i.derivedFrom.id}`,e.target="_blank",e.rel="noopener noreferrer";const t=k("wp-banana-ai-details__item",(0,n.__)("Derived from:","wp-banana"),[e]);s.appendChild(t)}if(i.historyCount&&i.historyCount>0&&Array.isArray(i.history)){const e=document.createElement("button");e.type="button",e.className="button-link wp-banana-history-toggle";const t=(0,n.sprintf)((0,n._n)("View history (%d entry)","View history (%d entries)",i.historyCount,"wp-banana"),i.historyCount),a=(0,n.__)("Hide history","wp-banana");e.textContent=t,e.setAttribute("aria-expanded","false");const r=(e=>{const t=document.createElement("div");t.className="wp-banana-history-list";const a=document.createElement("ul");a.className="wp-banana-history-list__items";const r=[...e].reverse();if(r.forEach(e=>{var t;const r=document.createElement("li");r.className="wp-banana-history-list__item";const o=[],i=e.type?null!==(t=S[e.type])&&void 0!==t?t:e.type:"";i&&o.push(i);const s=e.provider?(e=>{var t;if(!e)return"";const n=(()=>{const e=window;return e.wpBananaMedia&&Array.isArray(e.wpBananaMedia.providers)?e.wpBananaMedia.providers:[]})().find(t=>t.slug===e);return null!==(t=n?.label)&&void 0!==t?t:e})(e.provider):"";if(s&&o.push((0,n.sprintf)((0,n.__)("via %s","wp-banana"),s)),e.model&&o.push(e.model),e.mode){var l;const t=null!==(l=j[e.mode])&&void 0!==l?l:e.mode;o.push(t)}if(o.length>0){const e=document.createElement("span");e.className="wp-banana-history-list__summary",e.textContent=o.join(", "),e.style.display="block",r.appendChild(e)}const d=[],c=(e=>{if(!e||Number.isNaN(e))return"";try{const t=new Date(1e3*e);return new Intl.DateTimeFormat(void 0,{year:"numeric",month:"short",day:"2-digit",hour:"numeric",minute:"2-digit"}).format(t)}catch(e){return""}})(e.timestamp);if(c&&d.push(c),e.user?.name&&d.push((0,n.sprintf)((0,n.__)("by %s","wp-banana"),e.user.name)),d.length>0){const e=document.createElement("span");e.className="wp-banana-history-list__meta",e.textContent=d.join(" · "),r.appendChild(e)}if(e.derivedFrom&&e.derivedFrom.id){var p;const t=document.createElement("div");t.className="wp-banana-history-list__derived";const a=document.createElement("a");a.href=e.derivedFrom.editLink||e.derivedFrom.viewLink||"#",a.textContent=null!==(p=e.derivedFrom.title)&&void 0!==p?p:`#${e.derivedFrom.id}`,a.target="_blank",a.rel="noopener noreferrer",t.appendChild(document.createTextNode((0,n.__)("Source:","wp-banana")+" ")),t.appendChild(a),r.appendChild(t)}if(e.prompt&&""!==e.prompt.trim()){const t=document.createElement("div");t.className="wp-banana-history-list__prompt",t.textContent=e.prompt.trim(),r.appendChild(t)}a.appendChild(r)}),0===r.length){const e=document.createElement("li");e.className="wp-banana-history-list__item is-empty",e.textContent=(0,n.__)("No AI history events recorded yet.","wp-banana"),a.appendChild(e)}return t.appendChild(a),t})(i.history);r.style.display="none",e.addEventListener("click",n=>{n.preventDefault();const o=!("true"===e.getAttribute("aria-expanded"));e.setAttribute("aria-expanded",o?"true":"false"),e.textContent=o?a:t,r.style.display=o?"block":"none"});const o=k("wp-banana-ai-details__item wp-banana-ai-details__history",(0,n.__)("AI history:","wp-banana"),[e]);o.appendChild(r),s.appendChild(o)}else if(!1===i.historyEnabled){const e=k("wp-banana-ai-details__item",(0,n.__)("AI history:","wp-banana"),[(0,n.__)("History tracking is disabled for this site.","wp-banana")]);s.appendChild(e)}a.insertBefore(s,a.firstChild)},M=()=>{const e=window,t=e.wp?.media?.view?.Attachment?.Details;if(!t)return;if(t.__wpBananaDetailsPatched)return;const n=t.prototype?.render;if("function"==typeof n){if(t.prototype.render=function(...e){const t=n.apply(this,e);return N(this),t},t.TwoColumn){const e=t.TwoColumn.prototype?.render;"function"==typeof e&&(t.TwoColumn.prototype.render=function(...t){const n=e.apply(this,t);return N(this),n})}t.__wpBananaDetailsPatched=!0}},P=()=>{M()};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",P):P();const O="banana",L="wp-banana-ai-notice",I="wp-banana-history-change",D=e=>e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"),T=(e,t,a,r,o)=>{var i;const s=document.getElementById(`imgedit-response-${e}`);if(!s)return;const l="success"===t?"notice notice-success":"notice notice-error",d=!1!==o?.openInNewTab,c=null!==(i=o?.label)&&void 0!==i?i:(0,n.__)("Open image in new tab","wp-banana");let p=`<div class="${l}" tabindex="-1" role="alert"><p>${D(a)}`;if(r){const e=d?' target="_blank" rel="noopener noreferrer"':"";p+=` <a href="${D(r)}"${e}><em>${D(c)}</em></a>`}p+="</p></div>",s.innerHTML=p;const u=window.wp?.a11y?.speak;"function"==typeof u&&u(a)},$=()=>{const e=window.imageEdit,t=window.jQuery;if(!e||!t||e.__wpBananaPatched)return;const n=e=>{"number"!=typeof e||Number.isNaN(e)||document.dispatchEvent(new CustomEvent(I,{detail:{attachmentId:e}}))};if(e.filterHistory=function(e,n){const a=t(`#imgedit-history-${e}`),r=t(`#imgedit-undone-${e}`),o=a.val();if(""===o||null==o)return n&&(this.hold.w=this.hold.ow,this.hold.h=this.hold.oh),"";let i;try{i=JSON.parse(o)}catch(e){return""}let s=parseInt(r.val()||"0",10);if(s>0&&(i=i.slice(0,i.length-s)),n){if(0===i.length)return this.hold.w=this.hold.ow,this.hold.h=this.hold.oh,"";const e=i[i.length-1];if(e){const t=e[O];if(t&&void 0!==t.fw)this.hold.w=t.fw,this.hold.h=t.fh;else{const t=e.c,n=e.r,a=e.f,r=t||n||a;r&&void 0!==r.fw&&void 0!==r.fh&&(this.hold.w=r.fw,this.hold.h=r.fh)}}}const l=[];for(let e=0;e<i.length;e++){const t=i[e];if(t&&t.c){const n=t.c;l[e]={c:{x:n.x,y:n.y,w:n.w,h:n.h,r:n.r}}}else if(t&&t.r){const n=t.r;l[e]={r:n.r}}else if(t&&t.f){const n=t.f;l[e]={f:n.f}}else if(t&&t[O]){const n=t[O];l[e]={type:"banana",[O]:{key:n.key,fw:n.fw,fh:n.fh,mime:n.mime||""}}}}return JSON.stringify(l)},e.__wpBananaPatched=!0,!e.__wpBananaHistoryPatched){const t="function"==typeof e.addStep?e.addStep:null;t&&(e.addStep=function(e,a,r){const o=t.call(this,e,a,r);return n(a),o});const a="function"==typeof e.undo?e.undo:null;a&&(e.undo=function(e,t){const r=a.call(this,e,t);return n(e),r});const r="function"==typeof e.redo?e.redo:null;r&&(e.redo=function(e,t){const a=r.call(this,e,t);return n(e),a}),e.__wpBananaHistoryPatched=!0}},F=({attachmentId:e,providers:a,restNamespace:c,defaultEditorModel:p,defaultEditorProvider:m})=>{var f;const[h,g]=(0,t.useState)(""),[b,w]=(0,t.useState)(null),[_,x]=(0,t.useState)(!1),[C,E]=(0,t.useState)(null),[R,S]=(0,t.useState)(!1),{fileInputRef:j,referenceImages:k,referenceError:A,setReferenceError:N,referenceCount:M,removeReference:P,handleReferenceSelection:I,triggerReferenceDialog:D,resetReferenceImages:T,prepareReferenceFiles:F}=y({onReferencesChange:()=>w(null)}),B=M>0,{provider:G,setProvider:U,model:q,setModel:H,modelOptions:V,models:W,modelsLoading:z,loadError:K,connectedProviders:J,selectedProviderConfig:Q,summary:Y,modelRequirementSatisfied:X}=v({providers:a,restNamespace:c,defaultGeneratorModel:p,defaultGeneratorProvider:m,referenceCount:M,multiReferenceMode:B,purposeOverride:"edit"});(0,t.useEffect)(()=>{const e=e=>{const t=e;t.detail&&E(t.detail)};return document.addEventListener(L,e),()=>{document.removeEventListener(L,e)}},[]);const Z=(0,t.useMemo)(()=>((e,{model:t,availableModels:n=[],fallbackModels:a=[]}={})=>{var r;const o=null!==(r=u[e])&&void 0!==r?r:[];if(0===o.length)return!1;const i=[];return t&&i.push(t),a.filter(e=>"string"==typeof e&&e.length>0).forEach(e=>i.push(e)),0===i.length&&n.length>0?n.some(e=>o.includes(e)):i.some(e=>o.includes(e))})(G,{model:q,availableModels:W,fallbackModels:[Q?.default_model,p]}),[G,q,W,Q,p]),ee=(0,t.useMemo)(()=>!(_||z||h.trim().length<3||""===G||!X),[_,z,h,G,X]),te=(0,t.useCallback)(()=>{Z?D():N((0,n.__)("Switch to a supported model to send multiple reference images.","wp-banana"))},[Z,D,N]),ne=(0,t.useCallback)(e=>{Z?I(e):e.target.value=""},[Z,I]),ae=(0,t.useCallback)(async()=>{const t=h.trim();if(t.length<3)w((0,n.__)("Please enter a longer prompt.","wp-banana"));else if(B&&0===V.length)w((0,n.__)("Choose a model that supports multiple reference images.","wp-banana"));else{w(null),N(null),E(null),x(!0),E(null);try{let u;const m=(e=>{const t=(e=>{const t=document.getElementById(`imgedit-history-${e}`);if(!t)return[];const n=(e=>{if(!e)return[];try{const t=JSON.parse(e);return Array.isArray(t)?t:[]}catch(e){return[]}})(t.value||"");if(0===n.length)return n;const a=document.getElementById(`imgedit-undone-${e}`);if(!a||!a.value)return n;const r=parseInt(a.value,10);return Number.isNaN(r)||r<=0?n:n.slice(0,Math.max(0,n.length-r))})(e);for(let e=t.length-1;e>=0;e-=1){const n=t[e];if(!n||"object"!=typeof n)continue;const a=n[O];if(a&&"object"==typeof a){const e=a.key;if("string"==typeof e&&e.length>0)return e}}return null})(e);if(M>0){let a=[];try{a=await F()}catch(e){throw N((0,n.__)("Could not load the selected images.","wp-banana")),e}const o=new window.FormData;o.append("attachment_id",String(e)),o.append("prompt",t),o.append("provider",G),q&&o.append("model",q),o.append("save_mode","buffer"),m&&o.append("base_buffer_key",m),a.forEach(e=>{o.append("reference_images[]",e,e.name)}),u=await r()({path:`${c}/edit`,method:"POST",body:o})}else{const n={attachment_id:e,prompt:t,provider:G,model:q,save_mode:"buffer"};m&&(n.base_buffer_key=m),u=await r()({path:`${c}/edit`,method:"POST",data:n})}const f=u;if(f&&"string"==typeof f.buffer_key){var a,o,i,s,l,d,p;const r={buffer_key:f.buffer_key,width:null!==(a=f.width)&&void 0!==a?a:0,height:null!==(o=f.height)&&void 0!==o?o:0,mime:null!==(i=f.mime)&&void 0!==i?i:"image/png",attachment_id:null!==(s=f.attachment_id)&&void 0!==s?s:e,provider:null!==(l=f.provider)&&void 0!==l?l:G,model:null!==(d=f.model)&&void 0!==d?d:q,prompt:null!==(p=f.prompt)&&void 0!==p?p:t};try{(e=>{$();const t=window.imageEdit;if(!t)throw new Error((0,n.__)("Image editor not ready.","wp-banana"));const a=document.getElementById(`imgedit-nonce-${e.attachment_id}`);if(!a||""===a.value)throw new Error((0,n.__)("Editor security token missing.","wp-banana"));const r={key:e.buffer_key,fw:e.width,fh:e.height,mime:e.mime};e.provider&&(r.provider=e.provider),e.model&&(r.model=e.model),e.prompt&&(r.prompt=e.prompt),t.addStep({type:"banana",[O]:r},e.attachment_id,a.value)})(r),E({type:"success",message:(0,n.__)("AI edit applied. Use Save Edits or Save As to keep these changes.","wp-banana")}),g(""),T()}catch(e){const t=e instanceof Error?e.message:(0,n.__)("Failed to apply edit in editor.","wp-banana");w(t)}}else{const e=u;e&&e.url?E({type:"success",message:(0,n.__)("Edited image saved.","wp-banana"),url:e.url}):E({type:"success",message:(0,n.__)("Edit completed.","wp-banana")}),g(""),T()}S(!1)}catch(e){var u;const t=e;w(null!==(u=t?.message)&&void 0!==u?u:(0,n.__)("Failed to edit image.","wp-banana"))}finally{x(!1)}}},[h,B,V,N,M,F,G,q,c,e,T]),re=(0,t.useCallback)(e=>{"Enter"===e.key&&(e.metaKey||e.ctrlKey)&&(e.preventDefault(),ee&&!_&&ae())},[ee,_,ae]);return(0,i.jsx)(o.Card,{children:(0,i.jsxs)(o.CardBody,{children:[K&&(0,i.jsx)(o.Notice,{status:"error",isDismissible:!1,children:K}),b&&(0,i.jsx)(o.Notice,{status:"error",isDismissible:!0,onRemove:()=>w(null),children:b}),A&&(0,i.jsx)(o.Notice,{status:"warning",isDismissible:!0,onRemove:()=>N(null),children:A}),B&&!z&&0===V.length&&(0,i.jsx)(o.Notice,{status:"warning",isDismissible:!1,children:(0,n.__)("Switch to a supported model to send multiple reference images.","wp-banana")}),C&&(0,i.jsxs)(o.Notice,{status:"success"===C.type?"success":"info",isDismissible:!0,onRemove:()=>E(null),children:[C.message,C.url&&(0,i.jsxs)(i.Fragment,{children:[" ",(0,i.jsx)("a",{href:C.url,target:!1===C.openInNewTab?void 0:"_blank",rel:!1===C.openInNewTab?void 0:"noopener noreferrer",children:(0,i.jsx)("em",{children:null!==(f=C.linkLabel)&&void 0!==f?f:(0,n.__)("Open image in new tab","wp-banana")})})]})]}),(0,i.jsx)(s,{prompt:h,onPromptChange:g,onPromptKeyDown:re,isSubmitting:_,canSubmit:ee,onSubmit:ae,onReferenceClick:te,showOptions:R,onToggleOptions:()=>S(e=>!e),summary:Y,enableReferenceDragDrop:!1,dropOverlayVisible:!1,promptLabel:(0,n.__)("Describe the desired changes","wp-banana"),promptPlaceholder:(0,n.__)("Add a glowing neon outline…","wp-banana"),submitLabel:(0,n.__)("Apply AI Edit","wp-banana"),submitTooltip:(0,n.__)("Apply AI edits and stage them in the editor buffer","wp-banana"),referenceTray:(0,i.jsx)(d,{referenceImages:k,onRemove:P,fileInputRef:j,onReferenceSelection:ne})}),(0,i.jsx)(l,{show:R,connectedProviders:J,provider:G,onProviderChange:e=>U(e),model:q,onModelChange:e=>H(e),modelOptions:V,modelsLoading:z,aspectRatioEnabled:!1,aspectRatio:"",onAspectRatioChange:e=>{},aspectOptions:[],resolutionEnabled:!1,resolution:"",onResolutionChange:e=>{},resolutionOptions:[],isSubmitting:_})]})})},B=new WeakMap,G=(e,a)=>{if("1"===e.dataset.wpBananaEnhanced)return;const o=e.querySelector(".imgedit-menu");if(!o)return;const s=(e=>{const t=e.closest('[id^="imgedit-panel-"]');if(!t)return null;const n=t.id.match(/imgedit-panel-(\d+)/);return n?parseInt(n[1],10):null})(e);if(!s)return;$(),(()=>{var e,t;const n="wp-banana-edit-toggle-styles";if(document.getElementById(n))return;const a=document.createElement("style");a.id=n,a.textContent="\n.imgedit-menu .wp-banana-edit-toggle.button:after {\n\tfont: normal 16px/1 dashicons;\n\tcontent: '\\f140';\n\tmargin-left: 2px;\n\tmargin-right: 0;\n\tspeak: never;\n\t-webkit-font-smoothing: antialiased;\n\tdisplay: inline-block;\n\ttop: 0;\n}\n.imgedit-menu .wp-banana-edit-toggle.button[aria-expanded=\"true\"]:after {\n\tcontent: '\\f142';\n}\n";const r=null!==(e=null!==(t=document.head)&&void 0!==t?t:document.body)&&void 0!==e?e:document.documentElement;r&&r.appendChild(a)})();const l=document.createElement("button");if(l.type="button",l.className="button wp-banana-edit-toggle",l.setAttribute("aria-expanded","false"),l.style.marginLeft="8px",l.style.whiteSpace="nowrap",l.style.display="inline-flex",l.style.alignItems="center",l.style.gap="6px",a.data.iconUrl){const e=document.createElement("span");e.setAttribute("aria-hidden","true"),e.style.display="inline-block",e.style.width="16px",e.style.height="16px",e.style.backgroundColor="currentColor",e.style.maskImage=`url(${a.data.iconUrl})`,e.style.webkitMaskImage=`url(${a.data.iconUrl})`,e.style.maskRepeat="no-repeat",e.style.webkitMaskRepeat="no-repeat",e.style.maskPosition="center",e.style.webkitMaskPosition="center",e.style.maskSize="contain",e.style.webkitMaskSize="contain",l.appendChild(e)}l.appendChild(document.createTextNode((0,n.__)("AI Edit","wp-banana"))),o.appendChild(l);const d=document.createElement("div");d.className="wp-banana-edit-panel",d.style.display="none",d.style.marginTop="12px",d.style.maxWidth="100%",d.style.width="100%",d.style.flexBasis="100%",d.style.flexGrow="0",d.style.flexShrink="0",d.style.flex="0 0 100%",d.style.alignSelf="stretch",d.style.clear="both",d.style.boxSizing="border-box";const c=e.querySelector(".imgedit-submit");c?c.insertAdjacentElement("afterend",d):e.appendChild(d);let p=!1;const u=()=>{p||(p=!0,(({container:e,attachmentId:n,providers:a,restNamespace:r,defaultEditorModel:o,defaultEditorProvider:s})=>{let l=B.get(e);if(!l){const n=window.wp?.element;if("function"==typeof n?.createRoot){const t=n.createRoot(e);l={render:e=>t.render(e)}}else l={render:n=>(0,t.render)(n,e)};B.set(e,l)}l.render((0,i.jsx)(F,{attachmentId:n,providers:a,restNamespace:r,defaultEditorModel:o,defaultEditorProvider:s}))})({container:d,attachmentId:s,providers:a.data.providers,restNamespace:a.data.restNamespace,defaultEditorModel:a.data.defaultEditorModel,defaultEditorProvider:a.data.defaultEditorProvider})),d.style.display="block",l.setAttribute("aria-expanded","true"),l.classList.add("wp-banana-edit-toggle--open");const e=d.querySelector("textarea");e&&setTimeout(()=>e.focus(),50)};((e,t,a,o)=>{const i=e.querySelector(".imgedit-submit");if(!i||i.querySelector(".wp-banana-save-as"))return;const s=document.createElement("button");s.type="button",s.className="button wp-banana-save-as",s.textContent=(0,n.__)("Save As Copy","wp-banana"),s.style.marginLeft="8px",i.appendChild(s);const l=e=>{document.dispatchEvent(new CustomEvent(L,{detail:e}))},d=()=>{s.classList.contains("is-busy")||(s.disabled=!(()=>{const e=window.imageEdit;if(!e||"function"!=typeof e.filterHistory)return!1;const n=e.filterHistory(t,0);return!!n&&"[]"!==n})())};d(),document.addEventListener(I,e=>{const n=e;n.detail&&n.detail.attachmentId===t&&d()}),s.addEventListener("click",async()=>{const e=window.imageEdit;if(!e){const e=(0,n.__)("Image editor not ready.","wp-banana");return o(),T(t,"error",e),void l({type:"info",message:e})}const i=e.filterHistory(t,0);if(!i||"[]"===i){const e=(0,n.__)("No edits to save.","wp-banana");return o(),T(t,"error",e),void l({type:"info",message:e})}s.disabled=!0,s.classList.add("is-busy");try{var c,p;const e=await r()({path:`${a}/edit/save-as`,method:"POST",data:{attachment_id:t,history:i}}),s=null!==(c=e?.filename)&&void 0!==c?c:"",d=s?(0,n.sprintf)((0,n.__)("Copy saved: %s","wp-banana"),s):(0,n.__)("Copy saved.","wp-banana"),u=(e=>{const t=window.ajaxurl;if(t)try{const n=new URL(t,window.location.origin);n.hash="";const a=n.pathname.split("/");return a[a.length-1]="upload.php",n.pathname=a.join("/"),n.search=`item=${e}`,n.toString()}catch(e){}return`${window.location.origin.replace(/\/$/,"")}/wp-admin/upload.php?item=${e}`})(null!==(p=e?.attachment_id)&&void 0!==p?p:t),m=(0,n.__)("Open image","wp-banana");o(),T(t,"success",d,u,{openInNewTab:!1,label:m}),l({type:"success",message:d,url:u,linkLabel:m,openInNewTab:!1})}catch(e){var u;const a=e,r=null!==(u=a?.message)&&void 0!==u?u:(0,n.__)("Failed to save copy.","wp-banana");o(),T(t,"error",r),l({type:"info",message:r})}finally{s.disabled=!1,s.classList.remove("is-busy"),d()}})})(e,s,a.data.restNamespace,u),l.addEventListener("click",e=>{if(e.preventDefault(),"block"===d.style.display)return d.style.display="none",l.setAttribute("aria-expanded","false"),void l.classList.remove("wp-banana-edit-toggle--open");u()}),e.dataset.wpBananaEnhanced="1"},U=()=>{const e=window.wpBananaMedia;var t;e&&Array.isArray(e.providers)&&0!==e.providers.length&&(0!==e.providers.filter(e=>!1!==e.connected).length&&($(),t={data:e},document.querySelectorAll(".imgedit-panel-content.imgedit-panel-tools").forEach(e=>{e instanceof HTMLElement&&G(e,t)}),new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.forEach(e=>{e instanceof HTMLElement&&(e.matches(".imgedit-panel-content.imgedit-panel-tools")?G(e,t):e.querySelectorAll(".imgedit-panel-content.imgedit-panel-tools").forEach(e=>{e instanceof HTMLElement&&G(e,t)}))})})}).observe(document.body,{childList:!0,subtree:!0})))};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",U):U()})();