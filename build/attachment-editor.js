(()=>{"use strict";var e={n:t=>{var n=t&&t.__esModule?()=>t.default:()=>t;return e.d(n,{a:n}),n},d:(t,n)=>{for(var a in n)e.o(n,a)&&!e.o(t,a)&&Object.defineProperty(t,a,{enumerable:!0,get:n[a]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const t=window.wp.element,n=window.React,a=window.wp.i18n,r=window.wp.apiFetch;var i=e.n(r);const s=window.wp.components,o=window.ReactJSXRuntime,l={gemini:["gemini-2.5-flash-image","gemini-2.5-flash-image-preview"],openai:["gpt-image-1","gpt-image-1-mini"],replicate:["google/nano-banana","bytedance/seedream-4","reve/remix"]},d="banana",c="wp-banana-ai-notice",p="wp-banana-history-change",u=e=>e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"),m=(e,t,n,r,i)=>{var s;const o=document.getElementById(`imgedit-response-${e}`);if(!o)return;const l="success"===t?"notice notice-success":"notice notice-error",d=!1!==i?.openInNewTab,c=null!==(s=i?.label)&&void 0!==s?s:(0,a.__)("Open image in new tab","wp-banana");let p=`<div class="${l}" tabindex="-1" role="alert"><p>${u(n)}`;if(r){const e=d?' target="_blank" rel="noopener noreferrer"':"";p+=` <a href="${u(r)}"${e}><em>${u(c)}</em></a>`}p+="</p></div>",o.innerHTML=p;const m=window.wp?.a11y?.speak;"function"==typeof m&&m(n)},f=()=>{const e=window.imageEdit,t=window.jQuery;if(!e||!t||e.__wpBananaPatched)return;const n=e=>{"number"!=typeof e||Number.isNaN(e)||document.dispatchEvent(new CustomEvent(p,{detail:{attachmentId:e}}))};if(e.filterHistory=function(e,n){const a=t(`#imgedit-history-${e}`),r=t(`#imgedit-undone-${e}`),i=a.val();if(""===i||null==i)return n&&(this.hold.w=this.hold.ow,this.hold.h=this.hold.oh),"";let s;try{s=JSON.parse(i)}catch(e){return""}let o=parseInt(r.val()||"0",10);if(o>0&&(s=s.slice(0,s.length-o)),n){if(0===s.length)return this.hold.w=this.hold.ow,this.hold.h=this.hold.oh,"";const e=s[s.length-1];if(e){const t=e[d];if(t&&void 0!==t.fw)this.hold.w=t.fw,this.hold.h=t.fh;else{const t=e.c,n=e.r,a=e.f,r=t||n||a;r&&void 0!==r.fw&&void 0!==r.fh&&(this.hold.w=r.fw,this.hold.h=r.fh)}}}const l=[];for(let e=0;e<s.length;e++){const t=s[e];if(t&&t.c){const n=t.c;l[e]={c:{x:n.x,y:n.y,w:n.w,h:n.h,r:n.r}}}else if(t&&t.r){const n=t.r;l[e]={r:n.r}}else if(t&&t.f){const n=t.f;l[e]={f:n.f}}else if(t&&t[d]){const n=t[d];l[e]={[d]:{key:n.key,fw:n.fw,fh:n.fh,mime:n.mime||""}}}}return JSON.stringify(l)},e.__wpBananaPatched=!0,!e.__wpBananaHistoryPatched){const t="function"==typeof e.addStep?e.addStep:null;t&&(e.addStep=function(e,a,r){const i=t.call(this,e,a,r);return n(a),i});const a="function"==typeof e.undo?e.undo:null;a&&(e.undo=function(e,t){const r=a.call(this,e,t);return n(e),r});const r="function"==typeof e.redo?e.redo:null;r&&(e.redo=function(e,t){const a=r.call(this,e,t);return n(e),a}),e.__wpBananaHistoryPatched=!0}},h=({attachmentId:e,providers:r,restNamespace:p,defaultEditorModel:u,defaultEditorProvider:m})=>{var h;const g=(0,t.useMemo)(()=>r.filter(e=>!1!==e.connected),[r]),b=(0,t.useMemo)(()=>{var e,t;if(m){const e=g.find(e=>e.slug===m);if(e)return e.slug}if(u){const e=g.find(e=>e.default_model===u);if(e)return e.slug;const t=r.find(e=>e.default_model===u);if(t){const e=g.find(e=>e.slug===t.slug);if(e)return e.slug}}const n=g.find(e=>"replicate"===e.slug);return n?n.slug:null!==(e=null!==(t=g[0]?.slug)&&void 0!==t?t:r[0]?.slug)&&void 0!==e?e:""},[g,r,m,u]),[w,y]=(0,t.useState)(b),[v,_]=(0,t.useState)(""),[x,j]=(0,t.useState)([]),[C,E]=(0,t.useState)(""),[k,S]=(0,t.useState)(!1),[N,A]=(0,t.useState)(null),[L,R]=(0,t.useState)(null),[M,I]=(0,t.useState)(!1),[D,$]=(0,t.useState)(null),[P,T]=(0,t.useState)(!1),[O,B]=(0,t.useState)([]),[F,U]=(0,t.useState)(null),q=(0,n.useRef)(null),G=(0,n.useRef)(O),H=O.length,W=H>0,z=(0,t.useMemo)(()=>{var e;if(!W)return x;const t=null!==(e=l[w])&&void 0!==e?e:[];if(0===t.length)return[];const n=new Set(t);return x.filter(e=>n.has(e))},[x,w,W]);(0,t.useEffect)(()=>{const e=e=>{const t=e;t.detail&&$(t.detail)};return document.addEventListener(c,e),()=>{document.removeEventListener(c,e)}},[]),(0,t.useEffect)(()=>{G.current=O},[O]),(0,t.useEffect)(()=>()=>{G.current.forEach(e=>{window.URL.revokeObjectURL(e.url)})},[]);const J=(0,t.useMemo)(()=>r.find(e=>e.slug===w),[w,r]),K=(0,t.useMemo)(()=>{var e;if(k)return!1;if(!w)return!1;const t=null!==(e=l[w])&&void 0!==e?e:[];if(0===t.length)return!1;const n=[];return C?n.push(C):0===x.length&&(J?.default_model&&n.push(String(J.default_model)),u&&n.push(u)),0!==n.length&&n.some(e=>t.includes(e))},[w,C,x,J,u,k]),Q=(0,t.useMemo)(()=>{var e;if(J?.label)return J.label;const t=r.find(e=>e.slug===w);return null!==(e=t?.label)&&void 0!==e?e:w?w.toUpperCase():""},[w,r,J]),Y=(0,t.useMemo)(()=>{const e=J?.default_model?String(J.default_model):"",t=C||(k?(0,a.__)("Loading model…","wp-banana"):""!==e?e:(0,a.__)("Provider default model","wp-banana")),n=Q,r=H>0?(0,a.sprintf)((0,a._n)("%d reference","%d references",H,"wp-banana"),H):"";return{model:t,provider:n,references:r,fallback:t||n||r?"":(0,a.__)("Using provider defaults","wp-banana")}},[C,k,Q,J,H]);(0,t.useEffect)(()=>{w&&g.some(e=>e.slug===w)||b&&y(b)},[b,w,g]),(0,t.useEffect)(()=>{if(!w)return;let e=!0;return S(!0),A(null),i()({path:`${p}/models?provider=${w}&purpose=edit`}).then(t=>{if(!e)return;const n=t,a=Array.isArray(n.models)?n.models:[];if(j(a),0===a.length)return void E("");const r=[u,J?.default_model].find(e=>!!e&&a.includes(e));E(r||a[0])}).catch(t=>{var n;e&&(j([]),E(""),A(null!==(n=t?.message)&&void 0!==n?n:(0,a.__)("Failed to load models.","wp-banana")))}).finally(()=>{e&&S(!1)}),()=>{e=!1}},[w,p,J,u]),(0,t.useEffect)(()=>{k||(0!==z.length?z.includes(C)||E(z[0]):W&&""!==C&&E(""))},[z,C,k,W]);const V=(0,t.useMemo)(()=>z.length>0?""!==C&&z.includes(C):!W&&(""!==C||0===x.length),[z,C,W,x]),X=(0,t.useMemo)(()=>!(M||k||v.trim().length<3||""===w||!V),[M,k,v,w,V]),Z=(0,n.useCallback)(()=>{G.current.forEach(e=>{window.URL.revokeObjectURL(e.url)}),G.current=[],B([]),U(null)},[]),ee=(0,n.useCallback)(()=>{K&&q.current&&q.current.click()},[K]),te=(0,n.useCallback)(e=>{if(!K)return void(e.target.value="");const t=e.target.files;if(!t||0===t.length)return;let n=Math.max(0,4-O.length),r=0,i=0;const s=[];Array.from(t).forEach(e=>{if(!e.type||!e.type.startsWith("image/"))return;if(i+=1,n<=0)return;const t=`${Date.now()}-${Math.random().toString(36).slice(2)}`;s.push({id:t,file:e,url:window.URL.createObjectURL(e)}),n-=1,r+=1}),r>0?(B([...O,...s]),R(null),U(i>r?(0,a.__)("You can upload up to 4 reference images.","wp-banana"):null)):i>0&&U((0,a.__)("You can upload up to 4 reference images.","wp-banana")),e.target.value=""},[O,K]),ne=(0,n.useCallback)(e=>{let t=!1;const n=O.filter(n=>n.id!==e||(window.URL.revokeObjectURL(n.url),t=!0,!1));t&&(G.current=n),B(n),U(null)},[O]),ae=async()=>{const t=v.trim();if(t.length<3)R((0,a.__)("Please enter a longer prompt.","wp-banana"));else if(W&&0===z.length)R((0,a.__)("Choose a model that supports multiple reference images.","wp-banana"));else{R(null),U(null),$(null),I(!0);try{let m;const h=(e=>{const t=(e=>{const t=document.getElementById(`imgedit-history-${e}`);if(!t)return[];const n=(e=>{if(!e)return[];try{const t=JSON.parse(e);return Array.isArray(t)?t:[]}catch(e){return[]}})(t.value||"");if(0===n.length)return n;const a=document.getElementById(`imgedit-undone-${e}`);if(!a||!a.value)return n;const r=parseInt(a.value,10);return Number.isNaN(r)||r<=0?n:n.slice(0,Math.max(0,n.length-r))})(e);for(let e=t.length-1;e>=0;e-=1){const n=t[e];if(!n||"object"!=typeof n)continue;const a=n[d];if(a&&"object"==typeof a){const e=a.key;if("string"==typeof e&&e.length>0)return e}}return null})(e);if(H>0){const n=new window.FormData;n.append("attachment_id",String(e)),n.append("prompt",t),n.append("provider",w),C&&n.append("model",C),n.append("save_mode","buffer"),h&&n.append("base_buffer_key",h),O.forEach(e=>{n.append("reference_images[]",e.file,e.file.name)}),m=await i()({path:`${p}/edit`,method:"POST",body:n})}else{const n={attachment_id:e,prompt:t,provider:w,model:C,save_mode:"buffer"};h&&(n.base_buffer_key=h),m=await i()({path:`${p}/edit`,method:"POST",data:n})}const g=m;if(g&&"string"==typeof g.buffer_key){var n,r,s,o,l,c,u;const i={buffer_key:g.buffer_key,width:null!==(n=g.width)&&void 0!==n?n:0,height:null!==(r=g.height)&&void 0!==r?r:0,mime:null!==(s=g.mime)&&void 0!==s?s:"image/png",attachment_id:null!==(o=g.attachment_id)&&void 0!==o?o:e,provider:null!==(l=g.provider)&&void 0!==l?l:w,model:null!==(c=g.model)&&void 0!==c?c:C,prompt:null!==(u=g.prompt)&&void 0!==u?u:t};try{(e=>{f();const t=window.imageEdit;if(!t)throw new Error((0,a.__)("Image editor not ready.","wp-banana"));const n=document.getElementById(`imgedit-nonce-${e.attachment_id}`);if(!n||""===n.value)throw new Error((0,a.__)("Editor security token missing.","wp-banana"));const r={key:e.buffer_key,fw:e.width,fh:e.height,mime:e.mime};e.provider&&(r.provider=e.provider),e.model&&(r.model=e.model),e.prompt&&(r.prompt=e.prompt),t.addStep({[d]:r},e.attachment_id,n.value)})(i),$({type:"success",message:(0,a.__)("AI edit applied. Use Save Edits or Save As to keep these changes.","wp-banana")}),_(""),Z()}catch(e){const t=e instanceof Error?e.message:(0,a.__)("Failed to apply edit in editor.","wp-banana");R(t)}}else{const e=m;e&&e.url?$({type:"success",message:(0,a.__)("Edited image saved.","wp-banana"),url:e.url}):$({type:"success",message:(0,a.__)("Edit completed.","wp-banana")}),_(""),Z()}T(!1)}catch(e){var m;const t=e;R(null!==(m=t?.message)&&void 0!==m?m:(0,a.__)("Failed to edit image.","wp-banana"))}finally{I(!1)}}},re=(0,n.useCallback)(e=>{"Enter"===e.key&&(e.metaKey||e.ctrlKey)&&(e.preventDefault(),X&&ae())},[X,ae]);return(0,o.jsx)(s.Card,{children:(0,o.jsxs)(s.CardBody,{children:[N&&(0,o.jsx)(s.Notice,{status:"error",isDismissible:!0,onRemove:()=>A(null),children:N}),L&&(0,o.jsx)(s.Notice,{status:"error",isDismissible:!0,onRemove:()=>R(null),children:L}),F&&(0,o.jsx)(s.Notice,{status:"warning",isDismissible:!0,onRemove:()=>U(null),children:F}),W&&!k&&0===z.length&&(0,o.jsx)(s.Notice,{status:"warning",isDismissible:!1,children:(0,a.__)("Switch to a supported model to send multiple reference images.","wp-banana")}),D&&(0,o.jsxs)(s.Notice,{status:"success"===D.type?"success":"info",isDismissible:!0,onRemove:()=>$(null),children:[D.message,D.url&&(0,o.jsxs)(o.Fragment,{children:[" ",(0,o.jsx)("a",{href:D.url,target:!1===D.openInNewTab?void 0:"_blank",rel:!1===D.openInNewTab?void 0:"noopener noreferrer",children:(0,o.jsx)("em",{children:null!==(h=D.linkLabel)&&void 0!==h?h:(0,a.__)("Open image in new tab","wp-banana")})})]})]}),(0,o.jsxs)("div",{style:{position:"relative",marginBottom:"8px"},children:[(0,o.jsx)(s.TextareaControl,{label:(0,a.__)("Describe the desired changes","wp-banana"),value:v,onChange:e=>_(e),onKeyDown:re,rows:4,placeholder:(0,a.__)("Add a glowing neon outline…","wp-banana"),disabled:M}),K&&(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)("button",{type:"button",className:"button button-secondary button-small",onClick:ee,disabled:M,"aria-label":(0,a.__)("Add reference images","wp-banana"),style:{position:"absolute",top:"26px",right:"0",lineHeight:"20px",padding:"0 4px",border:"none",borderRadius:0,background:"transparent"},children:(0,o.jsx)("span",{className:"dashicons dashicons-paperclip","aria-hidden":"true"})}),(0,o.jsx)("input",{ref:q,type:"file",accept:"image/png,image/jpeg,image/webp",multiple:!0,onChange:te,style:{display:"none"}})]})]}),O.length>0&&(0,o.jsx)("div",{style:{display:"flex",gap:"8px",marginBottom:"16px",flexWrap:"wrap"},children:O.map(e=>(0,o.jsxs)("div",{style:{position:"relative",width:"72px",height:"72px",overflow:"hidden",borderRadius:"4px",border:"1px solid #dcdcde"},children:[(0,o.jsx)("img",{src:e.url,alt:"",style:{width:"100%",height:"100%",objectFit:"cover"}}),(0,o.jsx)("button",{type:"button",className:"button-link",onClick:()=>ne(e.id),"aria-label":(0,a.__)("Remove reference image","wp-banana"),style:{position:"absolute",top:"2px",right:"2px",background:"rgba(0,0,0,0.55)",borderRadius:"3px",color:"#fff",width:"22px",height:"22px",display:"inline-flex",alignItems:"center",justifyContent:"center",textDecoration:"none"},children:(0,o.jsx)("span",{className:"dashicons dashicons-no"})})]},e.id))}),P&&g.length>1&&(0,o.jsx)(s.SelectControl,{label:(0,a.__)("Provider","wp-banana"),value:w,onChange:e=>y(e),disabled:M,options:g.map(e=>({label:e.label,value:e.slug}))}),P&&(0,o.jsx)(s.SelectControl,{label:(0,a.__)("Model","wp-banana"),value:C,onChange:e=>E(e),options:z.length>0?z.map(e=>({label:e,value:e})):[{label:(0,a.__)("No models available","wp-banana"),value:""}],disabled:k||0===z.length||M}),k&&(0,o.jsxs)("div",{className:"wp-banana-edit-panel__spinner",style:{display:"flex",alignItems:"center",gap:"8px"},children:[(0,o.jsx)(s.Spinner,{})," ",(0,a.__)("Loading models…","wp-banana")]}),(0,o.jsxs)("div",{className:"wp-banana-edit-panel__actions",style:{marginTop:"12px",display:"flex",flexWrap:"wrap",alignItems:"center",gap:"12px",justifyContent:"space-between"},children:[(0,o.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"12px"},children:[(0,o.jsx)("button",{type:"button",className:"button button-primary wp-banana-edit-panel__submit",onClick:ae,disabled:!X,children:(0,a.__)("Apply AI Edit","wp-banana")}),M&&(0,o.jsx)("span",{className:"spinner is-active","aria-hidden":"true"})]}),(0,o.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"8px",flexWrap:"wrap",textAlign:"right"},children:[Y.fallback?(0,o.jsx)("span",{children:Y.fallback}):(0,o.jsxs)("span",{children:[(0,o.jsx)("code",{children:Y.model}),Y.provider&&(0,o.jsxs)("span",{children:[" (",Y.provider,")"]}),Y.references&&(0,o.jsxs)("span",{children:[" - ",Y.references]})]}),(0,o.jsx)("button",{type:"button",className:"button-link",onClick:()=>T(!P),children:P?(0,a.__)("Hide options","wp-banana"):(0,a.__)("Change","wp-banana")})]})]})]})})},g=new WeakMap,b=(e,n)=>{if("1"===e.dataset.wpBananaEnhanced)return;const r=e.querySelector(".imgedit-menu");if(!r)return;const s=(e=>{const t=e.closest('[id^="imgedit-panel-"]');if(!t)return null;const n=t.id.match(/imgedit-panel-(\d+)/);return n?parseInt(n[1],10):null})(e);if(!s)return;f(),(()=>{var e,t;const n="wp-banana-edit-toggle-styles";if(document.getElementById(n))return;const a=document.createElement("style");a.id=n,a.textContent="\n.imgedit-menu .wp-banana-edit-toggle.button:after {\n\tfont: normal 16px/1 dashicons;\n\tcontent: '\\f140';\n\tmargin-left: 2px;\n\tmargin-right: 0;\n\tspeak: never;\n\t-webkit-font-smoothing: antialiased;\n\tdisplay: inline-block;\n\ttop: 0;\n}\n.imgedit-menu .wp-banana-edit-toggle.button[aria-expanded=\"true\"]:after {\n\tcontent: '\\f142';\n}\n";const r=null!==(e=null!==(t=document.head)&&void 0!==t?t:document.body)&&void 0!==e?e:document.documentElement;r&&r.appendChild(a)})();const l=document.createElement("button");if(l.type="button",l.className="button wp-banana-edit-toggle",l.setAttribute("aria-expanded","false"),l.style.marginLeft="8px",l.style.whiteSpace="nowrap",l.style.display="inline-flex",l.style.alignItems="center",l.style.gap="6px",n.data.iconUrl){const e=document.createElement("span");e.setAttribute("aria-hidden","true"),e.style.display="inline-block",e.style.width="16px",e.style.height="16px",e.style.backgroundColor="currentColor",e.style.maskImage=`url(${n.data.iconUrl})`,e.style.webkitMaskImage=`url(${n.data.iconUrl})`,e.style.maskRepeat="no-repeat",e.style.webkitMaskRepeat="no-repeat",e.style.maskPosition="center",e.style.webkitMaskPosition="center",e.style.maskSize="contain",e.style.webkitMaskSize="contain",l.appendChild(e)}l.appendChild(document.createTextNode((0,a.__)("AI Edit","wp-banana"))),r.appendChild(l);const d=document.createElement("div");d.className="wp-banana-edit-panel",d.style.display="none",d.style.marginTop="12px",d.style.maxWidth="100%",d.style.width="100%",d.style.flexBasis="100%",d.style.flexGrow="0",d.style.flexShrink="0",d.style.flex="0 0 100%",d.style.alignSelf="stretch",d.style.clear="both",d.style.boxSizing="border-box";const u=e.querySelector(".imgedit-submit");u?u.insertAdjacentElement("afterend",d):e.appendChild(d);let b=!1;const w=()=>{b||(b=!0,(({container:e,attachmentId:n,providers:a,restNamespace:r,defaultEditorModel:i,defaultEditorProvider:s})=>{let l=g.get(e);if(!l){const n=window.wp?.element;if("function"==typeof n?.createRoot){const t=n.createRoot(e);l={render:e=>t.render(e)}}else l={render:n=>(0,t.render)(n,e)};g.set(e,l)}l.render((0,o.jsx)(h,{attachmentId:n,providers:a,restNamespace:r,defaultEditorModel:i,defaultEditorProvider:s}))})({container:d,attachmentId:s,providers:n.data.providers,restNamespace:n.data.restNamespace,defaultEditorModel:n.data.defaultEditorModel,defaultEditorProvider:n.data.defaultEditorProvider})),d.style.display="block",l.setAttribute("aria-expanded","true"),l.classList.add("wp-banana-edit-toggle--open");const e=d.querySelector("textarea");e&&setTimeout(()=>e.focus(),50)};((e,t,n,r)=>{const s=e.querySelector(".imgedit-submit");if(!s||s.querySelector(".wp-banana-save-as"))return;const o=document.createElement("button");o.type="button",o.className="button wp-banana-save-as",o.textContent=(0,a.__)("Save As Copy","wp-banana"),o.style.marginLeft="8px",s.appendChild(o);const l=e=>{document.dispatchEvent(new CustomEvent(c,{detail:e}))},d=()=>{o.classList.contains("is-busy")||(o.disabled=!(()=>{const e=window.imageEdit;if(!e||"function"!=typeof e.filterHistory)return!1;const n=e.filterHistory(t,0);return!!n&&"[]"!==n})())};d(),document.addEventListener(p,e=>{const n=e;n.detail&&n.detail.attachmentId===t&&d()}),o.addEventListener("click",async()=>{const e=window.imageEdit;if(!e){const e=(0,a.__)("Image editor not ready.","wp-banana");return r(),m(t,"error",e),void l({type:"info",message:e})}const s=e.filterHistory(t,0);if(!s||"[]"===s){const e=(0,a.__)("No edits to save.","wp-banana");return r(),m(t,"error",e),void l({type:"info",message:e})}o.disabled=!0,o.classList.add("is-busy");try{var c,p;const e=await i()({path:`${n}/edit/save-as`,method:"POST",data:{attachment_id:t,history:s}}),o=null!==(c=e?.filename)&&void 0!==c?c:"",d=o?(0,a.sprintf)((0,a.__)("Copy saved: %s","wp-banana"),o):(0,a.__)("Copy saved.","wp-banana"),u=(e=>{const t=window.ajaxurl;if(t)try{const n=new URL(t,window.location.origin);n.hash="";const a=n.pathname.split("/");return a[a.length-1]="upload.php",n.pathname=a.join("/"),n.search=`item=${e}`,n.toString()}catch(e){}return`${window.location.origin.replace(/\/$/,"")}/wp-admin/upload.php?item=${e}`})(null!==(p=e?.attachment_id)&&void 0!==p?p:t),f=(0,a.__)("Open image","wp-banana");r(),m(t,"success",d,u,{openInNewTab:!1,label:f}),l({type:"success",message:d,url:u,linkLabel:f,openInNewTab:!1})}catch(e){var u;const n=e,i=null!==(u=n?.message)&&void 0!==u?u:(0,a.__)("Failed to save copy.","wp-banana");r(),m(t,"error",i),l({type:"info",message:i})}finally{o.disabled=!1,o.classList.remove("is-busy"),d()}})})(e,s,n.data.restNamespace,w),l.addEventListener("click",e=>{if(e.preventDefault(),"block"===d.style.display)return d.style.display="none",l.setAttribute("aria-expanded","false"),void l.classList.remove("wp-banana-edit-toggle--open");w()}),e.dataset.wpBananaEnhanced="1"},w=()=>{const e=window.wpBananaMedia;var t;e&&Array.isArray(e.providers)&&0!==e.providers.length&&(0!==e.providers.filter(e=>!1!==e.connected).length&&(f(),t={data:e},document.querySelectorAll(".imgedit-panel-content.imgedit-panel-tools").forEach(e=>{e instanceof HTMLElement&&b(e,t)}),new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.forEach(e=>{e instanceof HTMLElement&&(e.matches(".imgedit-panel-content.imgedit-panel-tools")?b(e,t):e.querySelectorAll(".imgedit-panel-content.imgedit-panel-tools").forEach(e=>{e instanceof HTMLElement&&b(e,t)}))})})}).observe(document.body,{childList:!0,subtree:!0})))};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",w):w();const y={generate:(0,a.__)("Generated","wp-banana"),edit:(0,a.__)("Edited","wp-banana")},v={new:(0,a.__)("New copy","wp-banana"),replace:(0,a.__)("Replaced original","wp-banana"),save_as:(0,a.__)("Saved as copy","wp-banana"),buffer:(0,a.__)("Buffered edit","wp-banana")},_=(e,t,n)=>{const a=document.createElement("div");a.className=e;const r=document.createElement("strong");return r.textContent=t,a.appendChild(r),a.appendChild(document.createTextNode(" ")),n.forEach(e=>{"string"!=typeof e?a.appendChild(e):a.appendChild(document.createTextNode(e))}),a},x=e=>{if("number"==typeof e&&Number.isFinite(e))return e;if("string"==typeof e){const t=parseInt(e,10);if(!Number.isNaN(t))return t}return null},j=e=>{const t=e?.el;if(!(t&&t instanceof HTMLElement))return;const n=t.querySelector(".details");if(!n)return;const r=n.querySelector(".wp-banana-ai-details");r&&r.remove();const i=e?.model?.toJSON?e.model.toJSON():null;if(!i||"object"!=typeof i)return;const s=i.wpBanana;if(!s)return;if(!Boolean(s.isGenerated||s.derivedFrom||s.historyCount&&s.historyCount>0||s.lastPrompt&&""!==s.lastPrompt.trim()))return;const o=document.createElement("div");o.className="wp-banana-ai-details";const l=x(i.id),d=x(s.derivedFrom?.id),c=null!==l&&null!==d&&l===d;if(s.derivedFrom&&s.derivedFrom.id&&!c){var p;const e=document.createElement("a");e.href=s.derivedFrom.editLink||s.derivedFrom.viewLink||"#",e.textContent=null!==(p=s.derivedFrom.title)&&void 0!==p?p:`#${s.derivedFrom.id}`,e.target="_blank",e.rel="noopener noreferrer";const t=_("wp-banana-ai-details__item",(0,a.__)("Derived from:","wp-banana"),[e]);o.appendChild(t)}if(s.historyCount&&s.historyCount>0&&Array.isArray(s.history)){const e=document.createElement("button");e.type="button",e.className="button-link wp-banana-history-toggle";const t=(0,a.sprintf)((0,a._n)("View history (%d entry)","View history (%d entries)",s.historyCount,"wp-banana"),s.historyCount),n=(0,a.__)("Hide history","wp-banana");e.textContent=t,e.setAttribute("aria-expanded","false");const r=(e=>{const t=document.createElement("div");t.className="wp-banana-history-list";const n=document.createElement("ul");n.className="wp-banana-history-list__items";const r=[...e].reverse();if(r.forEach(e=>{var t;const r=document.createElement("li");r.className="wp-banana-history-list__item";const i=[],s=e.type?null!==(t=y[e.type])&&void 0!==t?t:e.type:"";s&&i.push(s);const o=e.provider?(e=>{var t;if(!e)return"";const n=(()=>{const e=window;return e.wpBananaMedia&&Array.isArray(e.wpBananaMedia.providers)?e.wpBananaMedia.providers:[]})().find(t=>t.slug===e);return null!==(t=n?.label)&&void 0!==t?t:e})(e.provider):"";if(o&&i.push((0,a.sprintf)((0,a.__)("via %s","wp-banana"),o)),e.model&&i.push(e.model),e.mode){var l;const t=null!==(l=v[e.mode])&&void 0!==l?l:e.mode;i.push(t)}if(i.length>0){const e=document.createElement("span");e.className="wp-banana-history-list__summary",e.textContent=i.join(", "),e.style.display="block",r.appendChild(e)}const d=[],c=(e=>{if(!e||Number.isNaN(e))return"";try{const t=new Date(1e3*e);return new Intl.DateTimeFormat(void 0,{year:"numeric",month:"short",day:"2-digit",hour:"numeric",minute:"2-digit"}).format(t)}catch(e){return""}})(e.timestamp);if(c&&d.push(c),e.user?.name&&d.push((0,a.sprintf)((0,a.__)("by %s","wp-banana"),e.user.name)),d.length>0){const e=document.createElement("span");e.className="wp-banana-history-list__meta",e.textContent=d.join(" · "),r.appendChild(e)}if(e.derivedFrom&&e.derivedFrom.id){var p;const t=document.createElement("div");t.className="wp-banana-history-list__derived";const n=document.createElement("a");n.href=e.derivedFrom.editLink||e.derivedFrom.viewLink||"#",n.textContent=null!==(p=e.derivedFrom.title)&&void 0!==p?p:`#${e.derivedFrom.id}`,n.target="_blank",n.rel="noopener noreferrer",t.appendChild(document.createTextNode((0,a.__)("Source:","wp-banana")+" ")),t.appendChild(n),r.appendChild(t)}if(e.prompt&&""!==e.prompt.trim()){const t=document.createElement("div");t.className="wp-banana-history-list__prompt",t.textContent=e.prompt.trim(),r.appendChild(t)}n.appendChild(r)}),0===r.length){const e=document.createElement("li");e.className="wp-banana-history-list__item is-empty",e.textContent=(0,a.__)("No AI history events recorded yet.","wp-banana"),n.appendChild(e)}return t.appendChild(n),t})(s.history);r.style.display="none",e.addEventListener("click",a=>{a.preventDefault();const i=!("true"===e.getAttribute("aria-expanded"));e.setAttribute("aria-expanded",i?"true":"false"),e.textContent=i?n:t,r.style.display=i?"block":"none"});const i=_("wp-banana-ai-details__item wp-banana-ai-details__history",(0,a.__)("AI history:","wp-banana"),[e]);i.appendChild(r),o.appendChild(i)}else if(!1===s.historyEnabled){const e=_("wp-banana-ai-details__item",(0,a.__)("AI history:","wp-banana"),[(0,a.__)("History tracking is disabled for this site.","wp-banana")]);o.appendChild(e)}n.insertBefore(o,n.firstChild)},C=()=>{const e=window,t=e.wp?.media?.view?.Attachment?.Details;if(!t)return;if(t.__wpBananaDetailsPatched)return;const n=t.prototype?.render;if("function"==typeof n){if(t.prototype.render=function(...e){const t=n.apply(this,e);return j(this),t},t.TwoColumn){const e=t.TwoColumn.prototype?.render;"function"==typeof e&&(t.TwoColumn.prototype.render=function(...t){const n=e.apply(this,t);return j(this),n})}t.__wpBananaDetailsPatched=!0}},E=()=>{C()};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",E):E();const k={gemini:["gemini-2.5-flash-image-preview","gemini-2.5-flash-image"],openai:["gpt-image-1","gpt-image-1-mini"],replicate:["google/nano-banana","bytedance/seedream-4","reve/remix"]},S={"image/jpeg":"jpg","image/jpg":"jpg","image/png":"png","image/webp":"webp"},N=[1,2,3,4],A=(e,t,n)=>{var a;const r=`reference-${t}`,i=e&&e.trim().length>0?e.trim():r,s=null!==(a=S[n.toLowerCase()])&&void 0!==a?a:"";if(""===s)return i;if(i.toLowerCase().endsWith(`.${s}`))return i;const o=i.lastIndexOf(".");return o>0?`${i.slice(0,o)}.${s}`:`${i}.${s}`},L=e=>{if(!e)return"png";const t=S[e.toLowerCase()];return null!=t?t:"png"},R=e=>{switch(e){case"queued":case"loading":return(0,a.__)("Generating…","wp-banana");case"complete":return(0,a.__)("Ready","wp-banana");case"saving":return(0,a.__)("Saving…","wp-banana");case"saved":return(0,a.__)("Saved","wp-banana");case"error":return(0,a.__)("Failed","wp-banana");default:return""}},M=({providers:e,restNamespace:r,onComplete:l,defaultGeneratorModel:d,defaultGeneratorProvider:c,aspectRatioOptions:p,defaultAspectRatio:u,enableReferenceDragDrop:m=!1})=>{var f;const h=(0,t.useMemo)(()=>e.filter(e=>!1!==e.connected),[e]),g=(0,t.useMemo)(()=>Array.isArray(p)?p.map(e=>"string"==typeof e?e.trim().toUpperCase():"").filter(e=>e.length>0):[],[p]),b=(0,t.useMemo)(()=>{var e;if("string"==typeof u){const e=u.trim().toUpperCase();if(e&&g.includes(e))return e}return null!==(e=g[0])&&void 0!==e?e:""},[g,u]),w=(0,t.useMemo)(()=>{var t;if(c){const e=h.find(e=>e.slug===c);if(e)return e.slug}if(d){const t=h.find(e=>e.default_model===d);if(t)return t.slug;const n=e.find(e=>e.default_model===d);if(n){const e=h.find(e=>e.slug===n.slug);if(e)return e.slug}}return h.length>0?h[0].slug:null!==(t=e[0]?.slug)&&void 0!==t?t:""},[h,e,c,d]),[y,v]=(0,t.useState)(w),[_,x]=(0,t.useState)(""),[j,C]=(0,t.useState)([]),[E,S]=(0,t.useState)(""),[M,I]=(0,t.useState)(!1),[D,$]=(0,t.useState)(null),[P,T]=(0,t.useState)(null),[O,B]=(0,t.useState)(!1),[F,U]=(0,t.useState)(b),[q,G]=(0,t.useState)(!1),[H,W]=(0,t.useState)([]),[z,J]=(0,t.useState)(null),[K,Q]=(0,t.useState)(!1),Y=(0,n.useRef)(null),V=(0,n.useRef)(H),X=(0,n.useRef)(0),[Z,ee]=(0,t.useState)(!1),[te,ne]=(0,t.useState)([]),[ae,re]=(0,t.useState)(null),[ie,se]=(0,t.useState)(null),oe=(0,n.useRef)(null),le=(0,n.useRef)([]),de=(0,n.useRef)([]),ce=(0,n.useRef)(!1),pe=(0,n.useRef)({successes:0,errors:[]}),ue=(0,n.useCallback)(()=>{0!==de.current.length&&(de.current.forEach(e=>window.clearTimeout(e)),de.current=[])},[]),me=H.length,fe=me>1,he=(0,t.useMemo)(()=>{var e;if(!fe)return j;const t=null!==(e=k[y])&&void 0!==e?e:[];if(0===t.length)return[];const n=new Set(t);return j.filter(e=>n.has(e))},[j,fe,y]),ge=0===me&&g.length>0,be=(0,t.useMemo)(()=>{if(0===te.length)return null;const e=te.find(e=>e.id===ae);return null!=e?e:te[0]},[te,ae]),we=be&&be.data&&be.mime?`data:${be.mime};base64,${be.data}`:"",ye=!!be&&("complete"===be.status||"error"===be.status),ve=!!be&&"saving"!==be.status&&"saved"!==be.status;(0,t.useEffect)(()=>{V.current=H},[H]),(0,t.useEffect)(()=>{le.current=te},[te]),(0,t.useEffect)(()=>{0!==te.length?te.some(e=>e.id===ae)||re(te[0].id):null!==ae&&re(null)},[te,ae]),(0,t.useEffect)(()=>{if(!Z)return;const e=e=>{oe.current&&e.target instanceof Node&&!oe.current.contains(e.target)&&ee(!1)};return document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[Z]),(0,t.useEffect)(()=>()=>{V.current.forEach(e=>{e.revokeOnCleanup&&e.url&&window.URL.revokeObjectURL(e.url)})},[]);const _e=(0,n.useCallback)(()=>{V.current.forEach(e=>{e.revokeOnCleanup&&e.url&&window.URL.revokeObjectURL(e.url)}),W([]),J(null)},[]),xe=(0,n.useCallback)(e=>{if(x(""),T(null),_e(),!Array.isArray(e)||0===e.length)return;const t=[];e.slice(0,4).forEach(e=>{if(!e.sourceUrl||0===e.sourceUrl.length)return;const n=`${Date.now()}-${Math.random().toString(36).slice(2)}`,a=e.sourceUrl,r=e.previewUrl&&e.previewUrl.length>0?e.previewUrl:a;t.push({id:n,url:r,sourceUrl:a,filename:e.filename,mimeType:e.mime})}),W(t),V.current=t,e.length>4&&J((0,a.__)("Only the first 4 selected images were attached as references.","wp-banana"))},[_e]);(0,t.useEffect)(()=>{const e=e=>{if(!e)return;const t=window,n=t.wpBananaReferenceQueue;if(!Array.isArray(n)||0===n.length)return;const a=n.indexOf(e);a>=0&&n.splice(a,1),0===n.length&&delete t.wpBananaReferenceQueue},t=t=>{const n=t,a=n.detail?.references;Array.isArray(a)&&0!==a.length?(e(a),xe(a)):e(a)};return(()=>{const e=window,t=e.wpBananaReferenceQueue;if(Array.isArray(t)&&0!==t.length){for(;t.length>0;){const e=t.shift();Array.isArray(e)&&e.length>0&&xe(e)}delete e.wpBananaReferenceQueue}})(),window.addEventListener("wp-banana:set-reference-images",t),()=>{window.removeEventListener("wp-banana:set-reference-images",t)}},[xe]),(0,t.useEffect)(()=>{me>0?""!==F&&U(""):0!==g.length?g.includes(F)||b!==F&&U(b):""!==F&&U("")},[g,F,b,me]);const je=(0,t.useMemo)(()=>e.find(e=>e.slug===y),[y,e]),Ce=(0,t.useMemo)(()=>{var t;if(je?.label)return je.label;const n=e.find(e=>e.slug===y);return null!==(t=n?.label)&&void 0!==t?t:y?y.toUpperCase():""},[y,e,je]),Ee=(0,t.useMemo)(()=>{const e=ge?F||(0,a.__)("Default aspect ratio","wp-banana"):"",t=je?.default_model?String(je.default_model):"";let n=E||(M?(0,a.__)("Loading model…","wp-banana"):""!==t?t:(0,a.__)("Provider default model","wp-banana"));fe&&0===he.length&&(n=(0,a.__)("No compatible model","wp-banana"));const r=Ce,i=me>0?(0,a.sprintf)((0,a._n)("%d reference","%d references",me,"wp-banana"),me):"";return{aspect:e,model:n,provider:r,references:i,fallback:e||n||r||i?"":(0,a.__)("Using provider defaults","wp-banana")}},[ge,F,E,M,Ce,je,fe,he,me]);(0,t.useEffect)(()=>{y&&h.some(e=>e.slug===y)||w&&v(w)},[w,y,h]),(0,t.useEffect)(()=>{if(!y)return;const e=me>0?"edit":"generate";let t=!0;return I(!0),$(null),i()({path:`${r}/models?provider=${y}&purpose=${e}`}).then(e=>{if(!t)return;const n=e,a=Array.isArray(n.models)?n.models:[];if(C(a),0===a.length)return void S("");const r=(me>0?[je?.default_model]:[d,je?.default_model]).find(e=>!!e&&a.includes(e));S(r||a[0])}).catch(e=>{var n;t&&(C([]),S(""),$(null!==(n=e?.message)&&void 0!==n?n:(0,a.__)("Failed to load models.","wp-banana")))}).finally(()=>{t&&I(!1)}),()=>{t=!1}},[y,r,je,d,me]),(0,t.useEffect)(()=>{M||(0!==he.length?he.includes(E)||S(he[0]):fe&&""!==E&&S(""))},[he,E,M,fe]);const ke=(0,t.useMemo)(()=>he.length>0?""!==E&&he.includes(E):!fe&&(""!==E||0===j.length),[he,E,fe,j]),Se=(0,t.useMemo)(()=>!(O||M||_.trim().length<3||""===y||!ke||ge&&""===F),[O,M,_,y,ke,ge,F]),Ne=(0,n.useCallback)(()=>{Y.current&&Y.current.click()},[]),Ae=(0,n.useCallback)(e=>{if(!Array.isArray(e)||0===e.length)return;const t=Array.isArray(V.current)?V.current:[];let n=Math.max(0,4-t.length),r=0,i=0;const s=[];if(e.forEach(e=>{if(!e?.type||!e.type.startsWith("image/"))return;if(i+=1,n<=0)return;const t=`${Date.now()}-${Math.random().toString(36).slice(2)}`,a=window.URL.createObjectURL(e);s.push({id:t,file:e,url:a,revokeOnCleanup:!0,filename:e.name,mimeType:e.type}),n-=1,r+=1}),r>0){const e=[...t,...s];V.current=e,W(e),T(null),J(i>r?(0,a.__)("You can upload up to 4 reference images.","wp-banana"):null)}else i>0&&J((0,a.__)("You can upload up to 4 reference images.","wp-banana"))},[W,T,J]),Le=(0,n.useCallback)(e=>{const t=e.target.files;t&&t.length>0&&Ae(Array.from(t)),e.target.value=""},[Ae]),Re=(0,n.useCallback)(e=>{const t=H.filter(t=>t.id!==e||(t.revokeOnCleanup&&t.url&&window.URL.revokeObjectURL(t.url),!1));W(t),J(null)},[H]),Me=(0,n.useCallback)(async()=>{const e=Array.isArray(V.current)?[...V.current]:[],t=[];let n=!1;for(let r=0;r<e.length;r+=1){const i=e[r];if(i.file instanceof File){t.push(i.file);continue}if(!i.sourceUrl)throw new Error((0,a.__)("Could not load the selected images.","wp-banana"));let s;try{s=await window.fetch(i.sourceUrl,{credentials:"same-origin"})}catch(e){throw new Error((0,a.__)("Could not load the selected images.","wp-banana"))}if(!s.ok)throw new Error((0,a.__)("Could not load the selected images.","wp-banana"));const o=await s.blob(),l=o.type||i.mimeType||"image/png",d=A(i.filename,r+1,l),c=new File([o],d,{type:l});e[r]={...i,file:c,mimeType:l},t.push(c),n=!0}return n&&W(e),V.current=e,t},[W]),Ie=(0,n.useCallback)(async(e,t)=>{if(me>0){let n=[];try{n=await Me()}catch(e){throw J((0,a.__)("Could not load the selected images.","wp-banana")),e}const s=new window.FormData;return s.append("prompt",e),s.append("provider",y),E&&s.append("model",E),t&&s.append("preview_only","1"),n.forEach(e=>{s.append("reference_images[]",e,e.name)}),i()({path:`${r}/generate`,method:"POST",body:s})}const n={prompt:e,provider:y};return E&&(n.model=E),ge&&F&&(n.aspect_ratio=F),t&&(n.preview_only="1"),i()({path:`${r}/generate`,method:"POST",data:n})},[me,Me,J,y,E,r,ge,F]);(0,t.useEffect)(()=>{if(!m)return;const e=e=>{const t=e.dataTransfer?.types;return!!t&&Array.from(t).includes("Files")},t=t=>{e(t)&&(t.preventDefault(),t.stopPropagation(),X.current+=1,Q(!0))},n=t=>{e(t)&&(t.preventDefault(),t.stopPropagation(),t.dataTransfer&&(t.dataTransfer.dropEffect="copy"),Q(!0))},a=()=>{X.current=0,Q(!1)},r=t=>{e(t)&&(t.preventDefault(),t.stopPropagation(),X.current=Math.max(0,X.current-1),0===X.current&&Q(!1))},i=t=>{if(!e(t))return;t.preventDefault(),t.stopPropagation();const n=t.dataTransfer,r=n?Array.from(n.files||[]):[];if(r.length>0&&Ae(r),n)try{n.clearData()}catch(e){}a()},s=t=>{e(t)&&a()};return window.addEventListener("dragenter",t),window.addEventListener("dragover",n),window.addEventListener("dragleave",r),window.addEventListener("drop",i),window.addEventListener("dragend",s),()=>{window.removeEventListener("dragenter",t),window.removeEventListener("dragover",n),window.removeEventListener("dragleave",r),window.removeEventListener("drop",i),window.removeEventListener("dragend",s),X.current=0,Q(!1)}},[Ae,m]),(0,t.useEffect)(()=>()=>{ce.current=!0,ue()},[ue]);const De=async()=>{const e=_.trim();if(e.length<3)T((0,a.__)("Please enter a longer prompt.","wp-banana"));else if(fe&&0===he.length)T((0,a.__)("Choose a model that supports multiple reference images.","wp-banana"));else{T(null),J(null),B(!0);try{await Ie(e,!1),x(""),ge&&U(b),G(!1),_e(),l()}catch(e){const t=e;t?.message?T(t.message):e instanceof Error&&e.message?T(e.message):T((0,a.__)("Failed to generate image.","wp-banana"))}finally{B(!1)}}},$e=(0,n.useCallback)(()=>{ce.current=!0,ue(),ne([]),le.current=[],re(null),se(null),pe.current={successes:0,errors:[]},O&&B(!1)},[ue,O]),Pe=(0,n.useCallback)(e=>{0===e.length&&$e()},[$e]),Te=(0,n.useCallback)(e=>{var t;const n=Math.max(1,Math.min(4,e)),r=_.trim();if(r.length<3)return void T((0,a.__)("Please enter a longer prompt.","wp-banana"));if(fe&&0===he.length)return void T((0,a.__)("Choose a model that supports multiple reference images.","wp-banana"));ce.current=!1,ue(),T(null),J(null),se(null),pe.current={successes:0,errors:[]};const i=Date.now(),s=Array.from({length:n}).map((e,t)=>({id:`${i}-${t}-${Math.random().toString(36).slice(2,10)}`,index:t,status:"queued"}));ne(s),re(null!==(t=s[0]?.id)&&void 0!==t?t:null),B(!0),ee(!1);const o=r,l=s.map((e,t)=>new Promise(n=>{const r=window.setTimeout(async()=>{if(ce.current)n();else{ne(t=>t.map(t=>t.id===e.id?{...t,status:"loading"}:t));try{var t,r,i,s,l,d,c;const p=await Ie(o,!0);if(ce.current)return void n();const u=p?.preview,m=null!==(t=p?.context)&&void 0!==t?t:{};if(!u?.data)throw new Error((0,a.__)("Failed to generate image.","wp-banana"));const f={provider:null!==(r=m.provider)&&void 0!==r?r:y,model:m.model,format:null!==(i=m.format)&&void 0!==i?i:L(u.mime),prompt:null!==(s=m.prompt)&&void 0!==s?s:o,filenameBase:null!==(l=null!==(d=m.filename_base)&&void 0!==d?d:m.filenameBase)&&void 0!==l?l:"",title:null!==(c=m.title)&&void 0!==c?c:""};ne(t=>t.map(t=>{var n,a;return t.id===e.id?{...t,status:"complete",data:null!==(n=u.data)&&void 0!==n?n:"",mime:null!==(a=u.mime)&&void 0!==a?a:"image/png",width:u.width,height:u.height,bytes:u.bytes,context:f,error:void 0}:t})),pe.current.successes+=1,re(t=>null!=t?t:e.id)}catch(t){var p;if(ce.current)return void n();const r=t,i=null!==(p=r?.message)&&void 0!==p?p:(0,a.__)("Failed to generate image.","wp-banana");pe.current.errors.push(i),ne(t=>t.map(t=>t.id===e.id?{...t,status:"error",error:i}:t)),se({message:i,type:"error"})}finally{n()}}},1e3*t);de.current.push(r)}));Promise.all(l).then(()=>{ue(),ce.current||(pe.current.successes>0?(x(""),ge&&U(b),_e(),G(!1)):($e(),pe.current.errors.length>0&&T(pe.current.errors[0])),B(!1))})},[_,T,fe,he,ue,Ie,ge,b,_e,G,J,y,$e]),Oe=(0,n.useCallback)(e=>{ee(!1),O||Te(e)},[Te,O]),Be=(0,n.useCallback)(async e=>{const t=le.current.find(t=>t.id===e);if(t&&("complete"===t.status||"error"===t.status)&&t.data&&t.context){se(null),ne(t=>t.map(t=>t.id===e?{...t,status:"saving",error:void 0}:t));try{var n;const s=await i()({path:`${r}/generate/save-preview`,method:"POST",data:{data:t.data,provider:t.context.provider,model:null!==(n=t.context.model)&&void 0!==n?n:"",format:t.context.format,mime:t.mime,prompt:t.context.prompt,filename_base:t.context.filenameBase,title:t.context.title}});ne(t=>{const n=t.map(t=>t.id===e?{...t,status:"saved",attachmentId:s?.attachment_id,url:s?.url,error:void 0}:t);return Pe(n),n}),se({message:(0,a.__)("Image saved to Media Library.","wp-banana"),type:"success"})}catch(t){var s;const n=t,r=null!==(s=n?.message)&&void 0!==s?s:(0,a.__)("Failed to save image.","wp-banana");ne(t=>t.map(t=>t.id===e?{...t,status:"error",error:r}:t)),se({message:r,type:"error"})}}},[r,Pe]),Fe=(0,n.useCallback)(e=>{const t=Array.isArray(le.current)?le.current:[],n=t.find(t=>t.id===e)||null,r=t.filter(t=>t.id!==e);if(ne(r),le.current=r,0===r.length?re(null):ae===e&&re(r[0].id),Pe(r),n){const e={...n,status:"complete"};se({message:(0,a.__)("Deleted.","wp-banana"),type:"warning",undo:e})}else se({message:(0,a.__)("Deleted.","wp-banana"),type:"warning"})},[ae,Pe]),Ue=(0,n.useCallback)(()=>{const e=ie?.undo;e&&(ne(t=>{if(t.some(t=>t.id===e.id))return t;const n=[e,...t];return n.sort((e,t)=>e.index-t.index),n}),re(e.id),se(null))},[ie]),qe=(0,n.useCallback)(e=>{"Enter"===e.key&&(e.metaKey||e.ctrlKey)&&(e.preventDefault(),Se&&!O&&De())},[Se,O,De]),Ge=m&&K;return(0,o.jsxs)(o.Fragment,{children:[m&&(0,o.jsx)("div",{className:"uploader-window wp-banana-generate-page__drop-overlay",style:{display:Ge?"block":"none",opacity:Ge?1:0},"aria-hidden":"true",children:(0,o.jsx)("div",{className:"uploader-window-content",children:(0,o.jsx)("div",{className:"uploader-editor-title",children:(0,a.__)("Drop files to attach","wp-banana")})})}),(0,o.jsx)(s.Card,{children:(0,o.jsxs)(s.CardBody,{children:[D&&(0,o.jsx)(s.Notice,{status:"error",isDismissible:!1,children:D}),P&&(0,o.jsx)(s.Notice,{status:"error",isDismissible:!1,children:P}),z&&(0,o.jsx)(s.Notice,{status:"warning",isDismissible:!1,children:z}),fe&&!M&&0===he.length&&(0,o.jsx)(s.Notice,{status:"warning",isDismissible:!1,children:(0,a.__)("Switch to a supported model to send multiple reference images.","wp-banana")}),(0,o.jsxs)("div",{className:"wp-banana-generate-panel__prompt",style:{position:"relative",marginBottom:"8px"},children:[(0,o.jsx)(s.TextareaControl,{label:(0,a.__)("Describe the image","wp-banana"),value:_,onChange:x,onKeyDown:qe,rows:5,placeholder:(0,a.__)("A cat surfing a wave at sunset…","wp-banana"),disabled:O}),(0,o.jsx)("button",{type:"button",className:"button button-secondary button-small wp-banana-generate-panel__reference-picker",onClick:Ne,disabled:O,"aria-label":(0,a.__)("Add reference images","wp-banana"),style:{position:"absolute",top:"24px",right:"0",lineHeight:"20px",padding:"0 4px",border:"none",borderRadius:0,background:"transparent"},children:(0,o.jsx)("span",{className:"dashicons dashicons-paperclip","aria-hidden":"true"})}),(0,o.jsx)("input",{ref:Y,type:"file",accept:"image/png,image/jpeg,image/webp",multiple:!0,onChange:Le,style:{display:"none"}})]}),H.length>0&&(0,o.jsx)("div",{className:"wp-banana-generate-panel__reference-list",style:{display:"flex",gap:"8px",marginBottom:"16px",flexWrap:"wrap"},children:H.map(e=>(0,o.jsxs)("div",{style:{position:"relative",width:"72px",height:"72px",overflow:"hidden",borderRadius:"4px",border:"1px solid #dcdcde"},children:[(0,o.jsx)("img",{src:e.url,alt:"",style:{width:"100%",height:"100%",objectFit:"cover"}}),(0,o.jsx)("button",{type:"button",className:"button-link wp-banana-generate-panel__reference-remove",onClick:()=>Re(e.id),"aria-label":(0,a.__)("Remove reference image","wp-banana"),style:{position:"absolute",top:"2px",right:"2px",display:"inline-flex",alignItems:"center",justifyContent:"center",width:"22px",height:"22px",background:"rgba(0,0,0,0.55)",color:"#fff",borderRadius:"3px",textDecoration:"none"},children:(0,o.jsx)("span",{className:"dashicons dashicons-no"})})]},e.id))}),q&&h.length>1&&(0,o.jsx)(s.SelectControl,{label:(0,a.__)("Provider","wp-banana"),value:y,onChange:e=>v(e),options:h.map(e=>({label:e.label,value:e.slug})),disabled:O}),q&&(0,o.jsx)(s.SelectControl,{label:(0,a.__)("Model","wp-banana"),value:E,onChange:e=>S(e),disabled:M||0===he.length||O,options:he.length>0?he.map(e=>({label:e,value:e})):[{label:(0,a.__)("No models available","wp-banana"),value:""}]}),q&&ge&&(0,o.jsx)(s.SelectControl,{label:(0,a.__)("Aspect ratio","wp-banana"),value:F,onChange:e=>U(e),disabled:O,options:g.map(e=>({label:e,value:e}))}),M&&(0,o.jsxs)("div",{className:"wp-banana-generate-panel__spinner",style:{display:"flex",alignItems:"center",gap:"8px"},children:[(0,o.jsx)(s.Spinner,{})," ",(0,a.__)("Loading models…","wp-banana")]}),(0,o.jsxs)("div",{className:"wp-banana-generate-panel__actions",style:{marginTop:"16px",display:"flex",flexWrap:"wrap",alignItems:"center",gap:"12px",justifyContent:"space-between"},children:[(0,o.jsxs)("div",{ref:oe,style:{display:"flex",alignItems:"center",gap:"12px",position:"relative",zIndex:1e3},children:[(0,o.jsxs)("div",{className:"button-group",children:[(0,o.jsx)("button",{type:"button",className:"button button-primary wp-banana-generate-panel__submit",onClick:De,disabled:!Se||O,title:(0,a.__)("Generate one image and save to Media Library","wp-banana"),children:(0,a.__)("Generate Image","wp-banana")}),(0,o.jsx)("button",{type:"button",className:"button button-primary",onClick:()=>{O||ee(e=>!e)},disabled:O||!Se,"aria-haspopup":"menu","aria-expanded":Z,"aria-label":(0,a.__)("Generate multiple variations","wp-banana"),style:{padding:"0 4px"},title:(0,a.__)("Generate multiple variations and preview before saving","wp-banana"),children:(0,o.jsx)("span",{className:"dashicons dashicons-arrow-down-alt2","aria-hidden":"true",style:{lineHeight:"30px"}})})]}),O&&(0,o.jsx)("span",{className:"spinner is-active","aria-hidden":"true"}),Z&&(0,o.jsxs)("div",{className:"wp-banana-generate-panel__variation-menu",role:"menu",style:{position:"absolute",top:"100%",right:0,marginTop:"4px",background:"#fff",border:"1px solid #dcdcde",borderRadius:"4px",boxShadow:"0 4px 12px rgba(0,0,0,0.15)",zIndex:10,minWidth:"180px",padding:"4px 0"},children:[N.map(e=>(0,o.jsxs)("button",{type:"button",role:"menuitem",className:"button button-link",style:{display:"flex",width:"100%",justifyContent:"space-between",alignItems:"center",padding:"6px 12px",boxSizing:"border-box",textDecoration:"none"},onClick:()=>Oe(e),children:[(0,o.jsx)("span",{children:(0,a.sprintf)((0,a._n)("%d image","%d images",e,"wp-banana"),e)}),1===e&&(0,o.jsx)("span",{className:"dashicons dashicons-format-image","aria-hidden":"true"}),e>1&&(0,o.jsx)("span",{className:"dashicons dashicons-images-alt2","aria-hidden":"true"})]},e)),(0,o.jsx)("span",{style:{display:"block",padding:"4px 12px 2px",fontSize:"11px",fontWeight:"400",color:"#555d66",borderTop:"1px solid #e1e1e1"},children:(0,a.__)("Generate and Preview Images","wp-banana")})]})]}),(0,o.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"8px",flexWrap:"wrap",textAlign:"right"},children:[Ee.fallback?(0,o.jsx)("span",{children:Ee.fallback}):(0,o.jsxs)("span",{children:[Ee.aspect&&(0,o.jsxs)("span",{children:[Ee.aspect," — "]}),(0,o.jsx)("code",{children:Ee.model}),Ee.provider&&(0,o.jsxs)("span",{children:[" (",Ee.provider,")"]}),Ee.references&&(0,o.jsxs)("span",{children:[" - ",Ee.references]})]}),(0,o.jsx)("button",{type:"button",className:"button-link",onClick:()=>G(!q),children:q?(0,a.__)("Hide options","wp-banana"):(0,a.__)("Change","wp-banana")})]})]}),te.length>0&&(0,o.jsxs)("div",{className:"wp-banana-generate-panel__variations",style:{marginTop:"24px",borderTop:"1px solid #dcdcde",paddingTop:"16px"},children:[(0,o.jsxs)("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:"12px",gap:"12px"},children:[(0,o.jsx)("h3",{style:{margin:0},children:(0,a.__)("Generated Variations","wp-banana")}),(0,o.jsx)(s.Button,{variant:"secondary",onClick:$e,children:(0,a.__)("Clear previews","wp-banana")})]}),ie&&"success"!==ie.type&&(0,o.jsx)(s.Notice,{status:"warning"===ie.type?"warning":"error",isDismissible:!1,style:{marginBottom:"16px"},children:(0,o.jsxs)("div",{className:"wp-banana-generate-variations-notice",style:{display:"flex",alignItems:"center",gap:"8px",flexWrap:"wrap"},children:[(0,o.jsx)("span",{children:ie.message}),ie.undo?(0,o.jsx)(s.Button,{variant:"link",onClick:Ue,children:(0,a.__)("Undo","wp-banana")}):null]})}),(0,o.jsxs)("div",{className:"wp-banana-generate-variations-layout",style:{display:"flex",gap:"16px",flexWrap:"wrap"},children:[(0,o.jsx)("div",{className:"wp-banana-generate-variations-list",style:{width:"200px",maxHeight:"360px",overflowY:"auto",display:"flex",flexDirection:"column",gap:"8px"},children:te.map(e=>{const t=e.id===be?.id,n=e.data&&e.mime?`data:${e.mime};base64,${e.data}`:"";return(0,o.jsxs)("button",{type:"button",onClick:()=>re(e.id),className:"button button-link",style:{display:"flex",flexDirection:"column",alignItems:"stretch",gap:"6px",padding:"6px",border:t?"2px solid #007cba":"1px solid #dcdcde",borderRadius:"4px",background:t?"#f0f6fc":"#fff",textAlign:"left"},children:[(0,o.jsxs)("div",{style:{position:"relative",height:"64px",background:"#f6f7f7",display:"flex",alignItems:"center",justifyContent:"center",overflow:"hidden",borderRadius:"3px"},children:["complete"===e.status||"saved"===e.status||"error"===e.status?n?(0,o.jsx)("img",{src:n,alt:"",style:{width:"100%",height:"100%",objectFit:"cover"}}):(0,o.jsx)("span",{children:(0,a.__)("Preview unavailable","wp-banana")}):(0,o.jsx)(s.Spinner,{}),"saved"===e.status&&(0,o.jsx)("span",{style:{position:"absolute",top:"4px",right:"4px",background:"#007cba",color:"#fff",padding:"2px 6px",borderRadius:"3px",fontSize:"11px",fontWeight:600},children:(0,a.__)("Saved","wp-banana")})]}),(0,o.jsxs)("div",{style:{display:"flex",flexDirection:"column",gap:"2px"},children:[(0,o.jsx)("strong",{children:(0,a.sprintf)((0,a.__)("Variation %d","wp-banana"),e.index+1)}),(0,o.jsx)("span",{style:{fontSize:"12px",color:"#555"},children:R(e.status)})]})]},e.id)})}),(0,o.jsxs)("div",{className:"wp-banana-generate-variations-preview",style:{flex:1,minWidth:"260px",display:"flex",flexDirection:"column",gap:"16px"},children:[(0,o.jsx)("div",{style:{position:"relative",background:"#f6f7f7",border:"1px solid #dcdcde",borderRadius:"4px",minHeight:"300px",display:"flex",alignItems:"center",justifyContent:"center",padding:"12px"},children:be?"loading"===be.status||"queued"===be.status?(0,o.jsx)(s.Spinner,{}):"error"===be.status?(0,o.jsx)(s.Notice,{status:"error",isDismissible:!1,children:null!==(f=be.error)&&void 0!==f?f:(0,a.__)("Failed to generate image.","wp-banana")}):(0,o.jsxs)(o.Fragment,{children:[we?(0,o.jsx)("img",{src:we,alt:"",style:{maxWidth:"100%",maxHeight:"360px",borderRadius:"4px",objectFit:"contain"}}):(0,o.jsx)("span",{children:(0,a.__)("Preview unavailable","wp-banana")}),"saving"===be.status&&(0,o.jsxs)("div",{style:{position:"absolute",inset:0,background:"rgba(255,255,255,0.7)",display:"flex",alignItems:"center",justifyContent:"center",gap:"8px"},children:[(0,o.jsx)(s.Spinner,{})," ",(0,a.__)("Saving…","wp-banana")]})]}):(0,o.jsx)("span",{children:(0,a.__)("No preview selected.","wp-banana")})}),(0,o.jsxs)("div",{style:{display:"flex",gap:"8px"},children:[(0,o.jsx)(s.Button,{isPrimary:!0,onClick:be?()=>Be(be.id):void 0,disabled:!ye||"saving"===be?.status,children:(0,a.__)("Save","wp-banana")}),(0,o.jsx)(s.Button,{variant:"secondary",onClick:be?()=>Fe(be.id):void 0,disabled:!ve||"saving"===be?.status,children:(0,a.__)("Discard","wp-banana")})]})]})]})]})]})})]})},I=new WeakMap,D=(e,n)=>{if(e.querySelector(".media-menu-item.wp-banana-media-tab"))return;let r=null;const i=e.querySelector(".media-router"),s=e.querySelector(".media-frame-content");if(!i||!s)return;const l=`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`,d=`wp-banana-generate-tab-${l}`,c=`wp-banana-generate-panel-${l}`,p=document.createElement("button");p.type="button",p.id=d,p.className="media-menu-item wp-banana-media-tab",p.textContent=(0,a.__)("Generate Image","wp-banana"),p.setAttribute("role","tab"),p.setAttribute("aria-selected","false"),p.setAttribute("aria-controls",c),p.dataset.wpBanana="1",i.appendChild(p);const u=()=>{const e=document.createElement("div");return e.className="wp-banana-media-panel",e.id=c,e.setAttribute("role","tabpanel"),e.setAttribute("aria-labelledby",d),e.setAttribute("hidden","hidden"),e.setAttribute("aria-hidden","true"),e.style.display="none",s.appendChild(e),e};r=u();let m=!1;const f=()=>{e.classList.remove("wp-banana-media-tab-active"),p.classList.remove("active"),p.setAttribute("aria-selected","false"),r&&r.isConnected&&(r.setAttribute("hidden","hidden"),r.setAttribute("aria-hidden","true"),r.style.display="none")};i.addEventListener("click",a=>{const s=a.target,l=s?.closest(".media-menu-item");if(l)return l===p?(a.preventDefault(),a.stopPropagation(),a.stopImmediatePropagation(),void(()=>{r&&r.isConnected||(r&&I.delete(r),r=u(),m=!1),m||(((e,n,a)=>{const r=window,i=r.wp?.element;if("function"==typeof i?.createRoot){let t=I.get(e);return t||(t=i.createRoot(e),I.set(e,t)),void t.render((0,o.jsx)(M,{providers:n.providers,restNamespace:n.restNamespace,onComplete:a,defaultGeneratorModel:n.defaultGeneratorModel,defaultGeneratorProvider:n.defaultGeneratorProvider,defaultAspectRatio:n.defaultAspectRatio,aspectRatioOptions:n.aspectRatioOptions}))}(0,t.render)((0,o.jsx)(M,{providers:n.providers,restNamespace:n.restNamespace,onComplete:a,defaultGeneratorModel:n.defaultGeneratorModel,defaultGeneratorProvider:n.defaultGeneratorProvider,defaultAspectRatio:n.defaultAspectRatio,aspectRatioOptions:n.aspectRatioOptions}),e)})(r,n,()=>{(()=>{const e=window,t=e.wp?.media,n=t?.frame;if(!n)return;const a=[],r="function"==typeof n.state?n.state():null,i=r&&"function"==typeof r.get?r.get("library"):null;i&&a.push(i),n.library&&a.push(n.library);const s="function"==typeof n.content?.get?n.content.get():null;s?.collection&&a.push(s.collection),a.forEach(e=>{if(!e)return;"function"==typeof e.props?.set&&e.props.set({ignore:Date.now()});const t=(()=>{if("function"==typeof e.url)try{return e.url()}catch(e){return""}return e.url})();"string"==typeof t&&t.length>0&&("function"!=typeof e.more?"function"==typeof e.fetch&&e.fetch():e.more())}),"function"==typeof n.trigger&&n.trigger("library:refresh")})(),(()=>{const e=i.querySelector("#menu-item-browse")||i.querySelector('.media-menu-item[data-router="browse"]')||i.querySelector('.media-menu-item[data-router="library"]')||i.querySelector(".media-menu-item:not(.wp-banana-media-tab)");e&&e!==p?(f(),"function"==typeof e.click&&e.click()):f()})()}),m=!0),r.removeAttribute("hidden"),r.removeAttribute("aria-hidden"),r.style.display="block",i.querySelectorAll(".media-menu-item").forEach(e=>{const t=e===p;e.classList.toggle("active",t),e.setAttribute("aria-selected",t?"true":"false")}),e.classList.add("wp-banana-media-tab-active");const a=r.querySelector("textarea");a&&setTimeout(()=>a.focus(),50)})()):void f()});const h=e.querySelector(".media-modal-close");h&&h.addEventListener("click",f);const g=e.nextElementSibling;g&&g.classList.contains("media-modal-backdrop")&&g.addEventListener("click",f),new MutationObserver(()=>{("none"===e.style.display||"true"===e.getAttribute("aria-hidden"))&&f()}).observe(e,{attributes:!0,attributeFilter:["style","class","aria-hidden"]}),f()},$=()=>{const e=(()=>{const e=window.wpBananaMedia;if(!e||!Array.isArray(e.providers))return null;const t=e.providers.filter(e=>!1!==e.connected);return 0===t.length?null:{restNamespace:e.restNamespace,providers:t,defaultGeneratorModel:e.defaultGeneratorModel,defaultGeneratorProvider:e.defaultGeneratorProvider,defaultAspectRatio:e.defaultAspectRatio,aspectRatioOptions:e.aspectRatioOptions}})();if(!e)return;const t=t=>D(t,e);document.querySelectorAll(".media-modal").forEach(t),new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.forEach(e=>{e instanceof HTMLElement&&(e.matches(".media-modal")?t(e):e.querySelectorAll(".media-modal").forEach(e=>{t(e)}))})})}).observe(document.body,{childList:!0,subtree:!0})};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",$):$()})();